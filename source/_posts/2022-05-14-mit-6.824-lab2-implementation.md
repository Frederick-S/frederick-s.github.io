title: "MIT 6.824 - Lab 2 (3): 实现"
tags:
- MIT 6.824
- Go
- Raft
- Distributed Systems
---

## 准备工作
[Debugging by Pretty Printing](https://blog.josejg.com/debugging-pretty/) 中介绍了如何高效的打印日志，这有助于在实验时进行问题排查。

首先在 `Go` 侧需要封装一个日志打印函数 `PrettyDebug`（`raft` 目录下已经有了 `Debug` 变量，所以这里重命名为 `PrettyDebug`），在 `raft` 目录下新建一个 `Go` 文件，复制以下内容：

```go
package raft

import (
	"fmt"
	"log"
	"os"
	"strconv"
	"time"
)

// Retrieve the verbosity level from an environment variable
func getVerbosity() int {
	v := os.Getenv("VERBOSE")
	level := 0
	if v != "" {
		var err error
		level, err = strconv.Atoi(v)
		if err != nil {
			log.Fatalf("Invalid verbosity %v", v)
		}
	}
	return level
}

type logTopic string

const (
	dClient    logTopic = "CLNT"
	dCommit    logTopic = "CMIT"
	dDrop      logTopic = "DROP"
	dError     logTopic = "ERRO"
	dInfo      logTopic = "INFO"
	dLeader    logTopic = "LEAD"
	dCandidate logTopic = "CAND"
	dLog       logTopic = "LOG1"
	dLog2      logTopic = "LOG2"
	dPersist   logTopic = "PERS"
	dSnap      logTopic = "SNAP"
	dTerm      logTopic = "TERM"
	dTest      logTopic = "TEST"
	dTimer     logTopic = "TIMR"
	dTrace     logTopic = "TRCE"
	dVote      logTopic = "VOTE"
	dWarn      logTopic = "WARN"
)

var debugStart time.Time
var debugVerbosity int

func init() {
	debugVerbosity = getVerbosity()
	debugStart = time.Now()

	log.SetFlags(log.Flags() &^ (log.Ldate | log.Ltime))
}

func PrettyDebug(topic logTopic, format string, a ...interface{}) {
	if debugVerbosity >= 1 {
		t := time.Since(debugStart).Microseconds()
		t /= 100
		prefix := fmt.Sprintf("%06d %v ", t, string(topic))
		format = prefix + format
		log.Printf(format, a...)
	}
}
```

`PrettyDebug` 会通过环境变量 `VERBOSE` 来决定是否打印日志，该方法接受三个参数，第一个是日志主题用于对日志分组，后两个参数则是传递给 `log.Printf` 进行格式化打印，使用方法如下：

```go
PrettyDebug(dTimer, "S%d, apply log, log index=%v, log term=%v, log command=%v", rf.me, entry.Index, entry.Term, entry.Command)
```

日志信息中的 `S%d` 是关键，它表示当前节点的编号，如 `S0`，`S1`，按照这个模式打印日志，在后续日志处理时能将日志按照节点分组。

## 参考

* [6.824 Lab 2: Raft](https://pdos.csail.mit.edu/6.824/labs/lab-raft.html)
* [Debugging by Pretty Printing](https://blog.josejg.com/debugging-pretty/)