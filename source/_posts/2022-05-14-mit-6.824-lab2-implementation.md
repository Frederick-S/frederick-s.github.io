title: "MIT 6.824 - Lab 2 (3): 实现"
tags:
- MIT 6.824
- Go
- Raft
- Distributed Systems
---

## 准备工作
### 日志
[Debugging by Pretty Printing](https://blog.josejg.com/debugging-pretty/) 中介绍了如何高效的打印日志，这有助于在实验时进行问题排查。

首先在 `Go` 侧需要封装一个日志打印函数 `PrettyDebug`（`raft` 目录下已经有了 `Debug` 变量，所以这里重命名为 `PrettyDebug`），在 `raft` 目录下新建一个 `Go` 文件，复制以下内容：

```go
package raft

import (
	"fmt"
	"log"
	"os"
	"strconv"
	"time"
)

// Retrieve the verbosity level from an environment variable
func getVerbosity() int {
	v := os.Getenv("VERBOSE")
	level := 0
	if v != "" {
		var err error
		level, err = strconv.Atoi(v)
		if err != nil {
			log.Fatalf("Invalid verbosity %v", v)
		}
	}
	return level
}

type logTopic string

const (
	dClient    logTopic = "CLNT"
	dCommit    logTopic = "CMIT"
	dDrop      logTopic = "DROP"
	dError     logTopic = "ERRO"
	dInfo      logTopic = "INFO"
	dLeader    logTopic = "LEAD"
	dCandidate logTopic = "CAND"
	dLog       logTopic = "LOG1"
	dLog2      logTopic = "LOG2"
	dPersist   logTopic = "PERS"
	dSnap      logTopic = "SNAP"
	dTerm      logTopic = "TERM"
	dTest      logTopic = "TEST"
	dTimer     logTopic = "TIMR"
	dTrace     logTopic = "TRCE"
	dVote      logTopic = "VOTE"
	dWarn      logTopic = "WARN"
)

var debugStart time.Time
var debugVerbosity int

func init() {
	debugVerbosity = getVerbosity()
	debugStart = time.Now()

	log.SetFlags(log.Flags() &^ (log.Ldate | log.Ltime))
}

func PrettyDebug(topic logTopic, format string, a ...interface{}) {
	if debugVerbosity >= 1 {
		t := time.Since(debugStart).Microseconds()
		t /= 100
		prefix := fmt.Sprintf("%06d %v ", t, string(topic))
		format = prefix + format
		log.Printf(format, a...)
	}
}
```

`PrettyDebug` 会通过环境变量 `VERBOSE` 来决定是否打印日志，该方法接受三个参数，第一个是日志主题用于对日志分组，后两个参数则是传递给 `log.Printf` 进行格式化打印，使用方法如下：

```go
PrettyDebug(dTimer, "S%d, apply log, log index=%v, log term=%v, log command=%v", rf.me, entry.Index, entry.Term, entry.Command)
```

日志信息中的 `S%d` 是关键，它表示当前节点的编号，如 `S0`，`S1`，按照这个模式打印日志，在后续日志处理时能将日志按照节点分组。

然后，就可以通过 `VERBOSE=1 go test -run TestFigure82C` 来进行测试（这里的 `TestFigure82C` 可以换成其他的测试用例）：

![alt](/images/raft-lab-1.png)

不过所有日志都混到了一起，不好区分，作者因此提供了一个 `Python` 脚本 [dslogs](https://gist.github.com/JJGO/e64c0e8aedb5d464b5f79d3b12197338) 来美化日志。这个脚本用到了 `typer` 和 `rich` 两个库，可以通过 `pip` 全局安装。接着再执行测试 `VERBOSE=1 go test -run TestFigure82C | pipenv run python dslogs.py`（这里使用了 `pipenv` 来安装依赖，没有用到 `pipenv` 的可以按照作者的方式执行），美化后的日志根据主题着色后有了更强的区分度：

![alt](/images/raft-lab-2.png)

更进一步，还可以将日志按照节点分组展示 `VERBOSE=1 go test -run TestFigure82C | pipenv run python dslogs.py -c 3`：

![alt](/images/raft-lab-3.png)

在上图中，每一列表示一个节点的日志，而且自上而下随时间排序。

### 批量测试
做实验时有时候测试用例成功了，有时候失败了，每次手动测试不方便抓取日志，[Debugging by Pretty Printing](https://blog.josejg.com/debugging-pretty/) 的作者提供了另一个脚本 [dstest](https://gist.github.com/JJGO/0d73540ef7cc2f066cb535156b7cbdab) 来进行批量测试，并且当测试失败时自动保存日志到文件中，从而可以使用上面提到的脚本 `dslogs` 来处理，`dstest` 这个脚本也依赖 `typer` 和 `rich` 两个库。

然后通过 `pipenv run python dstest.py 2A -n 10 -v 1` 进行批量测试，这里 `2A` 可以换成其他的测试用例，`-n 10` 表示测试多少次，默认是10，`-v 1` 表示设置环境变量 `VERBOSE`，这样就能告诉 `Go` 打印日志：

![alt](/images/raft-lab-4.png)

![alt](/images/raft-lab-5.png)

## 参考

* [6.824 Lab 2: Raft](https://pdos.csail.mit.edu/6.824/labs/lab-raft.html)
* [Debugging by Pretty Printing](https://blog.josejg.com/debugging-pretty/)