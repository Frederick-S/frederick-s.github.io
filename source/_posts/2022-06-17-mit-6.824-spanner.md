title: 'MIT 6.824 - Spanner: Google’s Globally-Distributed Database'
tags:
- MIT 6.824
- Paper
- Distributed Systems
- Spanner
---

## 介绍
`Spanner` 是一个由 `Google` 设计，构建和部署的可扩展的全球分布式数据库。从高层次的抽象来看，作为一个数据库，`Spanner` 将数据进行分片，每个分片构建在一组 `Paxos` 状态机之上，同时所有的数据存储在世界各地的各个数据中心内。`Spanner` 使用副本来保证数据库的全球可用性和客户端读取数据的就近访问性；客户端也能自动的在各个副本之间实现故障转移。当数据量或者服务器数量发生变化时，`Spanner` 能自动的跨服务器对数据进行重分区；同时，`Spanner` 也能自动的跨服务器（甚至是跨数据中心）迁移数据来达成负载均衡或者应对异常。`Spanner` 的扩展性能够支持上百个数据中心的几百万台服务器，以及几万亿的数据行。

应用程序可以借助 `Spanner` 来确保高可用，即使是面对大面积的自然灾害，也可以通过将数据存储在单个大洲或者跨大洲的多个数据中心来保证容错。`Spanner` 的第一个客户是 `F1`，`F1` 是 `Google` 广告后端的一个重构项目。`F1` 的每份数据在美国境内存有5个副本。大部分其他的应用程序一般会将数据备份在同一个地理区域内的3到5个数据中心中，不过这在应对极端灾害时容错性要略差一些。因为在能够容忍1到2个数据中心异常的情况下，大多数的应用程序相比于更进一步的高可用更看重低延迟。

`Spanner` 设计的首要关注点是管理跨数据中心的数据副本，不过设计者依然在 `Google` 已有的分布式系统设施之上花了大量的时间来设计和实现某些重要的数据库特性。虽然 `Bigtable` 能满足很多项目的需求，不过依然有很多 `Bigtable` 的用户反馈在某些场景下 `Bigtable` 难以胜任：例如涉及复杂、不断改变的数据库模式；或者要求大范围数据复制场景下保证强一致性。出于半关系型数据模型以及同步复制的特性，很多 `Google` 的应用选择使用 `Megastore` 来存储数据，尽管 `Megastore` 的写性能不是很好。因此，`Spanner` 从一个类似 `Bigtable` 的带版本号的键值存储演化为了一个基于时间戳的多版本数据库。`Spanner` 中的数据保存在半关系型的表中；每个数据存有多个版本，每个版本的数据都自动标记着提交时的时间戳；旧版本的数据可以根据可配置的垃圾回收策略进行回收；应用程序可以读取某个旧的时间戳下的数据。`Spanner` 支持通用的事务，以及提供了一个基于 `SQL` 的查询语言。

作为一个全球分布式数据库，`Spanner` 提供了几个有趣的特性。首先，应用程序能以合适的粒度动态的调控数据复制的配置。应用程序可以通过配置指定哪个数据中心保存什么样的数据，数据存储的位置距离终端用户有多远（控制读延迟），数据的各个副本间距离多远（控制写延迟），每个数据要保存几个副本（控制持久性，可用性和读性能）。同时，系统可以动态和透明的在各个数据中心间迁移数据，从而在各数据中心间实现资源的均衡使用。第二，`Spanner` 实现了两个在分布式数据库中难以实现的功能：提供了外部一致性的读和写，以及在某个时间戳上跨全球数据库的一致性读。这些特性使得 `Spanner` 能够在全球多数据中心级别支持一致性备份，一致性的 `MapReduce` 任务执行，以及原子性的数据库模式更新，即使执行这些操作时存在进行中的事务也没有关系。

## 参考
* [Spanner: Google’s Globally-Distributed Database](https://pdos.csail.mit.edu/6.824/papers/spanner.pdf)
* [Benefits of Cloud Spanner replication](https://cloud.google.com/spanner/docs/replication#benefits_of_cloud_spanner_replication)