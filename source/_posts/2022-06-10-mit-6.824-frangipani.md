title: 'MIT 6.824 - Frangipani: A Scalable Distributed File System'
tags:
- MIT 6.824
- Paper
- Distributed Systems
---

## 介绍
这是一篇上世纪九十年代的论文，在当时的环境下，安装新工作站的需求与日俱增，而针对大量工作站的文件系统管理却费时费力。为了保存更多的文件和服务更多的用户，就需要更多的磁盘，并挂载到更多的机器上。某一组文件经常会被手动分配给某些特定的磁盘，当磁盘空间不足，异常或者成为性能热点时，就需要手动移动或者复制文件到其他磁盘上。使用 `RAID` 技术管理多个磁盘只能解决部分问题；当系统增长到需要多个磁盘阵列和多台服务器时，系统管理问题也随之而来。

`Frangipani` 是一个可扩展的分布式文件系统，它能统一管理挂载在不同机器上的磁盘，对外来说，这些磁盘构成了一个独立的共享存储池。组成 `Frangipani` 的机器默认能够被统一管理而且相互间能安全的通信。在 `Frangipani` 之前已经有了一些分布式文件系统的实现，并且在吞吐和容量上有很好的扩展性。`Frangipani` 的一个显著特性是它的内部结构非常简单——各台协作的机器共同访问一个通用的存储，并使用锁来保证访问的同步性。这种简单的结构使得只需要少量的机器就能处理系统恢复，重配置和负载均衡。`Frangipani` 的另一个关键特性是相比于已知的分布式文件系统，它结合了一系列功能使得 `Frangipani` 更易于使用和管理：

1. 所有用户读取到的文件内容都相同。
2. 可以轻易的向 `Frangipani` 添加更多的服务器来增加存储容量和吞吐，而无需修改已有服务器的配置，或者中断其操作。这些服务器可以像积木一样根据需要搭建来构建更大的文件系统。
3. 系统管理员添加新用户时无需关心新用户的数据会由哪台服务器管理或者保存在哪个磁盘上。
4. 系统管理员可以对整个文件系统进行完整和一致的备份，而无需停止服务。备份可以在线进行，使得用户可以快速访问被意外删除的文件。
5. 文件系统可以在无需人工干预的情况下容忍机器、网络、磁盘异常并自行恢复。

`Frangipani` 构建于 `Petal` 之上，`Petal` 是一个易于管理的分布式存储系统，为客户端提供了虚拟磁盘。和物理磁盘一样，`Petal` 的虚拟磁盘也是以块（`block`）的方式来读取和写入存储。和物理磁盘不同的是，一个 `Petal` 虚拟磁盘提供了$2^{64}$字节的稀疏地址空间，并且只在需要的时候才会分配物理存储。`Petal` 也支持对数据备份来保证高可用。`Petal` 同时提供了高效的快照功能来支持一致性备份。`Frangipani` 从下层存储系统继承了扩展性，容错和易于管理的特性，不过将这些特性扩展到文件系统还需要些细致的设计。下一节将会详细描述 `Frangipani` 的结构以及和 `Petal` 的关系。

![alt](/images/frangipani-1.png)

上图展示了 `Frangipani` 的层级设计。多个可替换的 `Frangipani` 服务器运行于一个共享的 `Petal` 虚拟磁盘之上，不同的用户程序可以各自通过连接的 `Frangipani` 服务器来访问相同的文件，而各 `Frangipani` 服务器间通过分布式锁服务来保证数据的一致性。通过添加 `Frangipani` 服务器可以实现对文件系统层的扩展。`Frangipani` 通过异常服务器的自动恢复和借助依然存活的服务器提供服务来实现容错。相比于中心化的网络文件服务器，`Frangipani` 通过将负载分摊到正在使用文件的机器上来提供更好的负载均衡。出于扩展性，容错和负载均衡的考虑，`Petal` 和 `Frangipani` 用到的锁服务也是分布式的。

`Frangipani` 服务器默认信任 `Petal` 服务器和锁服务。`Frangipani` 在设计时的最佳使用场景是在同一个管理域下的工作站集群，虽然它也可以扩展到其他管理域下。因此，`Frangipani` 可以被看做是一个集群文件系统。

论文的作者在 `DIGITAL Unix 4.0` 之上实现了 `Frangipani`。得益于 `Frangipani` 在 `Petal` 之上构建的简洁的层级设计，使得在几个月内实现了一个可用的系统。

`Frangipani` 的目标运行环境的场景是程序开发和工程。测试表明在这样的负载下，`Frangipani` 有着优秀的性能并且能很好的扩展并最终受限于网络。

## 系统结构
![alt](/images/frangipani-2.png)

上图展示了 `Frangipani` 系统下各机器的一种典型职责分配。最上方的机器运行着用户程序和 `Frangipani` 的文件服务模块，这些机器无需挂载磁盘。最下方的机器运行着 `Petal` 和分布式锁服务。

不过在实际场景中，组成 `Frangipani` 的机器无需严格按照上图中的描述承担职责。`Petal` 和 `Frangipani` 服务不一定要运行在不同的机器上；每台运行着 `Petal` 的机器也可以同时运行着 `Frangipani`，特别是当 `Petal` 的机器负载不高时。分布式锁服务独立于系统中的其他服务，上图中描述了每个 `Petal` 机器上运行着一个锁服务，不过它们也可以运行在 `Frangipani` 或者其他可用的机器上。

### 组件
如前面的图中所示，用户程序通过标准的系统调用接口来访问 `Frangipani`。运行在不同机器上的应用程序能访问到相同的文件，而且看到的文件内容也是相同的；也就是说，如果在某台机器上修改了某个文件或者文件夹，那么运行在其他机器上的程序也能马上看到这个修改。对于使用 `Frangipani` 的程序来说，`Frangipani` 提供的文件操作语义保证和本地 `Unix` 文件系统提供的文件操作语义保证相同：程序对文件的修改会先暂存在内核的缓冲区中，在下一次的 `fsync` 或者 `sync` 系统调用之前，系统不保证对文件的修改会保存到非易失存储上，不过系统会记录对文件元数据的修改并且可选的保证当系统调用返回时，文件的元数据修改已保存到了非易失存储上。和本地文件系统的文件操作语义有点小小的不同，`Frangipani` 中文件的最后访问时间是一个近似值，从而避免了每次读取文件时都需要写元数据。

每台机器上的 `Frangipani` 文件服务模块运行在操作系统内核中。通过内核的 `file system switch` `Frangipani` 将自己注册为一个可用的文件系统实现。`Frangipani` 的文件服务模块使用了内核的缓冲区来缓存最近使用的文件。它通过本地的 `Petal` 设备驱动来实现对 `Petal` 虚拟磁盘的读写。每个文件服务器使用相同的数据结构来读取和写入文件到共享的 `Petal` 磁盘上，不过各服务器会在 `Petal` 磁盘的不同区域上针对进行中的修改维护各自的重做日志。因为 `Frangipani` 的重做日志保存在 `Petal` 中，所以当某个 `Frangipani` 服务器异常时，其他的服务器可以通过 `Petal` 访问日志并进行数据恢复。各 `Frangipani` 服务器之间无需通信；它们只会和 `Petal` 和分布式锁通信。这就简化了服务器的添加，删除和恢复。

`Petal` 的设备驱动程序掩盖了 `Petal` 分布式的特性，对操作系统的上层应用来说，`Petal` 就等同于是一块本地磁盘。驱动程序负责和正确的 `Petal` 服务器通信，以及如果当前的服务器发生异常，能切换到另一台可用的服务器。类似 `Digital Unix`  的文件系统都可以运行在 `Petal` 之上，不过只有 `Frangipani` 提供了多客户端下访问同一文件的数据一致性特性。

`Petal` 的各服务器基于本地挂载的物理磁盘并通过协作来向 `Frangipani` 提供大型，可扩展，容错的虚拟磁盘。`Petal` 可以容忍一个或多个磁盘或者服务器异常，只要大多数的 `Petal` 服务器依然存活并且相互之间可以通信，以及每个数据块都至少有一个副本保存在物理存储上并且能够被访问。

`Frangipani` 用到的锁服务能够为网络中的客户端提供通用的读写锁服务。出于容错和扩展性考虑，它的实现是分布式的。`Frangipani` 使用锁服务来协调对虚拟磁盘的访问，以及保证各服务器内文件缓存的一致性。

### 安全和客户端/服务器配置
如 `Fugure 2` 所示，每台运行着用户程序的机器同时运行着 `Frangipani` 的文件服务模块。虽然这种配置有利于负载均衡和扩展，不过存在安全隐患。每个 `Frangipani` 机器都可以对共享的 `Petal` 虚拟磁盘上的数据块进行任意读写，所以 `Frangipani` 必须运行在受信任的操作系统上；类似于 `NFS` 的远程文件访问协议中的身份认证还不足以保证安全性。完整的安全性也要求 `Petal` 和锁服务运行在受信任的操作系统上，并且 `Frangipani`、`Petal`、锁服务这三个组件都需要能够互相认证。最后，为了保证文件数据的私有性，也需要保证没有人能够窃听 `Petal` 和 `Frangipani` 机器间的网络通信。

一种解决方案是运行用户程序的机器被设置为不允许运行自定义修改的操作系统，同时这些机器间通过一个私有网络连接并且用户程序没有权限访问。不过这并不是说需要将所有的机器放在同一个机房中并通过私有的物理网络相连；可以借助某些加密技术来实现系统的安全启动，以及某些认证技术和加密链路来保证安全性。另外，对于某些应用程序来说，一个不完整的解决方案也是可以接受的；典型的如 `NFS` 就不能防止网络窃听以及避免用户在自己的工作站上运行修改后的操作系统。论文的作者并没有实现所有的安全措施，不过 `Frangipani` 基本也可以达到 `NFS` 的安全级别，`Petal` 服务器只会接受来自已知网络地址的 `Frangipani` 服务器的请求。

![alt](/images/frangipani-3.png)

如上图所示，`Frangipani` 文件系统可以扩展到外部非受信的管理域中。图中区分开了 `Frangipani` 客户端和服务端。只有受信的 `Frangipani` 服务端可以和 `Petal` 以及锁服务通信。这三个组件可以放置在一个受限制的环境中并且通过私有的网络连接。而外部的非受信远程客户端只能和 `Frangipani` 服务端通信，而不能直接访问 `Petal` 服务器。

客户端可以和 `Frangipani` 服务端以任何操作系统支持的文件访问协议通信，例如 `DCE/DFS`，`NFS`，`SMB`，因为对于运行着 `Frangipani` 服务端的机器来说，`Frangipani` 就类似于是个本地文件系统。当然，如果访问协议本身支持一致性访问是最好的（例如 `DCE/DFS`），从而使得 `Frangipani` 的多服务器间的一致性不会在上一层丢失。理想情况下，客户端的访问协议需要支持故障转移。上述提到的协议并不直接支持故障转移，不过在其他系统中如果某台服务器发生异常，会有另一台服务器接管并复用异常服务器的 `IP` 地址，因此可以在这里应用同样的手段。

除了安全之外，还有第二个原因要使用上述的客户端/服务端配置。因为 `Frangipani` 运行在操作系统内核，不能快速的适配不同的操作系统甚至是不同版本的 `Unix`。所以通过远程客户端的方式就能使得运行不支持的操作系统的客户端也能够使用 `Frangipani`。

### 讨论
构建文件系统的分层思想——低层提供存储服务，高层提供命名，文件夹和文件服务，并不是 `Frangipani` 独有的。最早应用这个思想的是 `Universal File Server`。不过，`Petal` 提供的存储功能和早先的系统大有不同，从而引申出不同的上层结构设计。

`Frangipani` 的设计是基于 `Petal` 提供的抽象存储服务，作者还未充分考虑为了适配其他的存储服务（例如 `NASD`）需要对 `Frangipani` 做出哪些修改。

`Petal` 提供了高可用的存储服务并且能够通过添加资源来实现对吞吐和容量的扩展。不过，`Petal` 不提供协同功能或者在多个客户端间共享存储。另外，大部分的应用程序不能直接使用 `Petal` 的接口因为 `Petal` 面向的是磁盘而不是文件。`Frangipani` 在 `Petal` 之上构建了文件系统层使得在保留和扩展了 `Petal` 有用的特性的同时对应用程序更加易用。

`Frangipani` 的一个优势是能够透明的添加服务器，删除服务器以及实现故障恢复。通过将预写日志、锁和提供一致性访问、高可用的存储结合使用，`Frangipani` 能轻易实现这个特性。

`Frangipani` 的另一个特性是能在文件系统运行时生成一致性的备份。这个机制会在后面介绍。

不过 `Frangipani` 的设计可能在三个方面上存在问题。基于启用了副本的 `Petal` 虚拟磁盘构建的 `Frangipani` 有时候会记录重复的日志，一次是 `Frangipani` 自己写入的日志，这里是 `Frangipani` 为客户端提供服务；另一次是 `Petal`记录的日志，这里以 `Petal` 的视角来说 `Frangipani` 成为了客户端。第二，`Frangipani` 无法根据磁盘的位置来选择在哪里保存数据，因为 `Petal` 提供的是虚拟的磁盘，之所以有这个需求可能是因为类似于 `GFS` 选择在哪里放置副本一样，如果 `Frangipani` 能知道具体磁盘的位置，它就能选择一个距离客户端近的磁盘保存文件。最后，`Frangipani` 会对整个文件或者文件夹加锁而不是对某个数据块加锁。不过作者还没有足够的使用经历来评估这三个问题的影响，不过撇开它们不谈，在作者所处环境下测试出的 `Frangipani` 的性能还是不错的。

## 磁盘布局


## 参考
* [Frangipani: A Scalable Distributed File System](https://pdos.csail.mit.edu/6.824/papers/thekkath-frangipani.pdf)