title: 'MIT 6.824 - The Design of a Practical System for Fault-Tolerant Virtual Machines'
tags:
- MIT 6.824
- Paper
---

## 介绍
和一般描述的应用级别的主从备份不同，本文描述的是虚拟机的主从备份。主从备份作为一种常见的容错实现手段，当主节点异常时，从节点能取代主节点从而保证系统依然可用。作为从节点，它的状态必须尽可能的与主节点随时保持一致，这样当主节点异常时从节点能马上取代主节点，而客户端也不会感知到异常，同时也没有数据丢失。其中一种同步主从节点状态的方式是持续将主节点的所有修改发送给从节点，这里的修改包括 `CPU`、内存以及 `IO` 设备。然而，采用这种同步方式需要大量的网络带宽，尤其是发送内存的修改。

另一种只需要耗费少量带宽的方式是状态机（`state machine`）同步。该方法将主从同步抽象为确定性状态机（`deterministic state machine`）同步问题，在确定性状态机模型下，对于两个初始状态一样的状态机来说，按照相同的顺序执行相同的一系列输入指令后，最后的状态也一定是相同的。然而，对于大部分的服务来说，存在某些非确定性的操作，例如生成一个随机数，这时候就需要额外的协调使得主从间依然是同步的，即从节点也要生成一模一样的随机数。不过，处理这种情况所需要维护的额外信息相比于主节点状态的修改（主要是内存的修改）来说不值一提。

对于物理机来说，随着主频的增加，同步主从间的确定性执行也愈发困难。然而对于运行在 `hypervisor` 上的虚拟机来说却非常适合实现状态机同步。一个虚拟机本身就可以看做一个明确的状态机，它的所有操作就是被虚拟化的机器的操作（包括所有的设备）。和物理机一样，虚拟机也存在一些非确定性的操作（例如读取当前时间或者发送一个中断），所以也需要发送额外的信息给从节点来保证主从同步。因为 `hypervisor` 掌管着虚拟机的执行，包括发送所有的输入给被虚拟化的机器，所以它能捕获到执行非确定性操作的所有需要的信息，从而能正确的在从节点上执行重放操作。

因此，基于状态机同步的主从同步方式可以在不需要修改硬件的情况下在廉价的硬件上实现，使得容错技术适用于最新的微处理器。另外，对带宽较低的要求使得长距离的虚拟机主从同步成为了可能。例如，可以在跨校园间不同的物理机上做主从同步，相比于同大厦内的主从同步更为可靠。

目前在 `VMware vSphere 4.0` 平台上已经实现了这种容错技术，该平台能高效完整的虚拟化 `x86` 架构的机器。因为 `VMware vSphere` 实现了一个完全的 `x86` 虚拟机，所以可以自动的对任何 `x86` 的操作系统和应用提供容错支持。通过确定性重放（`deterministic replay`），系统可以记录下主节点的执行并且确保能在从节点执行相同的操作。`VMware vSphere Fault Tolerance (FT)` 在此基础之上增加了额外的功能和协议来支持构建一个可完全容错的系统。除了对硬件的容错外，当主节点异常时，系统能自动的在本地集群中启动一台可用的从节点来接管主节点。在该篇论文发表的时候，确定性重放技术和 `VMware FT` 仅支持单核的虚拟机。受限于严重的性能问题，多核虚拟机的重放支持仍在进行中，因为在多核场景下，几乎每一个对共享内存的访问都是一个非确定性的操作。

`Bressoud` 和 `Schneider` 针对惠普的 `PA-RISC` 平台的虚拟机容错做了个原型实现。`VMware` 的实现与其类似，不过出于性能的考虑做了些根本的修改以及调研了一些其他实现方案。另外，为了能构建一个高效、可用的容错系统来支持用户的企业级应用，`VMware` 还设计和实现了许多其他组件以及解决一些实际的问题。和大多数实际的系统要解决的问题一样，这里的容错针对的是 `fail-stop` 的异常，即在造成外部可见的不正确的行为前可被监测到的异常，例如磁盘空间不足、网络无法连通等等，而诸如应用程序的 `bug` 或者人为失误等则不属于 `fail-stop` 异常，系统也无法进行容错。

## 基础设计
![alt](/images/vm-ft-1.png)

上图展示了支持容错的虚拟机的基本配置。对于每一台需要支持容错的虚拟机（`primary VM`），系统会在其他物理机上同时运行一台备份虚拟机（`backup VM`），备份虚拟机和主虚拟机会保持同步，并执行和主虚拟机相同的指令，不过会存在一定的延迟。这两台虚拟机被称为处于 `virtual lockstep` 状态。同时，虚拟机连接着相同的共享存储，输入和输出都可以被主从虚拟机访问。不过，只有主虚拟机才会暴露在网络中，所以所有的网络输入都会只发送给主虚拟机。同样的，其他所有的输入（例如键盘和鼠标输入）也都只会发送给主虚拟机。

参考：

* [The Design of a Practical System for Fault-Tolerant Virtual Machines](https://pdos.csail.mit.edu/6.824/papers/vm-ft.pdf)
* [6.824 2022 Lecture 4: Primary/Backup Replication](https://pdos.csail.mit.edu/6.824/notes/l-vm-ft.txt)