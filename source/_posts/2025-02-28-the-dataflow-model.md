title: '【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing'
tags:
- Paper
---

## 介绍
面对日益增长的大规模无界、无序数据处理需求，当前的技术手段存在诸多不足：
* 以 `MapRecue` 为代表的批处理系统无法满足数据处理的及时性要求，因为需要先收集所有的数据，然后再处理
* 很多流式系统对于大规模处理下的容错性缺少明确的保证
* 能够提供大规模处理和容错性的系统又缺少表达性和正确性
* 很多系统也缺少 `exactly-once` 语义保证，从而影响正确性
* 缺少对窗口（`windowing`）计算的支持或支持有限
* 某些支持基于事件时间（`event-time`）的窗口计算的系统要么要求事件必须有序，要么窗口触发语义不够丰富
* 缺少高层次的编程模型能够直观的支持基于事件时间的会话（`session`）
* 虽然 `Lambda` 架构能够解决大部分的问题，但是需要同时构建和维护两套系统，增加了成本

当前已有系统的主要问题在于认为数据是有界的，这个假设对当下海量且无序的数据处理的需求是不成立的；另外，需要一个简单但又强大的工具在满足上述场景的同时，又能在正确性，延迟和成本之间取得平衡；最后，需要转变由执行引擎决定系统语义的思想，不管是批处理，微批处理，还是流式处理，只要经过了合理的设计和实现，都能提供同等水平的正确性保证，而这三种执行引擎如今都广泛用于处理无界的数据。因此，在正确性保证的前提下，选择不同的执行引擎的决定因素就在于延迟和资源成本。

本文提出了一个统一的模型：
* 对无界，无序的数据，能够根据事件本身的维度特征进行窗口聚合，并按照事件时间排序计算，并且在正确性，延迟，和成本之间灵活调优
* 将 `pipeline` 的实现拆解为四个维度，以提供清晰性，可组合性和灵活性：
  * `What`：计算的结果是什么
  * `Where`：参与计算的事件时间
  * `When`：数据处理时间
  * `How`：先前的计算结果如何与后续优化关联
* 将数据处理的逻辑概念与底层物理实现剥离，对于批处理，微批处理，和流式处理的选择，取决于用户对正确性，延迟，和成本的考量

具体来说，本文的主要贡献在于提出了：
* 窗口模型：支持非对齐的事件时间窗口，并提供简单的 `API` 用于创建和使用窗口
* 触发模型：将数据处理结果的输出时机与 `pipeline` 的运行时特征相绑定，并提供了强大和灵活的声明式 `API` 来描述触发的语义
* 增量式的处理模型：支持窗口模型和触发模型计算的撤销和更新
* 可扩展的实现：既支持流式处理引擎（`MillWheel`），也支持批处理引擎（`FlumeJava`），以及对 `Google Cloud Dataflow` 的外部二次实现，并提供了运行时无关的开源 `SDK`
* 一系列指导本文描述的模型设计的核心准则
* `Google` 产线环境下大规模无界，无序数据处理的真实案例探讨，正是这些真实需求驱动了该本文描述的模型的开发

### 无界/有界与流式/批
相比于流式/批，本文倾向于使用无界/有界来描述无限/有限的数据集，因为前者可能暗示使用了特定的执行引擎。实际上，无界的数据同样可以用连续运行的批处理引擎处理，而设计合理的流式处理引擎同样可以处理有界的数据。

### 窗口
窗口将一个数据集划分为有限个数的组。在处理无界数据时，窗口对于某些操作是必须的（如聚合，外连接，以时间为界的操作），而对于其他操作（如过滤，映射，内连接）则不是必须的。对于有界数据来说，窗口是可选的，不过依然在很多场景下适用（如对已经处理过的无界数据的一部分进行大批量的更新，即 `backfill`）。窗口始终是基于时间的，虽然某些系统支持基于元组的窗口，不过这依然是基于时间的窗口，其中有序的元素隐含着对应递增的逻辑时间。窗口分为对齐和非对齐，前者覆盖整个数据集，后者则覆盖数据集的某些子集。

#### 固定窗口
也称为滚动窗口（`tumbling window`），每个窗口都是固定的大小，且彼此之间没有重叠，通常都是对齐的，例如，每小时生成大小为1小时的窗口：
* 窗口1：[12:00, 13:00)
* 窗口2：[13:00, 14:00)
* 窗口3：[14:00, 15:00)
* ...

不过，有时候为了保证窗口对齐，会将窗口按照键以某个随机值进行偏移。

#### 滑动窗口
滑动窗口由窗口大小和滑动周期构成，例如，每分钟生成大小为1小时的窗口：
* 窗口1：[12:00, 13:00)
* 窗口2：[12:01, 13:01)
* 窗口3：[12:02, 13:02)
* ...

滑动周期可能会比窗口大小小，所以相邻两个窗口直接有重叠，当滑动周期等于窗口大小的时候，滑动窗口就退化成了滚动窗口。滑动窗口一般也是对齐的。

#### 会话
会话窗口用于框住某段时间内产生的数据子集，其大小一般以超时时间来衡量，在该超时时间内发生的事件都会归于该会话。会话一般是非对齐的窗口。

## 参考
* [The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing](https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43864.pdf)
