title: 'MIT 6.824 Lab 1 (6) - 实现'
tags:
- MIT 6.824
- Go
- MapReduce
---

## 概览
`Lab 1` 需要我们实现一个单机多线程、多进程的 `MapReduce` 程序，通过 `test-mr.sh` 可以看到该实验会先启动一个主节点进程，然后再启动多个工作节点进程。

## 主节点
主节点的入口是 `mrcoordinator.go`，通过 `go run mrcoordinator.go pg*.txt` 可运行一个主节点程序，其中 `pg*.txt` 是本次 `MapReduce` 程序的输入数据。同时，主节点和工作节点间通过 `RPC` 进行交互，需要我们实现以下 `RPC` 接口：

1. 实验中主节点的任务分发采用的是拉模式，工作节点会定期向主节点请求一个任务，这个任务可以是 `map` 任务也可以是 `reduce` 任务，由主节点根据当前任务的状态决定应该推送 `map` 任务还是 `reduce` 任务
2. 工作节点注册，当工作节点启动后，需要向主节点发送一个注册请求，主节点收到请求后会返回一个工作节点编号，后续工作节点请求任务时需要带上这个编号。这个接口并没有在实验中描述，这个的目的是为了能将多个 `map` 节点生成的同一个键的中间结果数据能都发送给同一个 `reduce` 节点，当主节点收到 `reduce` 任务请求时，就可以根据节点编号选择发送哪份中间结果数据
3. `map` 任务完成后需要通知主节点生成的中间结果文件地址，主节点收到请求后需要将中间结果文件地址保存到内部数据结构中，供后续发送给对应 `reduce` 任务

### 任务管理

## 工作节点
工作节点的入口是 `mrworker.go`，通过 `go run mrworker.go wc.so` 可运行一个工作节点程序，其中 `wc.so` 是本次 `MapReduce` 程序用到的用户自定义 `map` 和 `reduce` 函数。工作节点只有一个 `Worker` 主方法，需要不断向主节点轮询请求任务，那么工作节点什么时候结束轮询？根据实验建议有两种方法，一种是当本次 `MapReduce` 任务完成后，主节点进程退出，当工作节点再次请求主节点任务时，`RPC` 请求必然失败，此时工作节点可认为本次任务已完成主节点已退出，从而结束轮询并退出；另一种是当主节点完成后，在一定时间内，在收到工作节点新的任务请求时，返回一个要求工作节点退出的标识（或者也可抽象为一种任务类型），工作节点收到 `RPC` 响应后退出。

### map 任务
`map` 任务负责调用用户自定义的 `map` 函数，生成一组中间结果数据，然后将中间结果数据保存为文件，实验建议的文件名是 `mr-X-Y`，其中 `X` 表示 `map` 任务的编号，`Y` 表示 `reduce` 任务的编号。每个 `map` 任务会生成 `R` 个中间结果文件，实验已提供了分片函数，对中间结果的每个键使用 `ihash(key) % NReduce` 来决定写入到哪个中间结果文件中。

由于 `map` 节点有可能执行失败，为避免 `reduce` 节点读取到的是未写入完成的中间结果文件，在写入中间结果文件时可以先写入一个临时文件，在写入完成后再重命名为最终的文件名。在本实验中，可以使用 `ioutil.TempFile` 来创建临时文件，以及使用 `os.Rename` 来原子性的重命名文件。

在当前 `map` 任务的中间结果文件写入完成后，需要通过 `RPC` 请求通知主节点所有中间结果文件的文件地址。在本实验中，各个工作节点运行在同一台机器上，实验要求保存 `map` 任务的中间结果文件到当前文件夹，这样 `reduce` 任务就能通过中间结果文件的文件名读取中间结果数据。

对中间结果数据的写文件可以借助 `Go` 的 `encoding/json` 模块，例如：

```go
enc := json.NewEncoder(file)
for _, kv := ... {
    err := enc.Encode(&kv)
```

然后 `reduce` 任务读取文件：

```go
dec := json.NewDecoder(file)
for {
    var kv KeyValue
    if err := dec.Decode(&kv); err != nil {
        break
    }
    kva = append(kva, kv)
}
```

### reduce 任务
`reduce` 任务负责将所有中间结果数据按照键排序后应用用户自定义的 `reduce` 函数，并生成最终输出文件，文件格式为 `mr-out-X`，其中 `X` 表示 `reduce` 任务的编号。文件中的每一行对应一个 `reduce` 函数调用的结果，需要按照 `Go` 的 `%v %v` 形式对键值对进行格式化。

参考：

* [6.824 Lab 1: MapReduce](https://pdos.csail.mit.edu/6.824/labs/lab-mr.html)