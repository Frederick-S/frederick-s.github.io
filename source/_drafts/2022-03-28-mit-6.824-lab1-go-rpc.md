title: 'MIT 6.824 Lab 1 (5) - Go RPC'
tags:
- MIT 6.824
- Go
---

`Lab 1` 中主节点和工作节点会通过 `RPC` 进行交互，`Go` 本身也提供了开箱即用的 `RPC` 功能，下面将通过一个简单的求和服务来了解在 `Go` 中如何实现一个 `RPC` 服务。

## 定义请求体和响应体
请求体和响应体都非常简单，`SumRequest` 中包含要求和的两个数字，`SumReply` 中存放求和的结果：

```go
package pb

type SumRequest struct {
	A int
	B int
}

type SumReply struct {
	Result int
}
```

## 服务端
首先定义服务类 `SumService` 和提供的方法：

```go
type SumService struct {
}

func (sumService *SumService) Sum(sumRequest *pb.SumRequest, sumReplay *pb.SumReply) error {
	sumReplay.Result = sumRequest.A + sumRequest.B

	return nil
}
```

`SumService` 只有一个 `Sum` 方法，接收 `SumRequest` 和 `SumReply` 两个参数，求和后将结果放回到 `SumReply` 中（`Sum` 的方法签名必须是这样的形式，即两个入参和一个 `error` 类型的出参，具体规则见下文描述）。

然后进行服务注册：

```go
sumService := &SumService{}
rpc.Register(sumService)
rpc.HandleHTTP()
```

通过 `rpc.Register` 这个方法了解到，一个服务类及其提供的方法必须满足以下条件才能注册成功：

1. 服务类必须是公共的
2. 服务类提供的方法必须是公共的
3. 服务类提供的方法入参必须是两个，一个表示请求，一个表示响应（实际代码是判断是否等于3个，因为在这种场景下定义的方法的第一个入参类似于 `Java` 中的 `this`）
4. 服务类提供的方法的第一个参数类型必须是公共的或者是 `Go` 内置的数据类型
5. 服务类提供的方法的第二个参数类型也必须是公共的或者是 `Go` 内置的数据类型，且必须是指针类型
6. 服务类提供的方法的出参个数只能是1个
7. 服务类提供的方法的出参类型必须是 `error`

## 客户端
a

完整的代码可参考 [go-rpc-demo](https://github.com/Frederick-S/go-rpc-demo)。

参考：

* [6.824 Lab 1: MapReduce](https://pdos.csail.mit.edu/6.824/labs/lab-mr.html)