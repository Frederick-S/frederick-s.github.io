<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"frederick-s.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Übung macht den Meister">
<meta property="og:url" content="https://frederick-s.github.io/index.html">
<meta property="og:site_name" content="Übung macht den Meister">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Xiaodan Mao">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://frederick-s.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Übung macht den Meister</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J1NC2B33VK"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-J1NC2B33VK","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Übung macht den Meister" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Übung macht den Meister</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-mit-6.824"><a href="/mit-6.824/" rel="section"><i class="fas fa-book fa-fw"></i>MIT 6.824</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-赞赏"><a href="/sponsor/" rel="section"><i class="fas fa-heart fa-fw"></i>赞赏</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fas fa-rss fa-fw"></i>RSS</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xiaodan Mao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/02/27/the-dataflow-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/27/the-dataflow-model/" class="post-title-link" itemprop="url">【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-27 00:00:00" itemprop="dateCreated datePublished" datetime="2025-02-27T00:00:00+08:00">2025-02-27</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>9.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>16 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p>面对日益增长的大规模无界、无序数据的处理需求，当前的技术手段存在诸多不足：</p>
<ul>
<li>以 <code>MapRecue</code> 为代表的批处理系统无法满足数据处理的及时性要求，因为需要先收集所有的数据，然后再处理</li>
<li>很多流式系统对于大规模处理下的容错性缺少明确的保证</li>
<li>能够提供大规模处理和容错性的系统又缺少表达性和正确性</li>
<li>很多系统也缺少 <code>exactly-once</code> 语义保证，从而影响正确性</li>
<li>缺少对窗口（<code>windowing</code>）计算的支持或支持有限</li>
<li>某些支持基于事件时间（<code>event-time</code>）的窗口计算的系统要么要求事件必须有序，要么窗口触发语义不够丰富</li>
<li>缺少高层次的编程模型能够直观的支持基于事件时间的会话（<code>session</code>）</li>
<li>虽然 <code>Lambda</code> 架构能够解决大部分的问题，但是需要同时构建和维护两套系统，增加了成本</li>
</ul>
<p>当前已有系统的主要问题在于认为数据是有界的，这个假设对当下海量且无序的数据处理的需求是不成立的；另外，需要一个简单但又强大的工具在满足上述场景的同时，又能在正确性，延迟和成本之间取得平衡；最后，需要转变由执行引擎决定系统语义的思想，不管是批处理，微批处理，还是流式处理，只要经过了合理的设计和实现，都能提供同等水平的正确性保证，而这三种执行引擎如今都广泛用于处理无界的数据。因此，在正确性保证的前提下，选择不同的执行引擎的决定因素就在于延迟和资源成本。</p>
<p>本文提出了一个统一的数据处理模型：</p>
<ul>
<li>对无界，无序的数据，能够根据事件本身的维度特征进行窗口聚合，并按照事件时间排序计算，并且在正确性，延迟，和成本之间灵活调优</li>
<li>将 <code>pipeline</code> 的实现拆解为四个维度，以提供清晰性，可组合性和灵活性：
<ul>
<li><code>What</code>：计算的结果是什么</li>
<li><code>Where</code>：参与计算的事件时间</li>
<li><code>When</code>：数据处理时间</li>
<li><code>How</code>：先前的计算结果如何与后续优化关联</li>
</ul>
</li>
<li>将数据处理的逻辑概念与底层物理实现剥离，对于批处理，微批处理，和流式处理的选择，取决于用户对正确性，延迟，和成本的考量</li>
</ul>
<p>具体来说，本文的主要贡献在于提出了：</p>
<ul>
<li>窗口模型：支持非对齐的事件时间窗口，并提供简单的 <code>API</code> 用于创建和使用窗口</li>
<li>触发模型：将数据处理结果的输出时机与 <code>pipeline</code> 的运行时特征相绑定，并提供了强大和灵活的声明式 <code>API</code> 来描述触发的语义</li>
<li>增量式的处理模型：集成窗口模型和触发模型，支持计算的撤销和更新</li>
<li>可扩展的实现：既支持流式处理引擎（<code>MillWheel</code>），也支持批处理引擎（<code>FlumeJava</code>），以及对 <code>Google Cloud Dataflow</code> 的外部二次实现，并提供了运行时无关的开源 <code>SDK</code></li>
<li>一系列指导本文描述的模型设计的核心准则</li>
<li><code>Google</code> 产线环境下大规模无界，无序数据处理的真实案例探讨，正是这些真实需求驱动了本文描述的模型的开发</li>
</ul>
<h3 id="无界有界与流式批"><a class="markdownIt-Anchor" href="#无界有界与流式批"></a> 无界/有界与流式/批</h3>
<p>相比于流式/批，本文倾向于使用无界/有界来描述无限/有限的数据集，因为前者可能暗示使用了特定的执行引擎。实际上，无界的数据同样可以用连续运行的批处理引擎处理，而设计合理的流式处理引擎同样可以处理有界的数据。</p>
<h3 id="窗口"><a class="markdownIt-Anchor" href="#窗口"></a> 窗口</h3>
<p>窗口将一个数据集划分为有限个数的组。在处理无界数据时，窗口对于某些操作是必须的（如聚合，外连接，以时间为界的操作），而对于其他操作（如过滤，映射，内连接）则不是必须的。对于有界数据来说，窗口是可选的，不过依然在很多场景下适用（如对已经处理过的无界数据的一部分进行大批量的更新，即 <code>backfill</code>）。窗口始终是基于时间的，虽然某些系统支持基于元组的窗口，不过这依然是基于时间的窗口，其中有序的元素隐含着对应递增的逻辑时间。窗口分为对齐和非对齐，前者窗口的边界与特定的时间间隔同步，后者不同的窗口可以在不同的时间开始和结束。</p>
<h4 id="固定窗口"><a class="markdownIt-Anchor" href="#固定窗口"></a> 固定窗口</h4>
<p><img src="/images/dataflow-1.png" alt="alt" /></p>
<p>也称为滚动窗口（<code>tumbling window</code>），每个窗口都是固定的大小，且彼此之间没有重叠，通常都是对齐的，例如，每小时生成大小为1小时的窗口：</p>
<ul>
<li>窗口1：[12:00, 13:00)</li>
<li>窗口2：[13:00, 14:00)</li>
<li>窗口3：[14:00, 15:00)</li>
<li>…</li>
</ul>
<p>不过，有时候为了保证窗口对齐，会将窗口按照键以某个随机值进行偏移。</p>
<h4 id="滑动窗口"><a class="markdownIt-Anchor" href="#滑动窗口"></a> 滑动窗口</h4>
<p><img src="/images/dataflow-2.png" alt="alt" /></p>
<p>滑动窗口由窗口大小和滑动周期构成，例如，每分钟生成大小为1小时的窗口：</p>
<ul>
<li>窗口1：[12:00, 13:00)</li>
<li>窗口2：[12:01, 13:01)</li>
<li>窗口3：[12:02, 13:02)</li>
<li>…</li>
</ul>
<p>滑动周期可能会小于窗口大小，所以相邻两个窗口之间有重叠，当滑动周期等于窗口大小的时候，滑动窗口就退化成了滚动窗口。滑动窗口一般也是对齐的。</p>
<h4 id="会话窗口"><a class="markdownIt-Anchor" href="#会话窗口"></a> 会话窗口</h4>
<p><img src="/images/dataflow-3.png" alt="alt" /></p>
<p>会话窗口用于框住某段时间内产生的数据子集，其大小一般以超时时间来衡量，在该超时时间内发生的事件都会归于该会话窗口。会话窗口一般是非对齐的。</p>
<h3 id="时间"><a class="markdownIt-Anchor" href="#时间"></a> 时间</h3>
<p>数据处理中有两类时间：</p>
<ul>
<li>事件时间：事件实际发生的时间</li>
<li>处理时间：事件被系统观测到并处理的时间</li>
</ul>
<p>一般来说事件时间一旦生成后就不会改变，而处理时间则随着事件在系统中流动而不断变化。理想情况下，如果分别对事件时间和处理时间画一条线，那么这两条线是重合的。不过在实际中，由于通信延迟，调度算法，处理单个事件需要的耗时，以及 <code>pipeline</code> 的序列化等因素，事件时间与处理时间之间存在偏差（如下图所示）。本文使用类似于 <code>MillWheel</code> 的 <code>watermark</code> 来表示这种偏差，<code>watermark</code> 定义了事件时间的一个下界，表示所有事件时间小于 <code>watermark</code> 的事件都已经处理完毕。不过，这依然是个理想情况，为了容忍一定程度的事件到达系统的延迟，<code>watermark</code> 会滞后于最新的事件时间，而这个容忍时间又不可能无限长，所以实际中即使生成 <code>watermark</code> 后也依然有可能存在事件时间比 <code>watermark</code> 小的事件到达系统，这些事件称为 <code>late event</code>。</p>
<p><img src="/images/dataflow-4.png" alt="alt" /></p>
<h2 id="dataflow-模型"><a class="markdownIt-Anchor" href="#dataflow-模型"></a> Dataflow 模型</h2>
<h3 id="核心原语"><a class="markdownIt-Anchor" href="#核心原语"></a> 核心原语</h3>
<p>在批处理下，<code>Dataflow SDK</code> 提供了操作 <code>(key, value)</code> 键值对的两种方式：</p>
<ul>
<li><code>ParDo</code>：对每个输入，通过调用用户定义的方法（在 <code>Dataflow</code> 中称为 <code>DoFn</code>），返回0个或者多个输出，各输入之间无关联，天然的适用于无界数据处理</li>
<li><code>GroupByKey</code>：将相同键的值聚合在一起，不过对于无界数据来说，何时将相同键聚合后的数据发给下游成为了一个问题，因为无法预知数据的边界，通用的解决方法是借助窗口</li>
</ul>
<p>以下是一个 <code>ParDo</code> 的例子，对于每个输入，通过调用 <code>ExpandPrefixes</code> 方法，返回每个键的所有可能的前缀：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>ParDo(ExpandPrefixes)</mtext><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{fix}, 1), (\text{fit}, 2) \\
\bigg\downarrow \quad \text{ParDo(ExpandPrefixes)} \\
\bigg\downarrow \\
(\text{f}, 1), (\text{fi}, 1), (\text{fix}, 1), (\text{f}, 2), (\text{fi}, 2), (\text{fit}, 2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">ParDo(ExpandPrefixes)</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span></p>
<p>以下是一个 <code>GroupByKey</code> 的例子，将相同键的值聚合在一起：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>GroupByKey</mtext><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{f}, 1), (\text{fi}, 1), (\text{fix}, 1), (\text{f}, 2), (\text{fi}, 2), (\text{fit}, 2) \\
\bigg\downarrow \quad \text{GroupByKey} \\
\bigg\downarrow \\
(\text{f}, [1, 2]), (\text{fi}, [1, 2]), (\text{fix}, [1]), (\text{fit}, [2])
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">GroupByKey</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">2</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="窗口-2"><a class="markdownIt-Anchor" href="#窗口-2"></a> 窗口</h3>
<p>支持按键聚合的系统一般会将 <code>GroupByKey</code> 以 <code>GroupByKeyAndWindow</code> 的形式实现，本文的首要贡献在于支持非对齐的窗口。具体来说：</p>
<ol>
<li><code>Dataflow</code> 模型的视角下可以将所有窗口都当做非对齐的，并交由具体实现来为对齐式的窗口场景优化</li>
<li>窗口计算可以拆解为两个操作：
<ul>
<li><code>Set&lt;Window&gt; AssignWindows(T datum)</code>：将输入分配给0个或者多个窗口</li>
<li><code>Set&lt;Window&gt; MergeWindows(Set&lt;Window&gt; windows)</code>：聚合时将多个窗口合并为一个</li>
</ul>
</li>
</ol>
<p>为了支持基于事件时间的窗口，需要将数据传输的格式从 <code>(key, value)</code> 改为 <code>(key, value, event_time, window)</code>，<code>event_time</code> 是事件时间，<code>window</code> 默认是一个全局窗口，覆盖所有的事件，同时也适配了有界数据的场景。</p>
<h4 id="窗口分配"><a class="markdownIt-Anchor" href="#窗口分配"></a> 窗口分配</h4>
<p>如果一个输入属于多个窗口，那么窗口分配会给每个窗口创建一个输入的副本。</p>
<p>在下面这个例子中，键值对 <code>(k, v1)</code> 和 <code>(k, v2)</code> 分别复制到了两个窗口中。窗口的分配也不需要等到聚合时，可以在 <code>pipeline</code> 的任意执行点发生：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>12:00</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>12:01</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>AssignWindows(Sliding(2m, 1m))</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>12:00</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>11</mn><mo>:</mo><mn>59</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>01</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>12:00</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>12</mn><mo>:</mo><mn>00</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>02</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>12:01</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>12</mn><mo>:</mo><mn>00</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>02</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>12:01</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>12</mn><mo>:</mo><mn>01</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>03</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{k}, \text{v1}, \text{12:00}, [0, \infty)), (\text{k}, \text{v2}, \text{12:01}, [0, \infty)) \\
\bigg\downarrow \quad \text{AssignWindows(Sliding(2m, 1m))} \\
(\text{k}, \text{v1}, \text{12:00}, [11:59, 12:01)), \\
(\text{k}, \text{v1}, \text{12:00}, [12:00, 12:02)), \\
(\text{k}, \text{v2}, \text{12:01}, [12:00, 12:02)), \\
(\text{k}, \text{v2}, \text{12:01}, [12:01, 12:03))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:00</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:01</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">AssignWindows(Sliding(2m, 1m))</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:00</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:00</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:01</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:01</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">3</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<h4 id="窗口合并"><a class="markdownIt-Anchor" href="#窗口合并"></a> 窗口合并</h4>
<p>窗口合并发生于 <code>GroupByKeyAndWindow</code> 操作，我们以超时时间为30分钟的会话窗口为例，假设有 <code>(k1, v1)</code>，<code>(k2, v2)</code>，<code>(k1, v3)</code>，<code>(k1, v4)</code> 四个事件，其初始默认的窗口都为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, \infty]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">]</span></span></span></span>。然后，<code>AssignWindows</code> 根据每个事件到达的起始时间分配一个时长为30分钟的会话窗口，在这期间如果有相同键的事件到达，则也将其归到同一个窗口内。然后，<code>GroupByKeyAndWindow</code> 操作可以拆解为如下步骤：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>13:02</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>13:14</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v3</mtext><mo separator="true">,</mo><mtext>13:57</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v4</mtext><mo separator="true">,</mo><mtext>13:20</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>AssignWindows(Sessions(30m))</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>13:02</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>32</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>13:14</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v3</mtext><mo separator="true">,</mo><mtext>13:57</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v4</mtext><mo separator="true">,</mo><mtext>13:20</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>20</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>DropTimestamps</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>32</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v3</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v4</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>20</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>GroupByKey</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>32</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v3</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v4</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>20</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>MergeWindows(Sessions(30m))</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v1</mtext><mo separator="true">,</mo><mrow><mtext mathvariant="bold">[13:02,</mtext><mtext> </mtext><mtext mathvariant="bold">13:50)</mtext></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v3</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v4</mtext><mo separator="true">,</mo><mrow><mtext mathvariant="bold">[13:02,</mtext><mtext> </mtext><mtext mathvariant="bold">13:50)</mtext></mrow><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>GroupAlsoByWindow</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mrow><mtext mathvariant="bold">[v1,</mtext><mtext> </mtext><mtext mathvariant="bold">v4]</mtext></mrow><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext mathvariant="bold">[v3]</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext mathvariant="bold">[v2]</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>ExpandToElements</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>[v1, v4]</mtext><mo separator="true">,</mo><mtext mathvariant="bold">13:50</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>[v3]</mtext><mo separator="true">,</mo><mtext mathvariant="bold">14:27</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>[v2]</mtext><mo separator="true">,</mo><mtext mathvariant="bold">13:44</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{k1}, \text{v1}, \text{13:02}, [0, \infty)), \\
(\text{k2}, \text{v2}, \text{13:14}, [0, \infty)), \\
(\text{k1}, \text{v3}, \text{13:57}, [0, \infty)), \\
(\text{k1}, \text{v4}, \text{13:20}, [0, \infty)), \\
\bigg\downarrow \quad \text{AssignWindows(Sessions(30m))} \\
(\text{k1}, \text{v1}, \text{13:02}, [13:02, 13:32)), \\
(\text{k2}, \text{v2}, \text{13:14}, [13:14, 13:44)), \\
(\text{k1}, \text{v3}, \text{13:57}, [13:57, 14:27)), \\
(\text{k1}, \text{v4}, \text{13:20}, [13:20, 13:50)) \\
\bigg\downarrow \quad \text{DropTimestamps} \\
(\text{k1}, \text{v1}, [13:02, 13:32)), \\
(\text{k2}, \text{v2}, [13:14, 13:44)), \\
(\text{k1}, \text{v3}, [13:57, 14:27)), \\
(\text{k1}, \text{v4}, [13:20, 13:50)) \\
\bigg\downarrow \quad \text{GroupByKey} \\
(\text{k1}, [(\text{v1}, [13:02, 13:32)), \\
            (\text{v3}, [13:57, 14:27)), \\
            (\text{v4}, [13:20, 13:50))]), \\
(\text{k2}, [(\text{v2}, [13:14, 13:44))]) \\
\bigg\downarrow \quad \text{MergeWindows(Sessions(30m))} \\
(\text{k1}, [(\text{v1}, \textbf{[13:02, 13:50)}), \\
            (\text{v3}, [13:57, 14:27)), \\
            (\text{v4}, \textbf{[13:02, 13:50)})]), \\
(\text{k2}, [(\text{v2}, [13:14, 13:44))]) \\
\bigg\downarrow \quad \text{GroupAlsoByWindow} \\
(\text{k1}, [(\textbf{[v1, v4]}, [13:02, 13:50)), \\
            (\textbf{[v3]}, [13:57, 14:27))]), \\
(\text{k2}, [(\textbf{[v2]}, [13:14, 13:44))]) \\
\bigg\downarrow \quad \text{ExpandToElements} \\
(\text{k1}, \text{[v1, v4]}, \textbf{13:50}, [13:02, 13:50)), \\
(\text{k1}, \text{[v3]}, \textbf{14:27}, [13:57, 14:27))), \\
(\text{k2}, \text{[v2]}, \textbf{13:44}, [13:14, 13:44))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:02</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:14</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:57</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:20</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">AssignWindows(Sessions(30m))</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:02</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:14</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:57</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:20</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">DropTimestamps</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">GroupByKey</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">MergeWindows(Sessions(30m))</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">[13:02, 13:50)</span></span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">[13:02, 13:50)</span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">GroupAlsoByWindow</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">[v1, v4]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">[v3]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">[v2]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">ExpandToElements</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">[v1, v4]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">13:50</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">[v3]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">14:27</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">[v2]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">13:44</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<ul>
<li><code>DropTimestamps</code>：丢弃事件的时间戳，因为这里只涉及窗口计算</li>
<li><code>GroupByKey</code>：按照键聚合 <code>(value, window)</code> 元组</li>
<li><code>MergeWindows</code>：合并每个键下 <code>(value, window)</code> 元组中的窗口，具体的合并逻辑由窗口策略决定。在上述的例子中，如果两个 <code>(value, window)</code> 元组中的窗口存在重叠，则每个元组合并后的窗口为两个窗口的并集</li>
<li><code>GroupAlsoByWindow</code>：对每个键下的 <code>(value, window)</code> 元组按照窗口聚合，在上述例子中，<code>v1</code> 和 <code>v4</code> 因为有相同的窗口，所以被聚合在了一起</li>
<li><code>ExpandToElements</code>：将每个键下的 <code>(value, window)</code> 元组展开为 <code>(key, value, event_time, window)</code> 的形式，新的 <code>event_time</code> 在上述例子中采用的是窗口的结束时间，不过实际上只要是大于窗口内最早的事件的时间戳都行。</li>
</ul>
<h4 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h4>
<p>现在通过 <code>Cloud Dataflow SDK</code> 的代码示例来展示如何使用窗口。下述代码将数据按照键聚合后，求所有值的加和：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; input = IO.read(...);</span><br><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; output = input</span><br><span class="line">  .apply(Sum.integersPerKey());</span><br></pre></td></tr></table></figure>
<p>如果要支持超时时间为30分钟的会话窗口，则在求和前调用 <code>Window.into</code> 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; input = IO.read(...);</span><br><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; output = input</span><br><span class="line">  .apply(Window.into(Sessions.withGapDuration(</span><br><span class="line">    Duration.standardMinutes(<span class="number">30</span>))))</span><br><span class="line">  .apply(Sum.integersPerKey());</span><br></pre></td></tr></table></figure>
<h3 id="触发器和增量处理"><a class="markdownIt-Anchor" href="#触发器和增量处理"></a> 触发器和增量处理</h3>
<p>目前为止，还遗留两个问题：</p>
<ul>
<li>需要支持基于元组和处理时间的窗口，不然会和当前已有的系统不兼容</li>
<li>需要知道窗口中的数据计算结果何时可以下发到下游</li>
</ul>
<p>本文认为借助 <code>watermark</code> 来解决第二个问题是不够的，因为 <code>watermark</code> 不能百分百确保所有数据都已经到达，真实场景中总会有晚到的数据。<code>Lambda</code> 架构则提供了一个思路：流式引擎部分提供低延迟的计算，不过其结果是近似值，而批处理引擎则提供最终一致性正确的结果。不过，如何将两者合并到一个 <code>pipeline</code> 中？</p>
<p>本文提出了触发器（<code>trigger</code>）的概念，和窗口的关系为：</p>
<ul>
<li>窗口：根据事件时间决定如何对事件分组</li>
<li>触发器：决定何时（处理时间）告知窗口计算的数据结果可以下发到下游</li>
</ul>
<p><code>Google</code> 实现的系统内置了几类触发器的实现用于在多种场合触发：</p>
<ul>
<li>当所有的数据已被系统接收时（预估，非精确，如 <code>watermark</code>）</li>
<li>处理时间线上的某个时间点</li>
<li>响应数据到达（如数量，大小，<code>data punctuations</code>，模式匹配等满足了一定的条件）</li>
</ul>
<p>另外，不同的触发器之间还可以进行逻辑组合，例如使用 <code>and</code>，<code>or</code>，循环，序列等等。</p>
<p>引入触发器后，同一个窗口的计算结果就有可能被多次下发，系统也提供了三种处理模式：</p>
<ul>
<li>丢弃（<code>Discarding</code>）：一旦窗口被触发，其内容下发后即被丢弃，后续触发和之前的触发没有任何关系。如果多次窗口触发的结果是幂等的，则可以采用该模式</li>
<li>累加（<code>Accumulating</code>）：窗口被触发后，其计算结果会持久化，后续触发结果会作为历史结果的修正。适合于数据消费方收到新的窗口数据，直接替换旧数据的场景。例如某个窗口计算是求窗口中所有数据的最大值，第一次触发时下发目前的最大值，后续有数据再次到达时根据持久化的历史值，直接和当前值比较就可以得到最新的最大值</li>
<li>累加和撤销（<code>Accumulating and Retracting</code>）：在 <code>Accumulating</code> 的基础上，触发的窗口计算结果同样会先持久化，如果后续有新的触发，则会下发两个值，一个是用于告知下游系统撤销上次的值，另一个是最新的窗口计算结果。不过，这也需要下游系统具有响应数据撤销事件的能力</li>
</ul>
<h2 id="实现和设计"><a class="markdownIt-Anchor" href="#实现和设计"></a> 实现和设计</h2>
<h3 id="设计原则"><a class="markdownIt-Anchor" href="#设计原则"></a> 设计原则</h3>
<p><code>Dataflow</code> 模型的一些设计原则：</p>
<ul>
<li>永远不要依赖任何完整性的概念</li>
<li>要有足够好的灵活性，既可以适应已知的各种使用场景，又能支持未来可能的扩展</li>
<li>在预想的执行引擎中要添加有价值的东西，而不仅仅是因为合理</li>
<li>鼓励清晰的实现</li>
<li>支持在数据产生的上下文中进行强大的数据分析</li>
</ul>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43864.pdf">The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/02/17/rocksdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/17/rocksdb/" class="post-title-link" itemprop="url">【读】RocksDB: Evolution of Development Priorities in a Key-value Store Serving Large-scale Applications</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-17 00:00:00" itemprop="dateCreated datePublished" datetime="2025-02-17T00:00:00+08:00">2025-02-17</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>28 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文是 <code>Facebook</code> 对 <code>RocksDB</code> 8年开发历程的回顾，重点讨论了为支持大规模分布式系统所做的开发优先级取舍与演进，以及在生产环境中运行大规模应用的经验。</p>
<h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p><code>RocksDB</code> 是 <code>Facebook</code> 在2012年创建的高性能 <code>KV</code> 持久存储引擎，代码衍生自 <code>Google</code> 的 <code>LevelDB</code>。它针对 <code>SSD</code> 的某些特性进行了优化，目标是服务于大型（分布式）应用，在使用上则以类库的方式和上层应用集成。每个 <code>RocksDB</code> 实例是个单机版程序，本身不提供跨主机间的操作，例如副本管理和负载均衡，同时也不提供高阶 <code>API</code>，例如不支持 <code>checkpoint</code>，这些都留给上层应用自行实现。</p>
<p><code>RocksDB</code> 及其高度可定制的组件设计使其能够从容应对不同的业务需求和工作负载。除了作为数据库系统的存储引擎外，<code>RocksDB</code> 还被用于以下几种不同类型的服务：</p>
<ul>
<li>流式处理：典型代表如 <code>Flink</code> 借助 <code>RocksDB</code> 保存 <code>checkpoint</code> 的状态数据</li>
<li>日志/队列服务：依托于 <code>RocksDB</code> 可定制化的合并策略，这些服务能够以不亚于追加写单个文件的效率实现高吞吐的写入，同时有着较低的写放大，以及享受内置索引带来的便利</li>
<li>索引服务：<code>RocksDB</code> 的 <code>bulk loading</code> 特性能够为索引服务提供大规模加载离线数据的能力，同时也有着高效的查询性能</li>
<li>基于 <code>SSD</code> 的二级缓存：因为 <code>RocksDB</code> 针对 <code>SSD</code> 进行了优化，所以某些内存式的缓存服务会借助 <code>RocksDB</code> 在内存不够时将部分数据置换到 <code>SSD</code>。这些服务往往要求存储引擎有着足够高的写入速度和优秀的点查询性能</li>
</ul>
<h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2>
<p><code>RocksDB</code> 的设计极大的受到了 <code>SSD</code> 特性的影响，<code>SSD</code> 不对称的读写性能和有限的耐用性给 <code>RocksDB</code> 的数据结构设计和系统架构带来了机遇和挑战。</p>
<h3 id="基于-ssd-的嵌入式存储"><a class="markdownIt-Anchor" href="#基于-ssd-的嵌入式存储"></a> 基于 SSD 的嵌入式存储</h3>
<p>相比于机械硬盘，<code>SSD</code> 读写的 <code>IOPS</code> 可以达到十万至百万，读写速度可以达到几百至几千 <code>MB/s</code>。一方面，这给如何设计软件从而能充分利用 <code>SSD</code> 的性能带来了挑战；另一方面，受限于 <code>SSD</code> 有限的擦除次数，同时也需要考虑如何设计合理的数据结构，避免提前耗尽 <code>SSD</code> 的寿命。</p>
<p>正因为 <code>SSD</code> 有着出色的性能，在大多数情况下，应用的性能瓶颈也从设备 <code>I/O</code> 转向了网络；应用架构设计时也更倾向于将数据存储在本地 <code>SSD</code> 而不是远程存储服务，因此，能够内嵌在应用中的本地 <code>KV</code> 存储引擎的需求就日渐上涨。</p>
<p>在这个背景下，<code>Facebook</code> 实现了 <code>RocksDB</code>，其中 <code>LSM</code> 树扮演了重大的角色。</p>
<h3 id="rocksdb-的架构和-lsm-树的使用"><a class="markdownIt-Anchor" href="#rocksdb-的架构和-lsm-树的使用"></a> RocksDB 的架构和 LSM 树的使用</h3>
<p><code>RocksDB</code> 使用 <code>LSM</code> 树作为主要的数据结构来保存数据并支持以下核心的操作。</p>
<h4 id="写"><a class="markdownIt-Anchor" href="#写"></a> 写</h4>
<p>写入时会先将数据写入到名为 <code>MemTable</code> 的内存写缓冲中，同时也会在磁盘上记录 <code>Write Aghead Log (WAL)</code>。<code>MemTable</code> 由跳表（<code>skiplist</code>）实现，插入和查询的时间复杂度都是 <code>O(logn)</code>。<code>WAL</code> 可按需开启，用于 <code>RocksDB</code> 从崩溃后恢复数据。当 <code>MemTable</code> 的大小达到所配置的阈值时：</p>
<ol>
<li>当前接受写入的 <code>MemTable</code> 和 <code>WAL</code> 变为只读</li>
<li>后续新的写入转到新创建的 <code>MemTable</code> 和 <code>WAL</code></li>
<li>系统会将变为只读的 <code>MemTable</code> 和 <code>WAL</code> 的内容落盘到 <code>Sorted String Table (SSTable)</code> 内</li>
<li>已落盘的 <code>MemTable</code> 和 <code>WAL</code> 则可以丢弃</li>
</ol>
<p><code>SSTable</code> 中的数据按序存储，并以等大小的块（<code>block</code>）组织。<code>SSTable</code> 生成后同样只能只读，同时，其内部会维护一个索引块，索引块中会给每个数据块维护一条索引，从而能借助二分查找快速搜索。</p>
<h4 id="合并"><a class="markdownIt-Anchor" href="#合并"></a> 合并</h4>
<p><img src="/images/rocksdb-1.png" alt="alt" /></p>
<p>如上图所示，一个 <code>LSM</code> 树分为多层。最新的 <code>SSTable</code> 由 <code>MemTable</code> 刷盘生成，并放置在 <code>Level-0</code>。其他层的 <code>SSTable</code> 则统一由合并程序维护。当第 <code>L</code> 层的 <code>SSTable</code> 大小触及了配置值，合并程序会选择该层的部分 <code>SSTable</code>，并将其和第 <code>L + 1</code> 层内键的范围存在重合的 <code>SSTable</code> 进行合并，从而在第 <code>L + 1</code> 层生成一个新的 <code>SSTable</code>。通过这个操作，<code>RocksDB</code> 就可以将已删除和过时的数据清除，同时新生成的 <code>SSTable</code> 也进行了瘦身，节省了磁盘空间，最终写入的数据会逐渐从 <code>Level-0</code> 迁移到最后一层。整个合并过程的 <code>I/O</code> 效率也比较高，一方面不同层的合并可以并行执行，另一方面 <code>I/O</code> 操作只涉及整个 <code>SSTable</code> 文件的批量读和写。</p>
<p><code>MemTable</code> 和 <code>Level-0</code> 层的 <code>SSTable</code> 键的范围可能会存在重合，而 <code>Level-1</code> 及其之后的每一层内，<code>RocksDB</code> 会确保每个 <code>SSTable</code> 之间键的范围不会重合（但是不同层之间的 <code>SSTable</code> 键的范围是有可能重合的）。</p>
<p><code>RocksDB</code> 支持不同类型的合并策略：</p>
<ul>
<li><code>Leveled Compaction</code>：借鉴自 <code>LevelDB</code> 并加以改进。每一层可容纳的文件大小呈指数级放大。系统会积极的触发合并以确保每层的文件大小不会超过指定阈值</li>
<li><code>Tiered Compaction</code>：在 <code>RocksDB</code> 中也被称为 <code>Universal Compactioin</code>，与 <code>Apache Cassandra</code> 或 <code>HBase</code> 采取的合并策略类似。当 <code>Level-0</code> 层文件的个数或者非 <code>Level-0</code> 层的个数超过指定的阈值时，又或者整个数据库的大小和最深层文件大小之比超过指定的阈值时，就会触发合并多个 <code>SSTable</code>。有别于 <code>Leveled Compaction</code>，<code>Tiered Compaction</code> 是惰性合并，实际的合并会推迟到读性能或者空间效率发生衰减时进行，从而能够一次性合并更多的数据</li>
<li><code>FIFO Compaction</code>：当数据库大小触及到指定阈值时，丢弃最老的 <code>SSTable</code>，且只进行轻量级的合并。适合于基于内存的缓存应用</li>
</ul>
<p><code>RocksDB</code> 的读写性能在不同的合并策略下有着不同的表现，应用开发者需要结合自身服务的工作负载来选择合适的合并策略。</p>
<h4 id="读"><a class="markdownIt-Anchor" href="#读"></a> 读</h4>
<p>读取时，<code>RocksDB</code> 首先在所有的 <code>MemTable</code> 中查找，如果没有找到则继续在位于 <code>Level-0</code> 层的所有 <code>SSTable</code> 中查找，如果还没有找到，则继续向下一层中键的范围包含要查找的键的 <code>SSTable</code> 中查找，所有的查找都借助了二分搜索。另外还有两项辅助查找的优化：</p>
<ol>
<li>频繁被访问的 <code>SSTable</code> 块会在内存中缓存从而减少文件 <code>I/O</code>，以及解压缩的开销</li>
<li>布隆过滤器用于快速排除一定不包含要查找的键的 <code>SSTable</code></li>
</ol>
<h4 id="column-family"><a class="markdownIt-Anchor" href="#column-family"></a> Column Family</h4>
<p><code>RocksDB</code> 在2014年引入了 <code>column family</code> 功能，不同的 <code>column family</code> 下可以包含相同的键，每个 <code>column family</code> 有独立的 <code>MemTable</code> 和 <code>SStable</code>，但是共享 <code>WAL</code>。其优势在于：</p>
<ol>
<li>每个 <code>column family</code> 可独立配置，如合并，压缩，<code>merge operators</code> 以及 <code>compaction filters</code></li>
<li>共享的 <code>WAL</code> 能够原子性的记录多个 <code>column family</code> 的更新</li>
<li><code>column family</code> 可动态高效的删除和创建</li>
</ol>
<h2 id="资源优化目标的演进"><a class="markdownIt-Anchor" href="#资源优化目标的演进"></a> 资源优化目标的演进</h2>
<h3 id="写放大"><a class="markdownIt-Anchor" href="#写放大"></a> 写放大</h3>
<p><code>RocksDB</code> 最初的资源优化目标在于减少 <code>SSD</code> 的擦除周期以及写放大，写放大包含两方面：</p>
<ol>
<li><code>SSD</code> 本身的写放大：<code>SSD</code> 不能直接覆盖已有的数据，需要先将其擦除，再写入，写入的粒度为 <code>page</code>，但是擦除的粒度是 <code>block</code>，一个 <code>block</code> 包含多个 <code>page</code>；同时 <code>SSD</code> 的垃圾回收也会造成数据移动和擦除；最后 <code>SSD</code> 的 <code>Wear Leveling</code> 特性会保证各个 <code>memory cell</code> 均衡的写入，也引入了数据移动</li>
<li>数据库软件带来的写放大</li>
</ol>
<p>在这两个因素下有时候写放大能达到100倍。</p>
<p><code>Leveled Compaction</code> 的写放大倍数基本在10到30，在大多数情况能够数倍优于 <code>B</code> 树的实现。更进一步，<code>Tiered Compaction</code> 能将写放大倍数降至4到10，不过缺点是读性能会有一定的下降。一般来说，当应用的写负载较高时，可以配合写放大较低的合并策略，而当写负载不高时，则可以采用更激进的合并策略，从而有更好的空间效率和读性能。</p>
<h3 id="空间放大"><a class="markdownIt-Anchor" href="#空间放大"></a> 空间放大</h3>
<p>经过了多年的开发后，<code>RocksDB</code> 团队认为对于大多数应用来说，空间使用率远比写放大重要，因为这些场景下还没有触及 <code>SSD</code> 本身的限制，不恰当的比喻来说就是：</p>
<blockquote>
<p>以大多数应用程序的稳定性来说，还远没有到比拼不同的操作系统稳定性的地步。</p>
</blockquote>
<p>而实际上，应用本身也没有充分利用 <code>SSD</code> 提供的读写吞吐，因此这一阶段的优化重心就转移到了磁盘空间上。</p>
<p>由于 <code>LSM</code> 树无碎片的数据组织方式，天然的避免了由于数据碎片带来的磁盘空间浪费。另一方面，<code>RocksDB</code> 也引入了新的合并策略 <code>Dynamic Leveled Compaction</code>，其中 <code>LSM</code> 树每一层的大小上限会动态的根据最深层文件的大小调整，而不是固定值。这么做的原因是为了减少 <code>LSM</code> 树中无效的数据（已删除和已被覆盖），而和最深层文件大小的比值则可作为有多少无效数据的度量指标。最终的结果也表明相比于 <code>Leveled Compaction</code>，<code>Dynamic Leveled Compaction</code> 有着更稳定的空间效率。</p>
<h3 id="cpu-利用率"><a class="markdownIt-Anchor" href="#cpu-利用率"></a> CPU 利用率</h3>
<p>随着 <code>SSD</code> 的发展，一种潜在的担忧是应用程序已不能完全充分利用 <code>SSD</code> 的潜能。因此，系统的瓶颈也从设备 <code>I/O</code> 转移到了 <code>CPU</code>。不过，<code>RocksDB</code> 的开发人员不这么看，因为：</p>
<ol>
<li>只有少部分的应用受限于 <code>SSD</code> 的 <code>IOPS</code>，大部分应用受限于磁盘空间</li>
<li>一个高端 <code>CPU</code> 足够服务于一个高端 <code>SSD</code>。在 <code>Facebook</code> 的生产环境中还没有遇到 <code>RocksDB</code> 不能充分利用 <code>SSD</code> 能力的情况。当然，如果一个 <code>CPU</code> 配备多个 <code>SSD</code> 还是有可能会有 <code>CPU</code> 瓶颈的，不过这属于系统配置层面的资源不均衡问题。另一方面，写密集型的应用也有可能存在 <code>CPU</code> 瓶颈的问题，不过这可以通过使用更轻量级的合并策略解决。而在这之外的场景，其工作负载则可能不适合使用 <code>SSD</code>，因为有可能提前让 <code>SSD</code> 的寿命完结</li>
</ol>
<p>不过，优化 <code>CPU</code> 利用率也不等于说是无用功，因为空间放大的优化余地已经不多了。优化了 <code>CPU</code> 也等同于省钱，毕竟 <code>CPU</code> 和内存的价格也在节节攀升。一些针对 <code>RocksDB</code> 的 <code>CPU</code> 优化的尝试包括前缀布隆过滤器，在查找索引前先用布隆过滤器判断，以及其他的一些布隆过滤器优化。</p>
<h3 id="适配新技术"><a class="markdownIt-Anchor" href="#适配新技术"></a> 适配新技术</h3>
<p>一些 <code>SSD</code> 的新技术例如 <code>open-channel SSDs</code>，<code>multi-stream SSDs</code>，<code>ZNS</code> 能让 <code>SSD</code> 有着更低的查询延迟以及更少的擦除周期损耗。不过，如前面所述，<code>RocksDB</code> 的开发团队认为大部分应用的瓶颈在于磁盘空间，适配这些新技术反而会给 <code>RocksDB</code> 的一致性体验带来挑战，所以这项的优先级不高。</p>
<p><code>In-storage computing</code> 可能会给应用带来巨大的提升，不过 <code>RocksDB</code> 的开发团队目前还不确定 <code>RocksDB</code> 能从这项技术中受益多少，而且对 <code>API</code> 的改动可能也比较大。</p>
<p><code>Disaggregated (remote) storage</code> 则更具吸引力，并且也是当前的一个优化重点。前文的优化背景都是应用直接访问本地 <code>SSD</code>，不过，如今更快的网络带宽使得远程访问 <code>SSD</code> 成为了可能，因此，如何优化 <code>RocksDB</code> 使其更好的适配远程 <code>SSD</code> 也变得有意义。在远程存储模式下，<code>CPU</code> 和 <code>SSD</code> 资源可以同时做到充分利用以及独立扩展，相反本地 <code>SSD</code> 的模式则较难实现。目前 <code>RocksDB</code> 的开发团队正在优化远程模式下的 <code>I/O</code> 延迟。</p>
<p>最后，<code>non-volatile memory (NVM)</code> （它相比于 <code>SSD</code> 有着更高的 <code>IO</code> 读写吞吐）这项技术也在考量中：</p>
<ol>
<li>将 <code>NVM</code> 作为 <code>DRAM</code> 的扩展
<ol>
<li>如何实现核心数据结构（<code>block cache</code> 还是 <code>MemTable</code>）从而结合 <code>NVM</code> 和 <code>DRAM</code> 一起使用</li>
<li>会引入哪些额外的开销</li>
</ol>
</li>
<li>将 <code>NVM</code> 作为数据库的主要存储：不过实践表明 <code>RocksDB</code> 的瓶颈主要在于磁盘空间或者 <code>CPU</code>，而不是 <code>I/O</code></li>
<li>用 <code>NVM</code> 保存 <code>WAL</code>：其成本是否值得有待考虑，毕竟 <code>WAL</code> 中的数据量不大，并且会刷盘到 <code>SSD</code></li>
</ol>
<h3 id="再次审视-rocksdb-使用-lsm-树的合理性"><a class="markdownIt-Anchor" href="#再次审视-rocksdb-使用-lsm-树的合理性"></a> 再次审视 RocksDB 使用 LSM 树的合理性</h3>
<p><code>LSM</code> 树依然是最适合的，因为 <code>SSD</code> 还没有到白菜价的地步，对于大多数应用来说，其有限的寿命依然是无法忽略的因素。而另一方面，<code>RocksDB</code> 的开发团队也发现某些写密集型的应用会写大量的大对象，如果能分别存储键值对则能减少 <code>SSD</code> 的写入，其功能实现为 <code>BlobDB</code>。</p>
<h2 id="运行大规模系统的经验总结"><a class="markdownIt-Anchor" href="#运行大规模系统的经验总结"></a> 运行大规模系统的经验总结</h2>
<h3 id="资源管理"><a class="markdownIt-Anchor" href="#资源管理"></a> 资源管理</h3>
<p>大规模分布式数据服务往往会将数据以 <code>shard</code> 的粒度分区到多个节点上，一个节点可能会持有几十上百个 <code>shard</code>。不过 <code>shard</code> 的大小有限，因为 <code>shard</code> 是负载均衡和副本的最小单位，需要在各节点之间进行拷贝。在 <code>Facebook</code> 的环境内，一个 <code>shard</code> 由一个 <code>RocksDB</code> 实例提供服务，因此一个节点会运行很多 <code>RocksDB</code> 实例，它们可能会共享一个地址空间，也有可能会独享。</p>
<p>在上述背景下，就需要考虑如何进行资源管理，包括：</p>
<ol>
<li>分配给 <code>write buffer</code>，<code>MemTable</code>，<code>block cache</code> 的内存</li>
<li>合并程序占用的 <code>I/O</code> 带宽</li>
<li>合并程序线程数</li>
<li>磁盘使用量</li>
<li>文件删除速率</li>
</ol>
<p>资源管理包括两个维度，全局（分配给每个节点的资源）和局部（分配给每个 <code>RocksDB</code> 实例的资源）。对后者来说，<code>RocksDB</code> 允许应用程序创建 <code>resource controller</code> （以 <code>C++</code> 对象实现并传递给多个 <code>RocksDB</code> 实例）来对上述提到的资源进行分配。例如，一个实现了对合并程序占用的 <code>I/O</code> 带宽限流的 <code>C++</code> 对象可以传递给多个 <code>RocksDB</code> 实例，从而保证任一时刻所有 <code>RocksDB</code> 实例的合并程序占用的 <code>I/O</code> 带宽之和不会超过指定值。另外，资源管理需要能够支持按优先级分配，使得最迫切需要资源的实例能够优先获取资源。</p>
<p>另一个在一个进程内运行多个 <code>RocksDB</code> 实例的经验总结是将各实例中执行相似任务的线程统一以一个线程池进行管理，而不是每个实例各自维护线程池。这些线程执行的往往是后台任务，统一了线程池也变相的限制了后台任务执行时占用的 <code>I/O</code>，使得资源使用更具预测性。独立维护线程池的情况下有可能会有瞬时的 <code>CPU</code> 或者 <code>I/O</code> 毛刺，造成服务不稳定。不过，有得则有失，共享线程池的缺点就在于某些实例有可能无法及时的获取线程，从而阻塞后台任务，例如无法及时执行 <code>SSTable</code> 的合并，甚至造成写停顿（<code>write stall</code>）。</p>
<p>相比而言，当不同的 <code>RocksDB</code> 实例运行在多个进程时，全局的资源管理则更具有挑战性，毕竟各进程之间没有信息交互。文中提出了两种策略：</p>
<ol>
<li>为每个 <code>RocksDB</code> 实例配置较为保守的资源额度，缺点就是全局资源利用率不一定最优</li>
<li>各进程间交换资源使用的情况，从而动态调整资源配比</li>
</ol>
<h3 id="支持副本和备份"><a class="markdownIt-Anchor" href="#支持副本和备份"></a> 支持副本和备份</h3>
<p><code>RocksDB</code> 本身不提供开箱即用的副本和备份的支持，需要应用自行实现，不过 <code>RocksDB</code> 为实现这两个功能提供了必要的支持。</p>
<h4 id="副本"><a class="markdownIt-Anchor" href="#副本"></a> 副本</h4>
<p>从一个节点复制出一个全新的副本节点有两种方式：</p>
<ol>
<li>逻辑复制（<code>logical copying</code>）：遍历源节点的所有键值对，然后写入到目标节点。在源节点端，借助 <code>RocksDB</code> 的快照功能保证了数据的读一致性。同时，<code>RocksDB</code> 支持 <code>scan</code> 操作从而在数据复制时减少对在线查询的影响。在目标节点端，<code>RocksDB</code> 提供了 <code>bulk loading</code> 的功能来批量加载数据</li>
<li>物理复制（<code>physical copying</code>）：直接复制 <code>SSTable</code> 和其他辅助文件到目标节点。<code>RocksDB</code> 在复制时会确保没有文件被修改或删除</li>
</ol>
<h4 id="备份"><a class="markdownIt-Anchor" href="#备份"></a> 备份</h4>
<p>备份对于数据库来说至关重要，和副本复制一样，备份的实现同样有逻辑备份和物理备份两种。副本和备份的其中一个区别在于上层应用经常会需要同时管理多个备份。<code>RocksDB</code> 也内置了一个备份引擎针对简易的备份场景。</p>
<h4 id="更新副本面临的挑战"><a class="markdownIt-Anchor" href="#更新副本面临的挑战"></a> 更新副本面临的挑战</h4>
<p>在多副本场景下，如何将主节点的更新以一致的顺序同步到各个副本是一个挑战。直白的做法是依次按序向各个副本写入，当然缺点就是性能很差，无法利用多线程。另外，当某个副本停止同步很久之后，需要有相应的机制能让其快速同步至最新的状态。</p>
<p>而无序写的问题在于读取时有可能数据不一致，一种解决方法是引入快照读，客户端读取时指定序列号，<code>RocksDB</code> 会返回执行快照时对应时间点的数据，而不会受当前正在进行中的写入的影响。</p>
<h3 id="wal-处理"><a class="markdownIt-Anchor" href="#wal-处理"></a> WAL 处理</h3>
<p>传统的数据库一般要求每次写入前先写 <code>write-ahead-log (WAL)</code> 来保证数据的持久性。相反，大型分布式存储系统一般使用多副本来提升性能和可用性，例如，如果某个副本的数据损坏或者无法访问，那么系统可以基于其他完好的副本重新构建损坏的副本。对于这些系统来说，<code>WAL</code> 就不是那么重要。另外，分布式系统一般也有自己的一致性协议日志（如 <code>Paxos</code> 协议），这种情况下 <code>WAL</code> 就可以不需要了。</p>
<p>因此，<code>RocksDB</code> 需要能够针对不同的场景灵活配置 <code>WAL</code>，<code>RocksDB</code> 提供了三种选项：</p>
<ol>
<li>同步刷盘写 <code>WAL</code></li>
<li>先将 <code>WAL</code> 写入到缓冲区，然后定期由后台低优先级线程刷盘</li>
<li>无 <code>WAL</code></li>
</ol>
<h3 id="数据格式兼容性"><a class="markdownIt-Anchor" href="#数据格式兼容性"></a> 数据格式兼容性</h3>
<p>大型分布式应用往往运行在诸多节点上，并且最好不发生服务中断。因此，软件更新往往是逐台（或者小批量同时）发布，出现问题时再回滚。因此，<code>RocksDB</code> 需要能够保证存储在磁盘上的数据能够后向和前向兼容。另外，出于副本构建或者负载均衡的需要，系统会在各节点之间复制数据，因此整个集群可能运行着多个版本格式的数据。</p>
<p>对于后向兼容来说，<code>RocksDB</code> 需要能够识别之前的所有数据格式，这无疑增加了实现了维护的复杂度。对于前向兼容来说，<code>RocksDB</code> 需要能识别新的数据格式，并且至少要支持一年的前向兼容，这方面的技术手段借助于 <code>Protocol Buffer</code> 或者 <code>Thrift</code>。对于配置项的兼容性来说，<code>RocksDB</code> 需要能够识别未知的配置，并尽最大可能尝试猜测配置的含义或者忽视。</p>
<h2 id="错误处理的经验总结"><a class="markdownIt-Anchor" href="#错误处理的经验总结"></a> 错误处理的经验总结</h2>
<p><code>RocksDB</code> 的开发团队通过产线的实践总结了三条关于错误处理的经验：</p>
<ol>
<li>数据损坏越早监测到越好，从而最低程度的避免数据不可用或丢失，同时也能精确定位数据损坏的源头。<code>RocksDB</code> 通过在系统各层级计算数据的校验和并在数据传输时验证校验和来识别数据是否损坏</li>
<li>完整性保护必须覆盖整个系统，从而避免由于静默的硬件数据损坏传递给 <code>RocksDB</code> 客户端或者其他副本。仅仅在数据未使用或者传输时检测是不够的，因为数据损坏有可能由异常的软件，异常的 <code>CPU</code> 或者其他异常的硬件引入。不过，即使基础设施一直扫描系统中是否有异常的硬件，某些硬件异常也不一定能够被发现</li>
<li>错误需要能够区别对待。<code>RocksDB</code> 的开发团队最开始将所有非 <code>EINTR</code> （系统调用中断）类型的文件系统错误统一处理。如果错误发生在读取操作，那么 <code>RocksDB</code> 直接将错误传递给客户端。如果错误发生在写操作，那么 <code>RocksDB</code> 认为这是一个不可恢复的错误，然后永久中断所有的写入；<code>RocksDB</code> 需要重启才能恢复写入，并且可能还需要额外的运维操作。为了减少这种粗暴的重启，<code>RocksDB</code> 的开发团队开始对错误按照严重性分门别类，并且只有在遇到确实是不可恢复的错误时才中断操作</li>
</ol>
<h3 id="静默损坏的频率"><a class="markdownIt-Anchor" href="#静默损坏的频率"></a> 静默损坏的频率</h3>
<p>在真实的 <code>RocksDB</code> 使用场景中，多久会发生一次静默的数据损坏？这很难直接给出答案。出于成本的考虑，应用所使用的存储设备一般不提供端到端的数据保护，相反，应用依赖 <code>RocksDB</code> 提供的块校验和来检测数据损坏。另一方面，基于 <code>RocksDB</code> 的应用本身也会运行数据校验程序来对比副本间的数据，不过这个过程识别出的数据损坏既有可能是 <code>RocksDB</code> 引入的，也有可能是应用本身引入的。</p>
<p>通过比较 <code>MyRocks</code> 中主键和二级索引的使用情况，<code>RocksDB</code> 的开发团队推断出每 <code>100 PB</code> 数据在每三个月内会发生一次由 <code>RocksDB</code> 本身引起的数据损坏。其中40%的情况下，这些数据损坏已经扩散到了其他副本上。</p>
<p>另一方面，数据损坏也有可能发生在数据传输中，这经常是由于软件 <code>bug</code> 导致。例如，底层存储系统在处理网络异常时的一个 <code>bug</code> 会导致一段时间后，每传输 <code>1 PB</code> 数据大约有17个校验和不匹配。</p>
<h3 id="多级保护"><a class="markdownIt-Anchor" href="#多级保护"></a> 多级保护</h3>
<p>数据损坏需要尽早识别，以免扩大影响范围，并尽可能的减少服务中断时间和数据丢失。大多数的 <code>RocksDB</code> 应用会持有一份数据的多个副本，并定期检测副本的校验和来识别损坏的副本，一旦发现损坏的副本，应用就可以丢弃该副本并替换为正确的备份。不过，这种做法的前提是系统中始终持有有效数据的副本。</p>
<p>如下图所示，<code>RocksDB</code> 启用了多级校验和保护，从而能尽早的发现数据损坏。</p>
<p><img src="/images/rocksdb-2.png" alt="alt" /></p>
<h4 id="块完整性"><a class="markdownIt-Anchor" href="#块完整性"></a> 块完整性</h4>
<p>块校验和继承自 <code>LevelDB</code>，是为了避免文件系统层的数据损坏传递到客户端。这里的块不仅仅指 <code>SSTable</code> 块，也包括了 <code>WAL</code> 段（<code>fragment</code>），在块生成时会同时生成校验和。每当一个块被读取时，<code>RocksDB</code> 都会检验它的校验和。</p>
<h4 id="sstable-完整性"><a class="markdownIt-Anchor" href="#sstable-完整性"></a> SSTable 完整性</h4>
<p>每个 <code>SSTable</code> 文件也保存了一个校验和，该功能在2020年引入，是为了避免 <code>SSTable</code> 在传输时造成损坏，校验和会在生成 <code>SSTable</code> 时同时生成，并保存在 <code>SSTable</code> 的元数据中，<code>RocksDB</code> 会在传输 <code>SSTable</code> 时检验校验和。不过，这篇文章发表时，还没有 <code>WAL</code> 文件级别的校验和。</p>
<h4 id="handoff-完整性"><a class="markdownIt-Anchor" href="#handoff-完整性"></a> Handoff 完整性</h4>
<p>在往文件系统写入数据前，会同时生成一个 <code>handoff</code> 校验和，然后将数据和校验和一起传递给下一层，由下一层进行数据校验。<code>RocksDB</code> 的开发团队期望用这种方式对 <code>WAL</code> 进行校验，因为 <code>WAL</code> 都是增量的追加写，不过可惜的是，很少有本地文件系统支持这种校验方式。不过，当 <code>RocksDB</code> 结合远程存储使用时，可以修改 <code>write</code> 接口使其接收额外的校验和，然后将其添加到存储服务内部的 <code>ECC</code> （<code>Error Correction Code</code>，用于校验数据完整性）中，最后远程存储服务在收到写请求时就可以进行校验。</p>
<h4 id="端到端的键值对完整性保护"><a class="markdownIt-Anchor" href="#端到端的键值对完整性保护"></a> 端到端的键值对完整性保护</h4>
<p>上述的完整性校验依然存在不足，其中一个不足在于文件系统之外的数据没有完整性保护，例如 <code>MemTable</code> 和 <code>block cache</code> 中的数据。因此，在这一层的数据损坏就无法被监测并有可能最终扩散到上层应用。而如果此时发生了 <code>MemTable</code> 的刷盘或者合并操作，则会将损坏的数据永久的持久化到磁盘上。</p>
<p>因此，<code>RocksDB</code> 的开发团队的解决方案是实现每个键值对级别的校验和，从而在文件系统层之外发现数据损坏。当某个键值对被复制时，其校验和也会随之复制，不过在写入到文件时这部分校验和会忽略，因为在文件系统级别已经有其他校验和机制来保证完整性了，从而减少数据冗余。</p>
<h4 id="基于严重性的错误处理"><a class="markdownIt-Anchor" href="#基于严重性的错误处理"></a> 基于严重性的错误处理</h4>
<p>大部分情况下，<code>RocksDB</code> 遇到的故障都是底层存储系统返回的错误。这些错误可能来自于各种各样的问题，从比较严重的问题例如文件系统变成了只读，到短暂的问题例如磁盘空间满了或者访问远程存储时网络异常。在早些时候，如果是读操作时发生的错误，<code>RocksDB</code> 就简单的将错误信息返回给客户端，而如果是写操作时发生的错误，<code>RocksDB</code> 则会永久性的暂停所有写操作。</p>
<p>而优化后 <code>RocksDB</code> 仅在遇到无法本地恢复的错误时才中断操作，例如暂时的网络错误不应该要求重启 <code>RocksDB</code> 实例。对于暂时性的错误，<code>RocksDB</code> 会周期性的重试。</p>
<h2 id="配置管理和可定制化的经验总结"><a class="markdownIt-Anchor" href="#配置管理和可定制化的经验总结"></a> 配置管理和可定制化的经验总结</h2>
<h3 id="配置管理"><a class="markdownIt-Anchor" href="#配置管理"></a> 配置管理</h3>
<p>一开始，<code>RocksDB</code> 的配置管理继承自 <code>LevelDB</code>，所有的配置都写死在代码中。这带来两个问题：</p>
<ol>
<li>某些配置和保存的数据强相关，因此，由某项配置生成的数据文件可能无法由其他配置的 <code>RocksDB</code> 实例打开</li>
<li>没有在代码中声明的配置会采用默认值，一旦 <code>RocksDB</code> 版本更新并修改了某些配置的默认值，上层应用可能会遇到不可预知的问题</li>
</ol>
<p>为了解决配置的问题，<code>RocksDB</code> 可以在打开某个数据库的同时额外接受某些参数配置，之后 <code>RocksDB</code> 又支持将配置持久化到文件中。<code>RocksDB</code> 也提供了额外的两个辅助工具：</p>
<ol>
<li>验证配置参数是否和要打开的数据库兼容</li>
<li>将数据库按照期望的参数配置进行迁移（不过存在使用限制）</li>
</ol>
<p>配置管理的另一个严峻的问题就是配置项太多了，用户很难知道每个配置参数的影响，进而不知道如何根据自身应用找到最优的配置。但是又很难找到一套放之四海皆准的默认配置，因为每个应用的使用场景，工作负载都不同。另一方面，对于集成了 <code>RocksDB</code> 的应用，例如 <code>MySQL</code>，数据库管理员可能对 <code>RocksDB</code> 了解不多也不知道如何优化。</p>
<p>在这个背景下，<code>RocksDB</code> 的开发团队花费了大量时间去优化默认配置下 <code>RocksDB</code> 的性能以及简化配置。同时，当前的重点在于提供配置的自适应性（<code>automatic adaptivity</code>），另一方面也持续提供 <code>RocksDB</code> 可自定义配置的能力，从而能适配不同类型的应用。同时做到这两方面会显著的增加代码维护的负担，不过一个统一的存储引擎的重要性大于代码的复杂度。</p>
<h3 id="回调函数的威力"><a class="markdownIt-Anchor" href="#回调函数的威力"></a> 回调函数的威力</h3>
<p><code>RocksDB</code> 需要周期性的合并底层的 <code>LSM</code> 树来清理已删除和过期的数据，如果能在合并时为应用提供额外的接口则能方便的为应用做功能扩展，而不需要额外的标准读写操作。因此，<code>RocksDB</code> 提供了两个在合并时的回调方法 <code>compaction filter</code> 和 <code>merge operator</code>。</p>
<h4 id="compaction-filter"><a class="markdownIt-Anchor" href="#compaction-filter"></a> Compaction Filter</h4>
<p>在合并时，<code>RocksDB</code> 提供了执行合并时针对每个被处理的键值对的回调函数，应用可以自行决定：</p>
<ol>
<li>丢弃这个键值对</li>
<li>修改值</li>
<li>不做任何修改</li>
</ol>
<p>一个典型的应用场景是实现 <code>time-to-live (TTL)</code>，每个键值对在写入时保存了过期时间，然后在合并期间判断是否过期从而删除数据。另一个应用场景是实现 <code>multi-version concurrency control (MVCC)</code> 中的垃圾回收。另外，<code>compaction filter</code> 也可以用于修改数据，例如，从旧数据格式迁移到新的数据格式，或者根据时间来修改数据。最后，<code>compaction filter</code> 有时候也可以用来收集统计信息。</p>
<p><code>compaction filter</code> 也非常适合需要扫描全部数据的管理任务，虽然也可以遍历整个数据集然后通过 <code>delete()</code> 或 <code>put()</code> 操作，但是使用 <code>compaction filter</code> 更高效且使用更少的 <code>I/O</code> 操作。借助 <code>compaction filter</code>，用户无需额外维护定时任务，也不用担心由自定义实现可能造成的写入毛刺。</p>
<p>不过，<code>compaction filter</code> 在使用上也有些限制。例如，错误的使用 <code>compaction filter</code> 可能会破坏基本的数据一致性保证，多次快照读也可能返回不一致的结果（如果数据在两次读之间发生了修改）。因此，<code>compaction filter</code> 在不要求一致性的场景下更容易使用。另一个限制是 <code>compaction filter</code> 无法原子的丢弃或者修改一批键值对，例如，无法原子的删除一个键值对并丢弃相应的二级索引中的数据。</p>
<h4 id="merge-operator"><a class="markdownIt-Anchor" href="#merge-operator"></a> Merge Operator</h4>
<p><code>RocksDB</code> 原生支持三类操作：<code>put()</code>，<code>delete()</code>，和 <code>merge()</code>。每一个操作都会写入到相应的 <code>MemTable</code>，然后刷盘到 <code>SSTable</code>。<code>merge()</code> 方法使得应用不需要先读取键就能更新键的值，也不需要写入完整的键的内容。在随后的读操作或者合并操作时，如果 <code>RocksDB</code> 遇到了一个 <code>merge record</code> 以及之前调用 <code>put()</code> 写入的记录，或者是多个 <code>merge record</code>，<code>RocksDB</code> 会调用 <code>merge operator</code> 回调函数，应用可以将这些记录合并成一个，既可以是一个 <code>put record</code>，也可以是一个 <code>merge record</code>。</p>
<p><code>merge operator</code> 的一个显著的应用是实现 <code>read-modify-write</code> 操作，例如实现一个计数器或者更新某个复杂对象中的单个字段。相比于用 <code>get()</code> 和 <code>put()</code> 整个键值对来实现，用 <code>merge operator</code> 来实现则更为轻量。不过，这会影响读的性能，因为找到一个 <code>merge record</code> 不代表查询结束，最坏的情况可能需要遍历 <code>LSM</code> 树的所有层，或者直到找到一个 <code>put record</code> 为止（更频繁的合并能缓解这个影响）。</p>
<h3 id="优化删除"><a class="markdownIt-Anchor" href="#优化删除"></a> 优化删除</h3>
<p>删除往往是 <code>LSM</code> 树中被忽略的一个操作。<code>RocksDB</code> 中无法直接删除键值对，删除操作本质上是插入一条标记删除的记录，这使得删除操作很快，但后续对该键的查询有可能变慢。在执行合并操作时，如果遇到标记删除的键值对，并不能直接将其物理删除，因为无法保证该键值对是否还存在于更深层的 <code>SSTable</code> 中。因此，<code>RocksDB</code> 针对删除场景也做了一些优化。</p>
<blockquote>
<p>假设应用对同一个键依次执行了三次操作：<code>put()</code>，<code>delete()</code>，<code>put()</code>，前两个操作属于 <code>MemTable1</code>，后一个操作属于 <code>MemTable2</code>，之后刷盘成 <code>SSTable1</code> 和 <code>SSTable2</code>。因为合并操作只是选取一部分 <code>SSTable</code>，所以有可能 <code>SSTable2</code> 先合并到了更深层。</p>
</blockquote>
<h4 id="支持对大范围标记删除的数据范围扫描"><a class="markdownIt-Anchor" href="#支持对大范围标记删除的数据范围扫描"></a> 支持对大范围标记删除的数据范围扫描</h4>
<p>应用经常会大批量删除连续或者临近的键，在这种场景下，调用 <code>scan()</code> 遍历每个键时就会遇到一堆已被标记删除的数据需要被跳过，从而浪费 <code>CPU</code> 和 <code>I/O</code> 资源。例如，某个应用可能用 <code>RocksDB</code> 保存文件系统中每个文件的绝对路径，而如果删除了文件夹则会导致一大批键被删除。再例如，使用 <code>RocksDB</code> 模拟队列时，每个出队的元素都会被删除，那么队首的元素则天然的挨着一批被删除的元素。遍历这些被删除的键一方面加重了资源负担，另一方面对查询结果也没有影响。在极端情况下，<code>RocksDB</code> 的开发团队在实践中遇到扫描了几百万个标记删除的键，最终只为了返回几个键值对。</p>
<p>一种解决思路是当出现大量连续标记删除的键时，触发合并操作。<code>RocksDB</code> 提供了几个功能：</p>
<ol>
<li>当标记删除的键占所有键之比超过50%时，合并会更积极的发生，并且随着标记删除的键占比增加而更频繁。不过，不能很好的处理标记删除的键占比不超过50%的情况</li>
<li>允许应用自己标记哪些 <code>SSTable</code> 需要执行合并。在执行合并生成新的 <code>SSTable</code> 时，<code>RocksDB</code> 提供了插件机制能够访问每个被处理的键值对，当新的 <code>SSTable</code> 创建后，<code>RocksDB</code> 会调用该插件从而判断是否需要将该 <code>SSTable</code> 放入下次的合并操作中。<code>RocksDB</code> 的统计信息中也包含了一次查询涉及了多少个标记删除的键，从而辅助应用更好的判断是否需要发起合并</li>
<li>执行 <code>scan()</code> 操作时，如果遇到了指定数量的标记删除的键，则提前中止遍历。当然，这样做的结果就是返回的数据不全，不过应用就能知道遇到了大量被标记删除的键，需要应用自行决定是否需要继续扫描还是放弃</li>
</ol>
<p>上述措施一定程度上能缓解前述的问题，不过依然有局限性：</p>
<ul>
<li>合并需要时间，在这期间 <code>scan()</code> 的性能依然受限</li>
<li>更频繁的合并意味着更大的写放大，这对于某些应用来说是不可接受的</li>
</ul>
<p>目前，这方面的优化工作仍然在进行中。</p>
<h4 id="回收磁盘空间"><a class="markdownIt-Anchor" href="#回收磁盘空间"></a> 回收磁盘空间</h4>
<p>一般来说，如果数据被删除了，那么其所占用的磁盘空间也应当被释放。不过在 <code>RocksDB</code> 中数据不是立即删除，需要等待一段时间，而应用可能会要求在指定的时间内就需要释放磁盘空间。因此，<code>RocksDB</code> 提供了一个功能保证在指定时间内所有被标记删除的键都会移动到 <code>LSM</code> 树的最后一层，那么这些数据在随后的合并中就可以被清理。<code>RocksDB</code> 通过在 <code>SSTable</code> 的元数据中维护每个键首次添加到系统中的时间来实现该功能。</p>
<h4 id="文件删除限流"><a class="markdownIt-Anchor" href="#文件删除限流"></a> 文件删除限流</h4>
<p><code>RocksDB</code> 一般构建于能够感知 <code>SSD</code> （<code>flash-SSD-aware</code>）的文件系统之上，当某个文件被删除时，它会发送一个 <code>TRIM</code> 命令给 <code>SSD</code>。<code>TRIM</code> 的性能较好且对于 <code>SSD</code> 的寿命影响较小。不过，它可能会造成其他的性能问题：除了更新地址映射（大多数位于 <code>SSD</code> 的内部内存中）之外，<code>SSD</code> 固件还需要将这些变更作为 <code>FTL</code> 日志写到闪存上，这又会触发 <code>SSD</code> 内部的垃圾回收，从而造成大量的数据迁移，并最终影响上层应用的 <code>I/O</code> 延迟。所以，<code>RocksDB</code> 增加了文件删除的限流来控制同一时刻删除的文件个数。</p>
<h3 id="内存管理"><a class="markdownIt-Anchor" href="#内存管理"></a> 内存管理</h3>
<p><code>RocksDB</code> 对于内存的使用主要在于 <code>SSTable</code> 的 <code>block cache</code> 以及保存 <code>MemTable</code>。相比于其他数据库自己维护缓冲池，<code>RocksDB</code> 则依托于 <code>jemalloc</code> 进行内存分配。</p>
<p>尽管块的大小是可配置的，<code>RocksDB</code> 的实际实现则是采用变长的块，不过其大小会尽可能的接近所配置的值。例如，如果某个键值对的大小超过了指定的块大小，那么 <code>RocksDB</code> 会为其创建较大的块。类似的，如果某个块中已经存在一部分键值对，而此时再放入一个键值对就会超过块的大小时，则该键值对不会被放入该块中，并且 <code>RocksDB</code> 会选择一个较小的块来存放原来的那批键值对。另外，<code>SSTable</code> 的索引块和布隆过滤器的块大小也没有采用固定大小。出于这么做的原因是因为 <code>RocksDB</code> 采用的数据结构不支持就地更新，采用固定大小的块收益不大。</p>
<p>不过，在实践中，借助 <code>jemalloc</code> 来管理内存在分配和回收时都存在不可忽视的开销，其外部的内存碎片和元数据带来的额外内存开销也值得应用注意。这种情况下应用开发者可以选择换一个内存分配器，或者对 <code>jemalloc</code> 进行调优。</p>
<p>另外，<code>RocksDB</code> 的用户也经常对如何高效的调优内存参数感到迷茫。<code>RocksDB</code> 能够精确限制 <code>block cache</code> 和 <code>MemTable</code> 的内存参数，但是对 <code>jemalloc</code> 的外部内存碎片和元数据无法掌控，所以用户需要自行判断应该给这部分预留多少内存。因此，实验是检验真理的唯一标准。</p>
<p>尽管如此，<code>RocksDB</code> 的开发团队认为使用 <code>jemalloc</code> 仍然是一个合理的决定，因为可以将精力放到其他更重要的方面上。不过未来可能也会将这个内存管理问题提上日程。</p>
<h2 id="key-value-接口设计的经验教训"><a class="markdownIt-Anchor" href="#key-value-接口设计的经验教训"></a> Key-Value 接口设计的经验教训</h2>
<p><code>RocksDB</code> 的核心接口就四个：</p>
<ul>
<li><code>put()</code></li>
<li><code>delete()</code></li>
<li><code>get()</code></li>
<li><code>iterators (scans)</code></li>
</ul>
<p>很少有应用无法基于这四个接口实现需要的功能，<code>KV</code> 接口的键和值都是变长的字节数组，因此应用程序可以很自由的存储想要的数据，只需要做好序列化和反序列化。另外一个好处是可移植性，应用可以轻易的从一个 <code>KV</code> 系统迁移到另一个。</p>
<p>不过，天下没有完美的事物，部分应用的性能反而会受限于这精简的接口。例如，在 <code>RocksDB</code> 之外处理并发控制就很难做的高效，尤其是两阶段提交场景下需要在事务提交前先持久化一部分数据的场景。因此，<code>RocksDB</code> 增加了事务的功能，并持续添加新的功能，例如对某个范围内的数据加锁，以及支持大事务。</p>
<p>在其他场景下，应用则受限于过于精简的接口，为此 <code>RocksDB</code> 增加了两项扩展：</p>
<ul>
<li>由应用定义的时间戳</li>
<li>列支持</li>
</ul>
<h3 id="版本和时间戳"><a class="markdownIt-Anchor" href="#版本和时间戳"></a> 版本和时间戳</h3>
<p>为了支持诸如 <code>multi-version concurrency control (MVCC)</code> 和从历史某个时间点读取（<code>point-in-time reads</code>）的功能，<code>RocksDB</code> 需要能够支持数据的版本管理，并能高效的访问各个版本。</p>
<p>目前，<code>RocksDB</code> 内部使用一个56位长度的序列号来标识键值对的每个版本。客户端的每一次写请求都会对版本号加1，不过客户端无法直接修改这个版本号。<code>RocksDB</code> 允许应用对其执行快照，<code>RocksDB</code> 保证只要这个快照没有被应用释放，那么在这个快照执行的时间点时的数据就都能始终被访问。</p>
<p>不过，对很多应用来说这依然不够，为了读取历史上的数据，前提是应用必须先曾经做过快照，<code>RocksDB</code> 不支持在当前时间对历史的某个时间点执行快照，因为根本没有这样的接口。另外，<code>RocksDB</code> 的版本号是每个实例各自维护，快照也是各实例粒度。因此，对于多 <code>shard</code> 的应用来说，很难对所有节点同时做一致的快照。</p>
<p>虽然应用可以将时间戳写入到键或者值中，不过这会影响应用的性能。如果将时间戳写入到键中，则点查询的性能会很差，因为实际保存的键和用户查询的键已经不同，需要做前缀扫描遍历；如果将时间戳写入到值中，则会影响对同一个键乱序写入的性能，因为乱序写入时如果不考虑相互间的时间戳顺序则有可能发生数据覆盖，并且读取旧版本的数据也变得复杂。因此，<code>RocksDB</code> 需要提供在键值之外由应用自行指定时间戳的能力。</p>
<p>经过实验，由应用指定时间戳的情况下，<code>RocksDB</code> 相比于将时间戳写入到键的方案有1.2倍的吞吐提升。提升的原因在于：</p>
<ul>
<li>时间戳是键值对元数据的一部分，因此点查询依然高效</li>
<li>布隆过滤器可以继续发挥作用</li>
<li>每个 <code>SSTable</code> 在元数据中同时也维护了所有键所覆盖的时间戳范围，因此在搜索时有可能直接忽略整个 <code>SSTable</code></li>
</ul>
<p>当然缺点就是磁盘使用空间会变大以及移植性变差。</p>
<h3 id="列支持"><a class="markdownIt-Anchor" href="#列支持"></a> 列支持</h3>
<p>一些基于 <code>SQL</code> 的数据库实现会以列的形式组织 <code>RocksDB</code> 的数据，虽然应用可以将数据库中一整行的数据以单条 <code>KV</code> 的形式保存在 <code>RocksDB</code>，但是如果能直接在 <code>RocksDB</code> 层面支持列则对应用的性能提升有很大帮助。</p>
<p>假设有些大对象的某些列更新非常频繁，那么在整行数据保存的方案下更新就非常不高效。如果支持列，则只需要更新部分列。另外，如果数据库的某个查询也只涉及部分列，那么也不必读取完整的一行数据。</p>
<p>某些应用已经尝试对上述的问题进行优化。例如 <code>Rocksandra</code> 借助 <code>merge operator</code> 来进行部分列的更新，不过代价就是读性能较差，因为需要读完所有的 <code>merge record</code> 或者遇到一个 <code>put record</code> 才能知道最终的结果。另一种方案是将一行数据的每一列保存为一个键值对，缺点在于：</p>
<ol>
<li>读取一行数据需要进行范围扫描（比如所有的列数据的键都以主键为前缀）</li>
<li>删除和更新一整行数据变得困难</li>
</ol>
<p>因此，如果能在 <code>RocksDB</code> 层面直接支持列，则能大大提高应用的性能：</p>
<ol>
<li>更新和读取单列的数据变得高效</li>
<li>当应用发起针对某些列的过滤查询时，某些过滤条件可以下推到 <code>SSTable</code></li>
<li>某些列可以用不同配置的 <code>column family</code> 保存</li>
<li>可以像列数据库一样高效压缩保存列数据</li>
</ol>
<p>另外，支持列也能够让 <code>RocksDB</code> 在主键索引和二级索引间校验数据完整性。</p>
<h2 id="来自失败的提案的经验总结"><a class="markdownIt-Anchor" href="#来自失败的提案的经验总结"></a> 来自失败的提案的经验总结</h2>
<p>一路走来，<code>RocksDB</code> 实现了很多的功能，其中也有些失败的案例。</p>
<h3 id="支持基于-dram-的存储设备"><a class="markdownIt-Anchor" href="#支持基于-dram-的存储设备"></a> 支持基于 DRAM 的存储设备</h3>
<p>在2014年，<code>RocksDB</code> 的开发团队决定将 <code>RocksDB</code> 适配到 <code>Ramfs</code> （<code>RAM File System</code>）上，从而有比 <code>SSD</code> 更低的访问延迟。为此，<code>RocksDB</code> 将 <code>SSTable</code> 和 <code>MemTable</code> 的格式改为插件式，从而针对 <code>Ramfs</code> 进行了特定的优化。</p>
<p>这个结果本身是成功的并且也应用到了某些服务上。不过，在战略上来说这个功能提的太早了。对于大型纯内存式的持久化存储系统来说，<code>RocksDB</code> 的这套方案并未像预期的那样获得关注。而对于内存式的应用来说，一般也不会考虑集成 <code>RocksDB</code>，因为完全直接自己操作内存来的更快和便捷。</p>
<h3 id="支持混合式存储设备"><a class="markdownIt-Anchor" href="#支持混合式存储设备"></a> 支持混合式存储设备</h3>
<p><code>SSD</code> 比 <code>HDD</code> 更快，不过也更贵而且寿命也有限。因此，如果能结合 <code>SSD</code> 和 <code>HDD</code> 一起使用，那么对于大多数的应用来说可以在性能和成本之间做到更好的平衡。同样是在2014年，<code>RocksDB</code> 支持能将 <code>LSM</code> 树的不同层保存到不同的存储设备上。</p>
<p>不过，在该功能推出的时候用户并没有买账。另一方面，在实践中将 <code>SSD</code> 和 <code>HDD</code> 同时配置到一个节点上的情况也比较罕见，<code>RocksDB</code> 的开发团队认为混合存储方案的潮流应该对远程存储服务更有吸引力，而这要到2018年才开始着手。不过，最近<code>RocksDB</code> 的开发团队又重拾了混合式存储项目，因为要支持混合式的本地/远程存储服务，不过依然还有额外的工作要做。</p>
<h3 id="更丰富高层次的接口"><a class="markdownIt-Anchor" href="#更丰富高层次的接口"></a> 更丰富，高层次的接口</h3>
<p><code>RocksDB</code> 最开始支持的是传统的 <code>KV</code> 接口，不过，在过去的几年中也尝试过扩展支持更为丰富的接口，从而更方便某些应用使用。例如，在2013年 <code>RocksDB</code> 添加了类似于 <code>Redis</code> 的 <code>lists</code> 的接口；在2014年添加了2个与空间相关的接口；在2015年支持了文档类型的数据。所有这些接口都基于核心的 <code>KV</code> 接口实现。</p>
<p>但是，这些接口同样没有被广泛采纳，并最终废弃和移除。因此，对于 <code>RocksDB</code> 的开发团队来说，将精力放在核心功能上更有价值。大部分 <code>RocksDB</code> 的用户都能借助简单的 <code>KV</code> 接口构建更为丰富的上层接口，而不需要由 <code>RocksDB</code> 来提供。用户的首要痛点在于效率和易管理性。总结来说，扩展核心接口的前提在于能够显著提升性能。</p>
<h2 id="附录"><a class="markdownIt-Anchor" href="#附录"></a> 附录</h2>
<h3 id="经验总结"><a class="markdownIt-Anchor" href="#经验总结"></a> 经验总结</h3>
<ol>
<li>对于存储引擎来说，能够调优适配不同的工作场景至关重要</li>
<li>大多数使用 <code>SSD</code> 的应用的瓶颈在于空间效率</li>
<li>降低 <code>CPU</code> 开销对系统的高效运行越来越重要</li>
<li>如果一台机器上运行了多个 <code>RocksDB</code> 的实例，那么全局的资源管理就是必须的</li>
<li><code>WAL</code> 的可配置性（同步刷盘写 <code>WAL</code>；先将 <code>WAL</code> 写入到缓冲区，然后定期刷盘；无 <code>WAL</code>）能够给上层应用带来性能提升</li>
<li>需要正确的支持数据副本和备份</li>
<li><code>RocksDB</code> 需要对数据和配置文件提供后向和前向兼容</li>
<li>越早识别数据损坏越好，而不是在最后检测</li>
<li>完整性保护必须能够覆盖整个系统来避免数据损坏（例如，由 <code>CPU</code> 或内存引起的 <code>bitflip</code>）扩散给客户端或者其他副本；只在数据空闲时或者传输时进行损坏检测是不够的</li>
<li>错误处理需要能够根据类别和严重性分别处理</li>
<li>即使概率很低，<code>CPU</code> 和内存造成数据损坏也有可能发生，因此数据副本并不一定总是能解决这种情况</li>
<li>自适应的配置对简化配置管理大有益处</li>
<li>可以通过用户自定的回调函数来提升性能，不过当前的技术方案仍有进步的空间</li>
<li>在 <code>LSM</code> 树中删除连续的键会带来性能问题</li>
<li><code>SSD</code> 的 <code>TRIM</code> 对性能大有帮助，不过需要对文件删除作限流来避免偶发的性能问题</li>
<li>借助第三方内存分配器来管理内存使得开发团队能将精力放在其他重要的功能上，不过缺点是带来了可管理性问题</li>
<li>目前的 <code>KV</code> 接口已足够有用，不过对于某些应用场景来说可能会有性能问题；在键值之外添加时间戳能够在性能和简洁性上达到较好的平衡</li>
<li>应用可以在 <code>RocksDB</code> 提供的 <code>KV</code> 接口之上实现列数据并且有着较好的性能，不过如果存储引擎本身支持列则会有更好的性能</li>
</ol>
<h3 id="设计抉择回顾"><a class="markdownIt-Anchor" href="#设计抉择回顾"></a> 设计抉择回顾</h3>
<ol>
<li>可定制化对用户始终有用：结果就是用户迷失在大量的配置里，而且很难找到最优的配置</li>
<li><code>RocksDB</code> 无法感知 <code>CPU</code> 的 <code>bitflip</code>：完整性保护需要端到端覆盖</li>
<li>遇到任何 <code>I/O</code> 错误时可以直接中断操作：过于粗暴，所以需要根据错误的类别和严重性做不同的处理</li>
</ol>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://research.facebook.com/publications/rocksdb-evolution-of-development-priorities-in-a-key-value-store-serving-large-scale-applications/">RocksDB: Evolution of Development Priorities in a Key-value Store Serving Large-scale Applications</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Write_amplification">Write amplification</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/01/28/how-to-read-a-paper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/01/28/how-to-read-a-paper/" class="post-title-link" itemprop="url">【读】How to Read a Paper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-01-28 00:00:00" itemprop="dateCreated datePublished" datetime="2025-01-28T00:00:00+08:00">2025-01-28</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>965</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p>本文提出了一种高效阅读文献的方式，相比于一上来就从头读到尾，作者将其拆解为三趟式阅读：</p>
<ol>
<li>第一遍了解论文讲什么，解决了什么问题，提出了什么方法</li>
<li>第二遍理解论文的内容，但忽略细节</li>
<li>第三遍深入理解论文</li>
</ol>
<h2 id="第一遍阅读"><a class="markdownIt-Anchor" href="#第一遍阅读"></a> 第一遍阅读</h2>
<p>第一遍阅读建议控制在5到10分钟内，阅读内容包括：</p>
<ol>
<li>仔细阅读标题，摘要和简介部分</li>
<li>阅读每一节和每小节的标题，但忽略内容</li>
<li>阅读结论部分</li>
<li>扫一遍论文引用，并标记哪些已经读过</li>
</ol>
<p>第一遍读完后，你应该能够回答5个问题：</p>
<ol>
<li>Category：这是一篇什么类型的论文？</li>
<li>Context：有哪些其他相关的论文？</li>
<li>Correctness：论文中的假设对吗？</li>
<li>Contributions：这篇论文的主要贡献是什么？</li>
<li>Clarity：这篇论文写的清晰易懂吗？</li>
</ol>
<p>当回答了这5个问题后，你就可以决定是否要继续读下去，不继续读的原因可能是因为这篇论文对你价值不大，也可能是因为你还没有足够的知识储备来理解，甚至是论文中描述的假设都是错的。</p>
<h2 id="第二遍阅读"><a class="markdownIt-Anchor" href="#第二遍阅读"></a> 第二遍阅读</h2>
<p>第二遍开始仔细阅读论文，但忽略细节比如证明环节：</p>
<ol>
<li>仔细阅读论文中的图表，尤其是图片。一些图表中的常见错误可以提前让你甄别出不严谨甚至是粗制滥造的论文</li>
<li>标记还没有读过的相关论文引用以便之后阅读，这有助于更好理解该篇论文的背景</li>
</ol>
<p>第二遍阅读应该控制在1小时以内，通过第二遍阅读，你应该能够理解论文的内容，并能够自我总结论文的要旨给第三者。这个层次的掌握程度对于阅读感兴趣的论文已经足够，但用于科研工作还不够。</p>
<p>如果第二遍读完还不能理解怎么办？这有可能是因为论文的主题对你来说是一个新事物，也可能是因为论文的作者采用的证明让你摸不着头脑，或者这篇论文就是写的晦涩难懂，甚至是因为夜深了。你可以选择：</p>
<ul>
<li>把论文放一边，即使不理解这篇论文也不影响你事业的成功</li>
<li>之后再看，先补充点背景材料</li>
<li>硬着头皮开始第三遍阅读</li>
</ul>
<h2 id="第三遍阅读"><a class="markdownIt-Anchor" href="#第三遍阅读"></a> 第三遍阅读</h2>
<p>第三遍阅读能让你真正的理解这篇论文。这次阅读的关键是假设自己是论文的作者，并且基于原作者的假设，重新构建论文。通过你所构建的论文和原论文对比，你就能轻易的发现原论文的创新点，以及潜在隐藏的缺点和假设。</p>
<p>第三遍阅读需要高度关注细节，并时刻本着以怀疑的态度看待论文中的每一个假设。通过这次阅读，也能够为你之后的科研工作提供一些想法。</p>
<p>对于新手来说第三遍阅读大概要花4到5个小时，而对于有经验的读者来说只需要1小时。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://web.stanford.edu/class/ee384m/Handouts/HowtoReadPaper.pdf">How to Read a Paper</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/01/05/bitcask/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/01/05/bitcask/" class="post-title-link" itemprop="url">【读】Bitcask - A Log-Structured Hash Table for Fast Key/Value Data</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-01-05 00:00:00" itemprop="dateCreated datePublished" datetime="2025-01-05T00:00:00+08:00">2025-01-05</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p><code>Bitcask</code> 是一个单机 <code>KV</code> 存储引擎，项目起因于 <code>Riak</code> 分布式 <code>KV</code> 数据库需要一个能满足以下条件的单机 <code>KV</code> 存储引擎：</p>
<ul>
<li>低延迟的单条读写</li>
<li>高吞吐，尤其是面对流式随机 <code>KV</code> 写入</li>
<li>能支持远比内存大的数据量</li>
<li>能从崩溃中快速恢复以及不丢失数据</li>
<li>能轻松的备份和还原数据</li>
<li>相对简单，易理解的代码结构和数据格式</li>
<li>在高负载和大数据场景下系统的行为是可预期的</li>
<li>软件的许可证要能轻易的适配 <code>Riak</code> 使用</li>
</ul>
<p>作者看了一圈发现市面上还没有一款 <code>KV</code> 存储能全部满足这些条件，因此 <code>Bitcask</code> 就应运而生。</p>
<h2 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h2>
<p><code>Bitcask</code> 的接口非常精简：</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>bitcask:open(DirectoryName, Opts) -&gt; BitCaskHandle | {error, any()}</td>
<td>在指定目录下以指定选项打开或新建一个 <code>Bitcask</code> 实例。支持的选项包括 <code>read_write</code> 或者 <code>sync_on_put</code>：<ul><li><code>read_write</code>：可读可写</li><li><code>sync_on_put</code>：每次写操作后刷盘</li></ul> 连接的进程需要有 <code>DirectoryName</code> 对应目录的读写权限，同时一个时刻只能有一个进程以 <code>read_write</code> 的方式打开 <code>Bitcask</code> 实例。</td>
</tr>
<tr>
<td>bitcask:open(DirectoryName) -&gt; BitCaskHandle | {error, any()}</td>
<td>在指定目录下以只读模式打开或新建一个 <code>Bitcask</code> 实例。连接的进程需要有 <code>DirectoryName</code> 对应目录及其内部所有文件的读权限。</td>
</tr>
<tr>
<td>bitcask:get(BitCaskHandle, Key) -&gt; not_found | {ok, Value}</td>
<td>获取指定键对应的值。</td>
</tr>
<tr>
<td>bitcask:put(BitCaskHandle, Key, Value) -&gt; ok | {error, any()}</td>
<td>插入一个键值对。</td>
</tr>
<tr>
<td>bitcask:delete(BitCaskHandle, Key) -&gt; ok | {error, any()}</td>
<td>删除指定键。</td>
</tr>
<tr>
<td>bitcask:list_keys(BitCaskHandle) -&gt; [Key] | {error, any()}</td>
<td>返回所有的键。</td>
</tr>
<tr>
<td>bitcask:fold(BitCaskHandle, Fun, Acc0) -&gt; Acc</td>
<td>对每一个键值对应用 <code>Fun</code> 函数，<code>Fun</code> 的函数签名为 <code>F(K, V, Acc0) -&gt; Acc</code>。类似于 <code>JavaScript</code> 的 <code>reduce</code>。</td>
</tr>
<tr>
<td>bitcask:merge(DirectoryName) -&gt; ok | {error, any()}</td>
<td>合并目录下的数据文件以减少重复的键值对。同时生成 <code>hintfile</code> 辅助加速程序启动时间。</td>
</tr>
<tr>
<td>bitcask:sync(BitCaskHandle) -&gt; ok</td>
<td>强制刷盘。</td>
</tr>
<tr>
<td>bitcask:close(BitCaskHandle) -&gt; ok</td>
<td>关闭 <code>Bitcask</code> 实例的连接并刷盘。</td>
</tr>
</tbody>
</table>
<h2 id="存储"><a class="markdownIt-Anchor" href="#存储"></a> 存储</h2>
<h3 id="文件组织"><a class="markdownIt-Anchor" href="#文件组织"></a> 文件组织</h3>
<p><code>Bitcask</code> 的文件组织非常简单，任意时刻目录下最多只有一个 <code>active data file</code> 接收写操作，其余都是不可修改的历史数据文件。任意时刻 <code>Bitcask</code> 只允许一个进程以写模式建立连接，写入进程只会向 <code>active data file</code> 写入，当其大小超过指定阈值后就会关闭当前文件，然后新建一个 <code>active data file</code>。</p>
<p><img src="/images/bitcask-1.png" alt="alt" /></p>
<h3 id="数据格式"><a class="markdownIt-Anchor" href="#数据格式"></a> 数据格式</h3>
<p>写入进程以追加写的方式写入 <code>active data file</code>，从而避免了随机写的磁盘寻址，其写入数据格式如下：</p>
<p><img src="/images/bitcask-2.png" alt="alt" /></p>
<ul>
<li><code>crc</code>：循环冗余校验码，验证数据完整性</li>
<li><code>tstamp</code>：32位整型本地时间戳，仅内部使用，不对外暴露</li>
<li><code>ksz</code>：键的长度</li>
<li><code>value_sz</code>：值的长度</li>
<li><code>key</code>：键的内容</li>
<li><code>value</code>：值的内容</li>
</ul>
<p>对于每一条记录，前面四个部分都是定长，以此为基址 <code>base</code>，则 <code>base</code> 到 <code>base + ksz</code> 就是键的内容，<code>base + ksz</code> 到 <code>base + ksz + value_sz</code> 就是值的内容。</p>
<p>如果要删除指定的键，<code>Bitcask</code> 会再次追加写入一个键值对，只不过写入的值是一个特殊值，程序后续读到这条记录时比较值的内容就可以判断该条记录是否已被删除。所以，<code>Bitcask</code> 每个文件内容就是一行行的记录：</p>
<p><img src="/images/bitcask-3.png" alt="alt" /></p>
<h2 id="读写"><a class="markdownIt-Anchor" href="#读写"></a> 读写</h2>
<h3 id="写"><a class="markdownIt-Anchor" href="#写"></a> 写</h3>
<p><code>Bitcask</code> 写入的同时会在内存中维护写入的键到数据文件的映射（<code>keydir</code>）：<br />
<img src="/images/bitcask-4.png" alt="alt" /></p>
<p>其中 <code>file_id</code> 能够定位具体的数据文件，<code>value_pos</code> 是该条记录的值在文件中的起始偏移位置，那么 <code>value_pos</code> 到 <code>value_pos + value_sz</code> 就是值的内容。因为 <code>Bitcask</code> 每次写数据的长度是可知的，值在每条记录中的偏移量可知，写之前 <code>active data file</code> 文件总长也可知，所以 <code>value_pos</code> 也能够推算出来。</p>
<p>对于重复写入的键值对，磁盘上会存在同一个键的多条记录，但是 <code>keydir</code> 中始终只保留最新的映射。</p>
<h3 id="读"><a class="markdownIt-Anchor" href="#读"></a> 读</h3>
<p>读取时先根据键查询 <code>keydir</code> 得到数据文件的映射，然后根据 <code>file_id</code> 定位数据文件，最后根据 <code>value_pos</code> 和 <code>value_sz</code> 返回值的内容，整个读取只涉及一次磁盘寻址。另一方面，文件系统的 <code>read-ahead</code> 缓存会进一步减少磁盘的交互：</p>
<p><img src="/images/bitcask-5.png" alt="alt" /></p>
<h2 id="数据合并"><a class="markdownIt-Anchor" href="#数据合并"></a> 数据合并</h2>
<p>由于 <code>Bitcask</code> 追加写的特性，有两种类型的数据是冗余的：</p>
<ul>
<li>被标记删除的数据</li>
<li>同一个键的旧版本的数据</li>
</ul>
<p>所以，为了避免磁盘空间的浪费，需要额外的数据合并操作对磁盘上的数据瘦身。数据合并只处理只读的数据文件，遍历剔除掉已删除和旧版本的数据。另外，每一个合并后的数据文件同时额外有一个对应的 <code>hint file</code>：</p>
<p><img src="/images/bitcask-6.png" alt="alt" /></p>
<p><code>hint file</code> 也是行记录的文件，每一行存储了：</p>
<ul>
<li><code>tstamp</code>：时间戳</li>
<li><code>ksz</code>：键的长度</li>
<li><code>value_sz</code>：值的长度</li>
<li><code>value_pos</code>：值在数据文件中的起始地址偏移量</li>
<li><code>key</code>：键</li>
</ul>
<p>当程序启动时，如果 <code>hint file</code> 存在，那么就可以直接扫描 <code>hint file</code> 构建 <code>keydir</code> 从而加速程序启动；反之，则要扫描数据文件。</p>
<h2 id="性能数据"><a class="markdownIt-Anchor" href="#性能数据"></a> 性能数据</h2>
<p>原文并没有给出非常正规的测试报告，仅列出了一些早期未优化的测试数据：</p>
<ul>
<li>读写延迟：毫秒内</li>
<li>写吞吐：5000~6000次/秒</li>
<li>内存占用：几百万的键在 <code>1GB</code> 内（<code>keydir</code> 需要）</li>
</ul>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p><code>Bitcask</code> 的整体设计思路非常简单，其设计目的也不是为了成为最快的 <code>KV</code> 存储，而是最适合 <code>Riak</code> 的存储引擎，在足够快的同时有着高质量、简洁的代码，设计和数据格式。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://riak.com/assets/bitcask-intro.pdf">Bitcask - A Log-Structured Hash Table for Fast Key/Value Data</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/01/04/gnu-what-is-free-software/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/01/04/gnu-what-is-free-software/" class="post-title-link" itemprop="url">GNU - 什么是自由的软件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-01-04 00:00:00" itemprop="dateCreated datePublished" datetime="2025-01-04T00:00:00+08:00">2025-01-04</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="定义"><a class="markdownIt-Anchor" href="#定义"></a> 定义</h2>
<p>自由的软件的定义四要素：</p>
<ul>
<li>以任何意愿，目的运行软件的自由</li>
<li>学习软件运行原理的自由，并且能按自主意愿修改（前提还需要能自由访问源代码）</li>
<li>将软件的副本再次分发给其他人的自由</li>
<li>将修改后的软件的副本分发给其他人的自由</li>
</ul>
<p>一个软件只有具备了上述四点才是自由的软件。</p>
<p>不过，自由的软件不表示不能商用，相反，GNU 鼓励并且认为商用是自由软件社区成功的重要途径。自由的软件必须能够在商业上使用，开发，以及分发。</p>
<h2 id="自由与非自由的边界"><a class="markdownIt-Anchor" href="#自由与非自由的边界"></a> 自由与非自由的边界</h2>
<h3 id="以任何意愿运行软件的自由"><a class="markdownIt-Anchor" href="#以任何意愿运行软件的自由"></a> 以任何意愿运行软件的自由</h3>
<p>任何个人或组织可以在任意计算机系统上，出于任意目的运行软件，而不需要事先和开发者或者其他组织联系。同时，你也可以将软件再分发给其他用户，其他用户也能自由的以他们自己的意愿去运行软件而不受你的约束。</p>
<h3 id="学习软件源代码并修改的自由"><a class="markdownIt-Anchor" href="#学习软件源代码并修改的自由"></a> 学习软件源代码并修改的自由</h3>
<p>自由的获取软件的源代码是能够自由修改软件和再分发的前提，不过，经过代码混淆工具处理过的代码不算是源代码。</p>
<p>同时，如果对修改软件有限制，那么该软件也不算是自由的软件，例如：</p>
<ul>
<li>某软件引用了修改后的软件 A，但不允许将其替换为你自己修改的版本</li>
<li>要求你成为所修改的代码的版权拥有者</li>
<li>只能做出其他人认为是改进的修改</li>
</ul>
<h3 id="软件再分发的自由"><a class="markdownIt-Anchor" href="#软件再分发的自由"></a> 软件再分发的自由</h3>
<p>你可以自由的再分发未修改或修改后的软件副本给任何人，即使是收费。同时，你也可以自由的修改软件然后私用，而不需要让其他任何人知道；如果你将修改后的软件再分发，也不需要以任何形式知会任何人。</p>
<p>自由再分发的软件副本必须包含可执行文件，以及修改和未修改的源代码。不过有些软件可能（暂时）无法生成可执行的文件，但是依然要保留能够再分发可执行文件的自由。</p>
<h3 id="copyleft"><a class="markdownIt-Anchor" href="#copyleft"></a> Copyleft</h3>
<p>版权的单词是 <code>copyright</code>，<code>copyleft</code> 与之对应。它要求所修改和扩展的软件都必须依然保留自由软件的四要素（而不仅仅是免费），<code>GNU</code> 自己的项目就使用符合 <code>copyleft</code> 的许可证来保证软件的自由。不过，这里并不是说所有自由的软件都必须用 <code>copyleft</code> 许可证，不然也违背了自由一词。</p>
<h3 id="软件分发的约束"><a class="markdownIt-Anchor" href="#软件分发的约束"></a> 软件分发的约束</h3>
<p>只要不限制分发修改后的软件的自由，不限制私用修改后的软件，对软件分发做一定程度的约束是可接受的。例如，要求给修改后的软件换个名字，删除原有软件的 <code>logo</code>，或者声明修改为你所有。</p>
<h3 id="出口规定"><a class="markdownIt-Anchor" href="#出口规定"></a> 出口规定</h3>
<p>有时候政府的出口管制会限制你在国际上分发软件的自由。虽然身为开发人员无法对抗这些规定，但是你可以做也必须做的是，不添加这些法律条文作为软件的使用条件。</p>
<h3 id="合规考虑"><a class="markdownIt-Anchor" href="#合规考虑"></a> 合规考虑</h3>
<p>如果软件的用户没有做任何不合规的事，那么软件的开发人员不能随意的撤销软件的许可证，或添加使用限制，否则这就不是自由的软件。</p>
<h3 id="基于合约的许可证"><a class="markdownIt-Anchor" href="#基于合约的许可证"></a> 基于合约的许可证</h3>
<p>有些基于合约的许可证会引入较多的使用限制，从而可能违背自由软件的四要素，因此这类许可证不被认为是自由的许可证。例如某些免费的软件许可证会规定允许被安装的设备的数量，以及限制分享给他人使用。</p>
<h2 id="软件之外"><a class="markdownIt-Anchor" href="#软件之外"></a> 软件之外</h2>
<p>软件的使用手册也必须是自由的，因为手册也是软件的一部分。再扩展一步，自由不仅仅是用在软件上，任何能够以数字形式呈现的产物都可以是自由的。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/philosophy/free-sw.html">What is Free Software?</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/licenses/copyleft.html">What is Copyleft?</a></li>
<li><a target="_blank" rel="noopener" href="https://freedomdefined.org/Definition">Free Cultural Works</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/01/01/top-10-games/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/01/01/top-10-games/" class="post-title-link" itemprop="url">个人向最喜欢的十款单机游戏</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2025-01-01T00:00:00+08:00">2025-01-01</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>817</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>豆瓣个人评分标准：</p>
<ul>
<li>五星：一见钟情，简直停不下来，必然多周目起步</li>
<li>四星：依然优秀，但是相比五星存在无法忽略的缺点，可能会多周目</li>
<li>三星：没什么吸引人的地方，大部分能坚持到一周目结束，基本不会多周目</li>
<li>二星：肉眼可见的烂，中途就弃</li>
<li>一星：还没遇到过</li>
</ul>
<p>以下是个人向五星里最喜欢的十款单机游戏，重剧情、代入感，轻玩法、动作，按接触时间倒序。</p>
<h2 id="赛博朋克2077"><a class="markdownIt-Anchor" href="#赛博朋克2077"></a> 赛博朋克2077</h2>
<p>一开始被蠢驴泼天的 bug 劝退了，一直没有上手。不过，看到 DLC 往日之影发售之后大受好评，而且据说2.0版本相比初版已改进不少，遂抱着试试看的心理购入，最终真香，依然吃蠢驴这套。遗憾的是支线的量不够多，意犹未尽。</p>
<h2 id="上古卷轴5"><a class="markdownIt-Anchor" href="#上古卷轴5"></a> 上古卷轴5</h2>
<p>2024年才接触老滚5，而且还没装 Mod，玩了200小时之后依然觉得还有200小时的内容在等待发掘。个人认为老滚5和荒野之息体现了做开放世界的两个赛道，在老滚5里我能停下来和每个人对话，探索世界的动力在于我会遇到什么样的人，会发生什么事。</p>
<h2 id="荒野大镖客2"><a class="markdownIt-Anchor" href="#荒野大镖客2"></a> 荒野大镖客2</h2>
<p>R 星的另一个代表作道德与法治5由于缺少对三个主角的代入感，加上整体枪车戏份过多，玩了一遍后就没有重拾的动力。反而比较适合大表哥2慢悠悠的世界，最终随着结尾曲响起，代入感达到顶峰，仿佛失去了一位朋友。</p>
<h2 id="女神异闻录5"><a class="markdownIt-Anchor" href="#女神异闻录5"></a> 女神异闻录5</h2>
<p>中二的剧情，新奇的 UI，魔性的音乐，不知不觉就过了100小时，并且回合制战斗也不显得枯燥。</p>
<h2 id="巫师3"><a class="markdownIt-Anchor" href="#巫师3"></a> 巫师3</h2>
<p>蠢驴入坑之作，虽然相比老滚5显得并不开放，但丰富的支线加上优秀的音乐让人流连忘返。</p>
<h2 id="最后生还者"><a class="markdownIt-Anchor" href="#最后生还者"></a> 最后生还者</h2>
<p>线性叙事的巅峰，没有一丝冗余，剧情和动作完美结合，无时无刻不在关注下一秒的走向。</p>
<h2 id="空之轨迹"><a class="markdownIt-Anchor" href="#空之轨迹"></a> 空之轨迹</h2>
<p>一首星之所在伴随至今，相比于现在注水冗余的轨迹系列，剧情优秀，人物感情细腻。</p>
<h2 id="三国志11"><a class="markdownIt-Anchor" href="#三国志11"></a> 三国志11</h2>
<p>独特的水墨画风，恰到好处的音乐，相比于即时制更喜欢回合制的操控，能够一直待在电脑里，历史感十足。</p>
<h2 id="太阁立志传5"><a class="markdownIt-Anchor" href="#太阁立志传5"></a> 太阁立志传5</h2>
<p>自由度满分，做一个躺平散养的人，喝茶交友，四处乱逛，没有 KPI。</p>
<h2 id="最终幻想10"><a class="markdownIt-Anchor" href="#最终幻想10"></a> 最终幻想10</h2>
<p>很难想象当初顶着看不懂的日文玩到了最后，惊艳的 CG 和音乐，共情最深的 FF。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2024/12/29/why-python's-integer-division-floors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/12/29/why-python's-integer-division-floors/" class="post-title-link" itemprop="url">为什么 Python 的负整数除法结果和 C 不同</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-12-29 00:00:00" itemprop="dateCreated datePublished" datetime="2024-12-29T00:00:00+08:00">2024-12-29</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>对于整数-5除以2，在 <code>Python</code> 中的结果是-3，但是在 <code>C</code> 中是-2。如果扩展到其他几种常见的语言，可以看到和 <code>C</code> 一致的比较多：</p>
<table>
<thead>
<tr>
<th>语言</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>C</td>
<td>-2</td>
</tr>
<tr>
<td>C++</td>
<td>-2</td>
</tr>
<tr>
<td>Java</td>
<td>-2</td>
</tr>
<tr>
<td>C#</td>
<td>-2</td>
</tr>
<tr>
<td>Rust</td>
<td>-2</td>
</tr>
<tr>
<td>Go</td>
<td>-2</td>
</tr>
<tr>
<td>Python</td>
<td>-3</td>
</tr>
<tr>
<td>Ruby</td>
<td>-3</td>
</tr>
</tbody>
</table>
<p>区别在于对于结果-2.5是选择向0取整还是向负无穷取整，<code>Python</code> 和 <code>Ruby</code> 选择了后者。</p>
<p>对于整数 <code>a</code> 和 <code>n</code>，记 <code>a</code> 除以 <code>n</code> 的结果是 <code>q</code>，余数是 <code>r</code>，则有：<code>a = n * q + r</code>，其中 <code>|r| &lt; |n|</code>。在数论中，<code>r</code> 始终是正数，但是不同的编程语言各自有不同的实现。</p>
<blockquote>
<p>In number theory, the positive remainder is always chosen, but in computing, programming languages choose depending on the language and the signs of a or n.</p>
</blockquote>
<h2 id="编程语言实现"><a class="markdownIt-Anchor" href="#编程语言实现"></a> 编程语言实现</h2>
<h3 id="truncated-division"><a class="markdownIt-Anchor" href="#truncated-division"></a> Truncated division</h3>
<p>很多语言采用这种实现，约定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>=</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>n</mi><mi>c</mi><mo stretchy="false">(</mo><mfrac><mi>a</mi><mi>n</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q = trunc(\frac{a}{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span>，其中 <code>trunc</code> 表示向0取整，代表语言如 <code>Java</code>。</p>
<h3 id="floored-division"><a class="markdownIt-Anchor" href="#floored-division"></a> Floored division</h3>
<p><code>Donald Knuth</code> 提倡这种实现，约定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>=</mo><mo stretchy="false">⌊</mo><mfrac><mi>a</mi><mi>n</mi></mfrac><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">q = \lfloor \frac{a}{n} \rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mopen">⌊</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span></span></span></span>，即向下取整，代表语言如 <code>Python</code>。</p>
<h3 id="euclidean-division"><a class="markdownIt-Anchor" href="#euclidean-division"></a> Euclidean division</h3>
<p><code>Raymond T. Boute</code> 则提倡这种实现，约定：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>q</mi><mo>=</mo><mi>s</mi><mi>g</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">⌊</mo><mfrac><mi>a</mi><mrow><mi mathvariant="normal">∣</mi><mi>n</mi><mi mathvariant="normal">∣</mi></mrow></mfrac><mo stretchy="false">⌋</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">⌊</mo><mfrac><mi>a</mi><mi>n</mi></mfrac><mo stretchy="false">⌋</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if n &gt; 0</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">⌈</mo><mfrac><mi>a</mi><mi>n</mi></mfrac><mo stretchy="false">⌉</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>if n &lt; 0</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">q = sgn(n)\lfloor \frac{a}{|n|} \rfloor =     
    \begin{cases}
      \lfloor \frac{a}{n} \rfloor &amp; \text{if n &gt; 0}\\
      \lceil \frac{a}{n} \rceil &amp; \text{if n &lt; 0}
    \end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.0435600000000003em;vertical-align:-0.936em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mopen">⌊</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal">n</span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">⌊</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌋</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mopen">⌈</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌉</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if n &gt; 0</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if n &lt; 0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>即根据 <code>n</code> 的正负号来判断是向下取整还是向上取整，代表语言如 <code>ABAP</code>。</p>
<h3 id="rounded-division"><a class="markdownIt-Anchor" href="#rounded-division"></a> Rounded division</h3>
<p>这是 <code>Common Lisp</code> 和 <code>IEEE 754</code> 采用的实现，约定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>=</mo><mi>r</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>d</mi><mo stretchy="false">(</mo><mfrac><mi>a</mi><mi>n</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q = round(\frac{a}{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span>，其中 <code>round</code> 使用 <code>rounding half to even</code>，即在常规的取整之外，对于1.5，2.5，x.5这样的数字取整到最近的偶数，例如6.5取整到6，7.5取整到8。</p>
<h3 id="ceiling-division"><a class="markdownIt-Anchor" href="#ceiling-division"></a> Ceiling division</h3>
<p>这是 <code>Common Lisp</code> 提供的另一种实现，约定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>=</mo><mo stretchy="false">⌈</mo><mfrac><mi>a</mi><mi>n</mi></mfrac><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">q = \lceil \frac{a}{n} \rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mopen">⌈</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">⌉</span></span></span></span>，即向上取整。</p>
<h2 id="python-实现"><a class="markdownIt-Anchor" href="#python-实现"></a> Python 实现</h2>
<p>回到 <code>Python</code>，很难说上述哪种实现一定最优，<code>Python</code> 的作者提到采用 <code>floored division</code> 是因为对于某些应用来说，如果取模运算返回负数没有意义。例如，给定一个 <code>POSIX timestamp</code>，如何返回该天的时间部分，即时分秒？因为一天有86400秒，假设时间戳是 <code>t</code>，那么 <code>t % 86400</code> 就表示该天过了多少秒，就可以进一步转化为时分秒。而对于在 <code>1970-01-01T00:00:00Z</code> 之前的日期，<code>t</code> 则是负数，采用 <code>floored division</code> 的情况下 <code>t % 86400</code> 依然返回正数，并且结果也是正确的，而 <code>truncated division</code> 则返回负数，需要应用程序进一步处理。</p>
<p>不过，一种编程语言中不一定只提供一种实现，其他实现可以借助函数库。例如，<code>Python</code> 中 <code>-5 % 2</code> 结果是1，实现方式为 <code>floored division</code>，但是 <code>math.fmod(-5, 2)</code> 结果是-1，实现方式为 <code>truncated division</code>。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://python-history.blogspot.com/2010/08/why-pythons-integer-division-floors.html">Why Python’s Integer Division Floors</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Modulo">Modulo</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2024/03/31/snowflake-storage-integration-with-s3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/31/snowflake-storage-integration-with-s3/" class="post-title-link" itemprop="url">Snowflake 配置 S3 Storage Integration</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-31 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-31T00:00:00+08:00">2024-03-31</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p><code>Snowflake</code> 的 <code>Data Loading</code> 和 <code>Data Unloading</code> 可以通过 <code>S3</code> 导入和导出数据。用户可以使用 <code>AWS_KEY_ID</code> 和 <code>AWS_SECRET_KEY</code> 来授权 <code>Snowflake</code> 访问 <code>S3</code>，不过出于安全和权限控制的考虑，一般不会这么做。</p>
<p><code>Snowflake</code> 建议通过 <code>Storage Integration</code> 来管理权限。</p>
<h2 id="获取-vpc-id"><a class="markdownIt-Anchor" href="#获取-vpc-id"></a> 获取 VPC ID</h2>
<p>在配置 <code>Storage Integration</code> 前，需要设置 <code>S3</code> 策略。首先获取 <code>Snowflake</code> 的 <code>VPC ID</code>，后续的 <code>S3</code> 策略配置中将只允许该 <code>VPC</code> 访问。</p>
<blockquote>
<p>允许特定 VPC 访问的功能要求 Snowflake 实例和对应的 S3 Bucket 运行在相同的 AWS 区域内。</p>
</blockquote>
<p>切换到 <code>ACCOUNTADMIN</code> 角色在 <code>Snowflake</code> 中执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USE ROLE ACCOUNTADMIN;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SYSTEM</span>$GET_SNOWFLAKE_PLATFORM_INFO();</span><br></pre></td></tr></table></figure>
<p>记录下返回的 <code>VPC ID</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;snowflake-vpc-id&quot;:[&quot;vpc-abc&quot;]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建-iam-策略"><a class="markdownIt-Anchor" href="#创建-iam-策略"></a> 创建 IAM 策略</h2>
<p>然后，需要创建一个 <code>S3</code> 策略来定义 <code>Snowflake</code> 访问 <code>S3 Bucket</code> 的权限。</p>
<p>从 <code>AWS</code> 控制台进入 <code>IAM</code>，在左侧导航栏 <code>Access management</code> 下选择 <code>Account settings</code>：</p>
<p><img src="/images/snowflake-1.png" alt="alt" /></p>
<p>在 <code>Security Token Service (STS)</code> 下查看所在区域的 <code>STS</code> 状态是否是 <code>Active</code>：</p>
<p><img src="/images/snowflake-2.png" alt="alt" /></p>
<p>接着，在左侧导航栏 <code>Access management</code> 下选择 <code>Policies</code>，之后点击 <code>Create policy</code>：</p>
<p><img src="/images/snowflake-3.png" alt="alt" /></p>
<p>切换到 <code>JSON</code> 后输入 <code>S3</code> 策略：</p>
<p><img src="/images/snowflake-4.png" alt="alt" /></p>
<p>下面的策略中 <code>vpc-abc</code> 是 <code>Snowflake</code> 实例的 <code>VPC</code>，<code>snowflake-storage-integration-example</code> 是示例 <code>Bucket</code> 的名字，<code>unloading</code> 和 <code>loading</code> 是该 <code>Bucket</code> 下的两个文件夹，分别用于 <code>Data Unloading</code> 和 <code>Data Loading</code> 使用：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Statement1&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="string">&quot;s3:GetObjectVersion&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="string">&quot;s3:DeleteObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="string">&quot;s3:DeleteObjectVersion&quot;</span></span><br><span class="line">			<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="string">&quot;arn:aws:s3:::snowflake-storage-integration-example/unloading/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="string">&quot;arn:aws:s3:::snowflake-storage-integration-example/loading/*&quot;</span></span><br><span class="line">			<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;aws:SourceVpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vpc-abc&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Statement2&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="string">&quot;s3:GetBucketLocation&quot;</span></span><br><span class="line">			<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="string">&quot;arn:aws:s3:::snowflake-storage-integration-example&quot;</span></span><br><span class="line">			<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;s3:prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">						<span class="string">&quot;unloading/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="string">&quot;loading/*&quot;</span></span><br><span class="line">					<span class="punctuation">]</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;aws:SourceVpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vpc-abc&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="创建-iam-角色"><a class="markdownIt-Anchor" href="#创建-iam-角色"></a> 创建 IAM 角色</h2>
<p>接着，创建一个 <code>IAM</code> 角色并绑定前一步创建的 <code>S3</code> 策略。在 <code>IAM</code> 左侧导航栏 <code>Access management</code> 下选择 <code>Roles</code>，之后点击 <code>Create role</code>：</p>
<p><img src="/images/snowflake-5.png" alt="alt" /></p>
<p><code>Trusted entity type</code> 选择 <code>AWS account</code>，然后在 <code>An AWS account</code> 下选择 <code>Another AWS account</code>，<code>Account ID</code> 暂时先填当前账号的 <code>ID</code>，之后会修改：</p>
<p><img src="/images/snowflake-6.png" alt="alt" /></p>
<p>同时，选择 <code>Require external ID (Best practice when a third party will assume this role)</code>，<code>External ID</code> 暂时用一个假的例如 <code>0000</code> 替代，之后同样会修改：</p>
<p><img src="/images/snowflake-7.png" alt="alt" /></p>
<p>最后绑定先前创建的 <code>S3</code> 策略：</p>
<p><img src="/images/snowflake-8.png" alt="alt" /></p>
<p>创建角色之后，记录下角色的 <code>ARN</code>，接下来会用到：</p>
<p><img src="/images/snowflake-9.png" alt="alt" /></p>
<h2 id="创建-storage-integration"><a class="markdownIt-Anchor" href="#创建-storage-integration"></a> 创建 Storage Integration</h2>
<p>这时就可以在 <code>Snowflake</code> 中创建 <code>Storage Integration</code> 了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> STORAGE INTEGRATION snowflake_storage_integration_example</span><br><span class="line">  TYPE <span class="operator">=</span> EXTERNAL_STAGE</span><br><span class="line">  STORAGE_PROVIDER <span class="operator">=</span> <span class="string">&#x27;S3&#x27;</span></span><br><span class="line">  ENABLED <span class="operator">=</span> <span class="literal">TRUE</span></span><br><span class="line">  STORAGE_AWS_ROLE_ARN <span class="operator">=</span> <span class="string">&#x27;arn:aws:iam::123:role/snowflake-integration-role&#x27;</span></span><br><span class="line">  STORAGE_ALLOWED_LOCATIONS <span class="operator">=</span> (<span class="string">&#x27;s3://snowflake-storage-integration-example/loading/&#x27;</span>, <span class="string">&#x27;s3://snowflake-storage-integration-example/unloading/&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>其中 <code>STORAGE_AWS_ROLE_ARN</code> 是之前所创建的 <code>IAM</code> 角色的 <code>ARN</code>，<code>STORAGE_ALLOWED_LOCATIONS</code> 是示例 <code>Bucket</code> 下的两个文件夹的地址。</p>
<blockquote>
<p>只有授权了 <code>CREATE INTEGRATION</code> 权限的角色才能创建 <code>STORAGE INTEGRATION</code>，默认只有 <code>ACCOUNTADMIN</code> 才有这个权限。</p>
</blockquote>
<h2 id="获取-snowflake-的用户-arn-和-external-id"><a class="markdownIt-Anchor" href="#获取-snowflake-的用户-arn-和-external-id"></a> 获取 Snowflake 的用户 ARN 和 External ID</h2>
<p>接着需要获取所创建的 <code>Storage Integration</code> 对应的 <code>Snowflake</code> <code>IAM</code> 用户的 <code>ARN</code> 和 <code>External ID</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> integration snowflake_storage_integration_example;</span><br></pre></td></tr></table></figure>
<p><img src="/images/snowflake-10.png" alt="alt" /></p>
<p>记录下 <code>STORAGE_AWS_IAM_USER_ARN</code> 和 <code>STORAGE_AWS_EXTERNAL_ID</code>。</p>
<h2 id="授权-snowflake-用户"><a class="markdownIt-Anchor" href="#授权-snowflake-用户"></a> 授权 Snowflake 用户</h2>
<p>回到之前创建的 <code>IAM</code> 角色，在 <code>Trust relationships</code> 下替换掉之前填写的临时 <code>Account ID</code> 和 <code>External ID</code>：</p>
<p><img src="/images/snowflake-11.png" alt="alt" /></p>
<p><img src="/images/snowflake-12.png" alt="alt" /></p>
<p>完成后，我们就可以执行一条 <code>Data Unloading</code> 命令来验证配置是否成功：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">copy</span> <span class="keyword">into</span> <span class="string">&#x27;s3://snowflake-storage-integration-example/unloading/&#x27;</span></span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> OBJECT_CONSTRUCT_KEEP_NULL(<span class="operator">*</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> MY_DATABASE.MY_SCHEMA.MY_TABLE limit <span class="number">10</span>))</span><br><span class="line">FILE_FORMAT <span class="operator">=</span> (type <span class="operator">=</span> json, COMPRESSION <span class="operator">=</span> <span class="keyword">NONE</span>)</span><br><span class="line">STORAGE_INTEGRATION <span class="operator">=</span> snowflake_storage_integration_example</span><br></pre></td></tr></table></figure>
<p>如果配置成功，那么 <code>Snowflake</code> 会将表 <code>MY_DATABASE.MY_SCHEMA.MY_TABLE</code> 的数据导出到 <code>s3://snowflake-storage-integration-example/unloading/</code> 文件夹下。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.snowflake.com/en/user-guide/data-load-s3-allow">Allowing the Virtual Private Cloud IDs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.snowflake.com/en/user-guide/data-load-s3-config-storage-integration">Option 1: Configuring a Snowflake storage integration to access Amazon S3</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.snowflake.com/en/sql-reference/sql/create-storage-integration">CREATE STORAGE INTEGRATION</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2024/03/03/hospital/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/03/hospital/" class="post-title-link" itemprop="url">【读】Newton 科学世界 - 就诊指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-03 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-03T00:00:00+08:00">2024-03-03</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>62</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>翻到了一本压箱底的 <code>Newton 科学世界</code>，本期主题为 <code>就诊指南</code>，大概整理了一下，<a target="_blank" rel="noopener" href="https://1drv.ms/u/s!AgP1jNp0kP4-1kMaeBvVo1xntEtm?e=yYWOFm">源文件</a>。</p>
<p><img src="/images/%E5%B0%B1%E8%AF%8A%E6%8C%87%E5%8D%97.png" alt="alt" /></p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li>Newton 科学世界（2022.5）</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2023/08/12/17-reasons-not-to-be-a-manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/12/17-reasons-not-to-be-a-manager/" class="post-title-link" itemprop="url">【读】17 REASONS NOT TO BE A MANAGER</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:00:00" itemprop="dateCreated datePublished" datetime="2023-08-12T00:00:00+08:00">2023-08-12</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p>这是一篇出现在 <code>Hacker News</code> 上的文章，作者阐述了关于不当管理者的17个理由。</p>
<h2 id="17个理由"><a class="markdownIt-Anchor" href="#17个理由"></a> 17个理由</h2>
<h3 id="1-你热爱你所做的事"><a class="markdownIt-Anchor" href="#1-你热爱你所做的事"></a> 1. 你热爱你所做的事</h3>
<ul>
<li>你会为能亲自实现某个功能而兴奋不已吗？</li>
<li>你会时而在敲完一天代码后开心的哼着小曲下班吗？</li>
<li>你会为过去所实现的功能、达成的成就感到自豪吗？</li>
</ul>
<p>如果是的话，那么你是一个幸运的打工人。永远不要低估一颗热爱工作的心，同时也不要想当然的认为无论何时都能重拾这份热爱。</p>
<h3 id="2-找到一份工程师的工作很简单"><a class="markdownIt-Anchor" href="#2-找到一份工程师的工作很简单"></a> 2. 找到一份工程师的工作很简单</h3>
<p>在裁员时代，这点已经不再简单。不过在同等条件下，工程师岗位相对于管理者岗位来说：</p>
<ul>
<li>技能更能够量化，仅从通过面试来说，一部分技能甚至可以在面试过程中不断学习强化</li>
<li>除了特定行业外，工程师的技能一般不和公司深度绑定。在上一家公司培养的技能并不会因为换了家公司就基本没用；而管理者在上一家公司与各团队构建的信任关系则一般无法带到下一家公司，或者换了一家公司后，需要应对未曾遇到的人员关系</li>
</ul>
<h3 id="3-管理者岗位僧多粥少"><a class="markdownIt-Anchor" href="#3-管理者岗位僧多粥少"></a> 3. 管理者岗位僧多粥少</h3>
<p>管理者岗位一个萝卜一个坑，其招聘数量远少于工程师岗位。</p>
<h3 id="4-管理者最先被炒鱿鱼"><a class="markdownIt-Anchor" href="#4-管理者最先被炒鱿鱼"></a> 4. 管理者最先被炒鱿鱼</h3>
<p>如果真要裁员，光裁管理者是不够的，工程师反而有天然的【人数优势】。</p>
<p>除非是一锅端，否则各部门按比例的裁员场景下，应该不会有管理者自告奋勇的说自己产生不了直接价值，底下的人离开我也能转，裁我吧。</p>
<h3 id="5-管理者不易跳槽"><a class="markdownIt-Anchor" href="#5-管理者不易跳槽"></a> 5. 管理者不易跳槽</h3>
<p>除开管理者岗位本身的原因，年龄也有一定的影响，但这不仅仅针对管理者。管理者的年龄一般比下属的工程师大，即使一个工程师在年轻的时候可以一年两跳，到了管理者同样的年纪也可能会变得不容易跳槽。</p>
<h3 id="6-工程师会看轻管理者"><a class="markdownIt-Anchor" href="#6-工程师会看轻管理者"></a> 6. 工程师会看轻管理者</h3>
<p>大家都是打工的，没有必要谁看不起谁。当然也会有唯技术论的工程师，无视技术之外的一切；但同样的，也有始终认为自己是主子的管理者，这种，自然是没有必要迎合的。</p>
<p>那么，管理者需不需要懂技术？如果是放权型管理者，能安心将技术决策委托给核心工程师，是可以不用懂技术的，从而专注发挥好自己的管理长处。不过，这属于可遇不可求的情况，现实中没有那么多的刘备和孔明。虽然作者和他的同事们讨论后都认为所遇到的优秀的管理者都不懂技术，但是优秀的管理者本身是比优秀的工程师更为稀缺的存在。所以，对于一般的管理者，至少在技术上要能认识到十个女人一个月真的生不出孩子。</p>
<h3 id="7-管理者有时候要当坏人"><a class="markdownIt-Anchor" href="#7-管理者有时候要当坏人"></a> 7. 管理者有时候要当坏人</h3>
<p>身为管理者，难免会遇到以下的情况：</p>
<ul>
<li>绩效有人要背 C</li>
<li>裁员指标</li>
<li>传达上头不合理的要求</li>
</ul>
<p>而并不是所有人都愿意和能合理的处理好这些场景。</p>
<h3 id="8-管理者的技能树比你想象中的要少"><a class="markdownIt-Anchor" href="#8-管理者的技能树比你想象中的要少"></a> 8. 管理者的技能树比你想象中的要少</h3>
<p>如果从工程师切到了管理者，可能会觉得自己一直在飘着，不再是实际的执行者，这对于某些工程师来说可能会比较难受。而另一方面，立志往管理线发展的人可能会更乐于去做引导一个产品或项目落地的过程，对实际执行并不太关心，并在这期间逐步提高自己的影响力。</p>
<p>我认为这里能体现管理者水平的地方包含但不限于如何处理：</p>
<ul>
<li>你的目标对你很重要，但对其他人不重要</li>
<li>你有雄心壮志，但其他人只想安分守己</li>
</ul>
<h3 id="9-做得好是你的本分做不好是你的锅"><a class="markdownIt-Anchor" href="#9-做得好是你的本分做不好是你的锅"></a> 9. 做得好是你的本分，做不好是你的锅</h3>
<p>大和田老师在半泽直树1里说过：</p>
<blockquote>
<p>下属的功劳是上司的功绩，上司的过错是下属的责任</p>
</blockquote>
<p>做不好又能把锅甩出去也是管理的一种能力。</p>
<h3 id="10-你需要以-ic-的身份和管理者分庭抗礼"><a class="markdownIt-Anchor" href="#10-你需要以-ic-的身份和管理者分庭抗礼"></a> 10. 你需要以 IC 的身份和管理者分庭抗礼</h3>
<p><code>IC</code> 全称 <code>Individual Contributor</code>，常见翻译为独立贡献者或个人贡献者。<code>IC</code> 最明显的特点是没有管理职责，注意不等同于没有管理工作，他们利用自己的专业水平协同或者独立完成任务，最终可能成为某一方面的专家。</p>
<p><code>IC</code> 也分等级，例如 <code>Dropbox</code> 的软件工程师职位就划分为了 <code>IC1</code> 到 <code>IC7</code>，而管理者岗位则是 <code>M</code> 线。高级的 <code>IC</code> 也会有管理工作，例如项目管理（高级 <code>IC</code> 负责的项目很可能已经不是自己能独立完成的了）或者人员管理（什么地方用什么样的人）。</p>
<p>这里作者认为需要有能够发声的高级 <code>IC</code>，因为他们毕竟还是 <code>IC</code> 线，他们所代表的利益有时也符合普通工程师的利益。如果高级 <code>IC</code> 最终都转到了管理岗，那么本来就人微言轻的普通工程师的利益也更难传达到上层。不过，这也要求公司有能够让高级 <code>IC</code> 开花结果的土壤。</p>
<h3 id="11-管理只是一系列技能你同样能以-ic-的身份去尝试所有有趣的管理工作"><a class="markdownIt-Anchor" href="#11-管理只是一系列技能你同样能以-ic-的身份去尝试所有有趣的管理工作"></a> 11. 管理只是一系列技能，你同样能以 <code>IC</code> 的身份去尝试所有有趣的管理工作</h3>
<p>随着在 <code>IC</code> 路线上的成长，你会逐渐涉及一些技术之外的管理工作。有人可能就会乐于去尝试这些管理工作，例如担任导师，面试，参与决策，制定职业规划等。作者认为一个健康的公司应当鼓励并允许高级 <code>IC</code> 去参与这些工作。这样就避免了参与管理者职责中的一些不讨喜的活，例如绩效考核，裁人等。</p>
<h3 id="12-更难从工作中感到愉悦"><a class="markdownIt-Anchor" href="#12-更难从工作中感到愉悦"></a> 12. 更难从工作中感到愉悦</h3>
<p>修复一个问题或者学习新知识所带来的愉悦可能就此一去不复返，同时，工作中的正反馈周期也可能变长。</p>
<p>不过，这也因人而异，那些享受改完一个高深 <code>Bug</code> 的工程师可能根本不会想着做管理，而有些做管理的人也可能根本不认为改完一个高深的 <code>Bug</code> 是种享受，他们的愉悦点可能在于来自底下的服从。</p>
<h3 id="13-情绪影响会衍生甚至占据你的个人生活"><a class="markdownIt-Anchor" href="#13-情绪影响会衍生甚至占据你的个人生活"></a> 13. 情绪影响会衍生甚至占据你的个人生活</h3>
<p>身为管理者后，会与更多的人打交道，而人不是一个确定的个体，每个人有各自的行为处世，你可能会觉得更心累。</p>
<h3 id="14-你的时间不再属于你"><a class="markdownIt-Anchor" href="#14-你的时间不再属于你"></a> 14. 你的时间不再属于你</h3>
<p>普通工程师的时间都不能够一定保证，管理者可能更甚。</p>
<h3 id="15-会议"><a class="markdownIt-Anchor" href="#15-会议"></a> 15. 会议</h3>
<p>更恐怖的是无尽的低效会议。</p>
<h3 id="16-如果你的心之所向是技术引领"><a class="markdownIt-Anchor" href="#16-如果你的心之所向是技术引领"></a> 16. 如果你的心之所向是技术引领</h3>
<p>成为管理者后，你的做事方式就转变为了影响团队，提高团队。你的技术水平也会因此停滞不前，然后逐渐衰退。如果你认为这是一种折磨，那么你就不适合成为管理者。</p>
<h3 id="17-管理者岗位始终会等着你"><a class="markdownIt-Anchor" href="#17-管理者岗位始终会等着你"></a> 17. 管理者岗位始终会等着你</h3>
<p>即使是技术路线越往上走也越会要涉及管理工作，如果你不在乎一个头衔，又何必急于一时。</p>
<h2 id="最后"><a class="markdownIt-Anchor" href="#最后"></a> 最后</h2>
<p>理想的情况下自然是合适的人在合适的位置上，不过现实中也会有赶鸭子上架而做了管理者的人，或者为了延长自己的职业寿命而无奈转了管理者。但无论如何，管理并不是一个想当然的工作，并不是因为工程师干不下去了所以到时候就转管理，这既不尊重管理岗位本身，也不尊重团队中的其他人，只会多一个不靠谱的管理者，而不靠谱的管理者比不靠谱的工程师更糟糕。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://charity.wtf/2019/09/08/reasons-not-to-be-a-manager/">17 REASONS NOT TO BE A MANAGER</a></li>
<li><a target="_blank" rel="noopener" href="https://dropbox.github.io/dbx-career-framework/overview.html">Dropbox Engineering Career Framework</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Xiaodan Mao</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Frederick-S" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
