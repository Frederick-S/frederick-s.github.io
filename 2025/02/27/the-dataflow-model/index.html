<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"frederick-s.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="介绍 面对日益增长的大规模无界、无序数据的处理需求，当前的技术手段存在诸多不足：  以 MapRecue 为代表的批处理系统无法满足数据处理的及时性要求，因为需要先收集所有的数据，然后再处理 很多流式系统对于大规模处理下的容错性缺少明确的保证 能够提供大规模处理和容错性的系统又缺少表达性和正确性 很多系统也缺少 exactly-once 语义保证，从而影响正确性 缺少对窗口（windowing）">
<meta property="og:type" content="article">
<meta property="og:title" content="【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing">
<meta property="og:url" content="https://frederick-s.github.io/2025/02/27/the-dataflow-model/index.html">
<meta property="og:site_name" content="Übung macht den Meister">
<meta property="og:description" content="介绍 面对日益增长的大规模无界、无序数据的处理需求，当前的技术手段存在诸多不足：  以 MapRecue 为代表的批处理系统无法满足数据处理的及时性要求，因为需要先收集所有的数据，然后再处理 很多流式系统对于大规模处理下的容错性缺少明确的保证 能够提供大规模处理和容错性的系统又缺少表达性和正确性 很多系统也缺少 exactly-once 语义保证，从而影响正确性 缺少对窗口（windowing）">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://frederick-s.github.io/images/dataflow-1.png">
<meta property="og:image" content="https://frederick-s.github.io/images/dataflow-2.png">
<meta property="og:image" content="https://frederick-s.github.io/images/dataflow-3.png">
<meta property="og:image" content="https://frederick-s.github.io/images/dataflow-4.png">
<meta property="article:published_time" content="2025-02-26T16:00:00.000Z">
<meta property="article:modified_time" content="2025-02-26T16:00:00.000Z">
<meta property="article:author" content="Xiaodan Mao">
<meta property="article:tag" content="Paper">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://frederick-s.github.io/images/dataflow-1.png">


<link rel="canonical" href="https://frederick-s.github.io/2025/02/27/the-dataflow-model/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://frederick-s.github.io/2025/02/27/the-dataflow-model/","path":"2025/02/27/the-dataflow-model/","title":"【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing | Übung macht den Meister</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J1NC2B33VK"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-J1NC2B33VK","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Übung macht den Meister" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Übung macht den Meister</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-mit-6.824"><a href="/mit-6.824/" rel="section"><i class="fas fa-book fa-fw"></i>MIT 6.824</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-赞赏"><a href="/sponsor/" rel="section"><i class="fas fa-heart fa-fw"></i>赞赏</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fas fa-rss fa-fw"></i>RSS</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text"> 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E7%95%8C%E6%9C%89%E7%95%8C%E4%B8%8E%E6%B5%81%E5%BC%8F%E6%89%B9"><span class="nav-number">1.1.</span> <span class="nav-text"> 无界&#x2F;有界与流式&#x2F;批</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3"><span class="nav-number">1.2.</span> <span class="nav-text"> 窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 固定窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="nav-number">1.2.2.</span> <span class="nav-text"> 滑动窗口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3"><span class="nav-number">1.2.3.</span> <span class="nav-text"> 会话窗口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4"><span class="nav-number">1.3.</span> <span class="nav-text"> 时间</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dataflow-%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.</span> <span class="nav-text"> Dataflow 模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8E%9F%E8%AF%AD"><span class="nav-number">2.1.</span> <span class="nav-text"> 核心原语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3-2"><span class="nav-number">2.2.</span> <span class="nav-text"> 窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E5%88%86%E9%85%8D"><span class="nav-number">2.2.1.</span> <span class="nav-text"> 窗口分配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E5%90%88%E5%B9%B6"><span class="nav-number">2.2.2.</span> <span class="nav-text"> 窗口合并</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#api"><span class="nav-number">2.2.3.</span> <span class="nav-text"> API</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8%E5%92%8C%E5%A2%9E%E9%87%8F%E5%A4%84%E7%90%86"><span class="nav-number">2.3.</span> <span class="nav-text"> 触发器和增量处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%92%8C%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.</span> <span class="nav-text"> 实现和设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">3.1.</span> <span class="nav-text"> 设计原则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text"> 参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xiaodan Mao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">88</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://frederick-s.github.io/2025/02/27/the-dataflow-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xiaodan Mao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing | Übung macht den Meister">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-27 00:00:00" itemprop="dateCreated datePublished" datetime="2025-02-27T00:00:00+08:00">2025-02-27</time>
    </span>

  
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>9.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>16 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="介绍"><a class="markdownIt-Anchor" href="#介绍"></a> 介绍</h2>
<p>面对日益增长的大规模无界、无序数据的处理需求，当前的技术手段存在诸多不足：</p>
<ul>
<li>以 <code>MapRecue</code> 为代表的批处理系统无法满足数据处理的及时性要求，因为需要先收集所有的数据，然后再处理</li>
<li>很多流式系统对于大规模处理下的容错性缺少明确的保证</li>
<li>能够提供大规模处理和容错性的系统又缺少表达性和正确性</li>
<li>很多系统也缺少 <code>exactly-once</code> 语义保证，从而影响正确性</li>
<li>缺少对窗口（<code>windowing</code>）计算的支持或支持有限</li>
<li>某些支持基于事件时间（<code>event-time</code>）的窗口计算的系统要么要求事件必须有序，要么窗口触发语义不够丰富</li>
<li>缺少高层次的编程模型能够直观的支持基于事件时间的会话（<code>session</code>）</li>
<li>虽然 <code>Lambda</code> 架构能够解决大部分的问题，但是需要同时构建和维护两套系统，增加了成本</li>
</ul>
<p>当前已有系统的主要问题在于认为数据是有界的，这个假设对当下海量且无序的数据处理的需求是不成立的；另外，需要一个简单但又强大的工具在满足上述场景的同时，又能在正确性，延迟和成本之间取得平衡；最后，需要转变由执行引擎决定系统语义的思想，不管是批处理，微批处理，还是流式处理，只要经过了合理的设计和实现，都能提供同等水平的正确性保证，而这三种执行引擎如今都广泛用于处理无界的数据。因此，在正确性保证的前提下，选择不同的执行引擎的决定因素就在于延迟和资源成本。</p>
<p>本文提出了一个统一的数据处理模型：</p>
<ul>
<li>对无界，无序的数据，能够根据事件本身的维度特征进行窗口聚合，并按照事件时间排序计算，并且在正确性，延迟，和成本之间灵活调优</li>
<li>将 <code>pipeline</code> 的实现拆解为四个维度，以提供清晰性，可组合性和灵活性：
<ul>
<li><code>What</code>：计算的结果是什么</li>
<li><code>Where</code>：参与计算的事件时间</li>
<li><code>When</code>：数据处理时间</li>
<li><code>How</code>：先前的计算结果如何与后续优化关联</li>
</ul>
</li>
<li>将数据处理的逻辑概念与底层物理实现剥离，对于批处理，微批处理，和流式处理的选择，取决于用户对正确性，延迟，和成本的考量</li>
</ul>
<p>具体来说，本文的主要贡献在于提出了：</p>
<ul>
<li>窗口模型：支持非对齐的事件时间窗口，并提供简单的 <code>API</code> 用于创建和使用窗口</li>
<li>触发模型：将数据处理结果的输出时机与 <code>pipeline</code> 的运行时特征相绑定，并提供了强大和灵活的声明式 <code>API</code> 来描述触发的语义</li>
<li>增量式的处理模型：集成窗口模型和触发模型，支持计算的撤销和更新</li>
<li>可扩展的实现：既支持流式处理引擎（<code>MillWheel</code>），也支持批处理引擎（<code>FlumeJava</code>），以及对 <code>Google Cloud Dataflow</code> 的外部二次实现，并提供了运行时无关的开源 <code>SDK</code></li>
<li>一系列指导本文描述的模型设计的核心准则</li>
<li><code>Google</code> 产线环境下大规模无界，无序数据处理的真实案例探讨，正是这些真实需求驱动了本文描述的模型的开发</li>
</ul>
<h3 id="无界有界与流式批"><a class="markdownIt-Anchor" href="#无界有界与流式批"></a> 无界/有界与流式/批</h3>
<p>相比于流式/批，本文倾向于使用无界/有界来描述无限/有限的数据集，因为前者可能暗示使用了特定的执行引擎。实际上，无界的数据同样可以用连续运行的批处理引擎处理，而设计合理的流式处理引擎同样可以处理有界的数据。</p>
<h3 id="窗口"><a class="markdownIt-Anchor" href="#窗口"></a> 窗口</h3>
<p>窗口将一个数据集划分为有限个数的组。在处理无界数据时，窗口对于某些操作是必须的（如聚合，外连接，以时间为界的操作），而对于其他操作（如过滤，映射，内连接）则不是必须的。对于有界数据来说，窗口是可选的，不过依然在很多场景下适用（如对已经处理过的无界数据的一部分进行大批量的更新，即 <code>backfill</code>）。窗口始终是基于时间的，虽然某些系统支持基于元组的窗口，不过这依然是基于时间的窗口，其中有序的元素隐含着对应递增的逻辑时间。窗口分为对齐和非对齐，前者窗口的边界与特定的时间间隔同步，后者不同的窗口可以在不同的时间开始和结束。</p>
<h4 id="固定窗口"><a class="markdownIt-Anchor" href="#固定窗口"></a> 固定窗口</h4>
<p><img src="/images/dataflow-1.png" alt="alt" /></p>
<p>也称为滚动窗口（<code>tumbling window</code>），每个窗口都是固定的大小，且彼此之间没有重叠，通常都是对齐的，例如，每小时生成大小为1小时的窗口：</p>
<ul>
<li>窗口1：[12:00, 13:00)</li>
<li>窗口2：[13:00, 14:00)</li>
<li>窗口3：[14:00, 15:00)</li>
<li>…</li>
</ul>
<p>不过，有时候为了保证窗口对齐，会将窗口按照键以某个随机值进行偏移。</p>
<h4 id="滑动窗口"><a class="markdownIt-Anchor" href="#滑动窗口"></a> 滑动窗口</h4>
<p><img src="/images/dataflow-2.png" alt="alt" /></p>
<p>滑动窗口由窗口大小和滑动周期构成，例如，每分钟生成大小为1小时的窗口：</p>
<ul>
<li>窗口1：[12:00, 13:00)</li>
<li>窗口2：[12:01, 13:01)</li>
<li>窗口3：[12:02, 13:02)</li>
<li>…</li>
</ul>
<p>滑动周期可能会小于窗口大小，所以相邻两个窗口之间有重叠，当滑动周期等于窗口大小的时候，滑动窗口就退化成了滚动窗口。滑动窗口一般也是对齐的。</p>
<h4 id="会话窗口"><a class="markdownIt-Anchor" href="#会话窗口"></a> 会话窗口</h4>
<p><img src="/images/dataflow-3.png" alt="alt" /></p>
<p>会话窗口用于框住某段时间内产生的数据子集，其大小一般以超时时间来衡量，在该超时时间内发生的事件都会归于该会话窗口。会话窗口一般是非对齐的。</p>
<h3 id="时间"><a class="markdownIt-Anchor" href="#时间"></a> 时间</h3>
<p>数据处理中有两类时间：</p>
<ul>
<li>事件时间：事件实际发生的时间</li>
<li>处理时间：事件被系统观测到并处理的时间</li>
</ul>
<p>一般来说事件时间一旦生成后就不会改变，而处理时间则随着事件在系统中流动而不断变化。理想情况下，如果分别对事件时间和处理时间画一条线，那么这两条线是重合的。不过在实际中，由于通信延迟，调度算法，处理单个事件需要的耗时，以及 <code>pipeline</code> 的序列化等因素，事件时间与处理时间之间存在偏差（如下图所示）。本文使用类似于 <code>MillWheel</code> 的 <code>watermark</code> 来表示这种偏差，<code>watermark</code> 定义了事件时间的一个下界，表示所有事件时间小于 <code>watermark</code> 的事件都已经处理完毕。不过，这依然是个理想情况，为了容忍一定程度的事件到达系统的延迟，<code>watermark</code> 会滞后于最新的事件时间，而这个容忍时间又不可能无限长，所以实际中即使生成 <code>watermark</code> 后也依然有可能存在事件时间比 <code>watermark</code> 小的事件到达系统，这些事件称为 <code>late event</code>。</p>
<p><img src="/images/dataflow-4.png" alt="alt" /></p>
<h2 id="dataflow-模型"><a class="markdownIt-Anchor" href="#dataflow-模型"></a> Dataflow 模型</h2>
<h3 id="核心原语"><a class="markdownIt-Anchor" href="#核心原语"></a> 核心原语</h3>
<p>在批处理下，<code>Dataflow SDK</code> 提供了操作 <code>(key, value)</code> 键值对的两种方式：</p>
<ul>
<li><code>ParDo</code>：对每个输入，通过调用用户定义的方法（在 <code>Dataflow</code> 中称为 <code>DoFn</code>），返回0个或者多个输出，各输入之间无关联，天然的适用于无界数据处理</li>
<li><code>GroupByKey</code>：将相同键的值聚合在一起，不过对于无界数据来说，何时将相同键聚合后的数据发给下游成为了一个问题，因为无法预知数据的边界，通用的解决方法是借助窗口</li>
</ul>
<p>以下是一个 <code>ParDo</code> 的例子，对于每个输入，通过调用 <code>ExpandPrefixes</code> 方法，返回每个键的所有可能的前缀：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>ParDo(ExpandPrefixes)</mtext><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{fix}, 1), (\text{fit}, 2) \\
\bigg\downarrow \quad \text{ParDo(ExpandPrefixes)} \\
\bigg\downarrow \\
(\text{f}, 1), (\text{fi}, 1), (\text{fix}, 1), (\text{f}, 2), (\text{fi}, 2), (\text{fit}, 2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">ParDo(ExpandPrefixes)</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span></p>
<p>以下是一个 <code>GroupByKey</code> 的例子，将相同键的值聚合在一起：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>GroupByKey</mtext><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>f</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fi</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fix</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>fit</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>2</mn><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{f}, 1), (\text{fi}, 1), (\text{fix}, 1), (\text{f}, 2), (\text{fi}, 2), (\text{fit}, 2) \\
\bigg\downarrow \quad \text{GroupByKey} \\
\bigg\downarrow \\
(\text{f}, [1, 2]), (\text{fi}, [1, 2]), (\text{fix}, [1]), (\text{fit}, [2])
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">GroupByKey</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">f</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fi</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fix</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">fit</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">2</span><span class="mclose">]</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="窗口-2"><a class="markdownIt-Anchor" href="#窗口-2"></a> 窗口</h3>
<p>支持按键聚合的系统一般会将 <code>GroupByKey</code> 以 <code>GroupByKeyAndWindow</code> 的形式实现，本文的首要贡献在于支持非对齐的窗口。具体来说：</p>
<ol>
<li><code>Dataflow</code> 模型的视角下可以将所有窗口都当做非对齐的，并交由具体实现来为对齐式的窗口场景优化</li>
<li>窗口计算可以拆解为两个操作：
<ul>
<li><code>Set&lt;Window&gt; AssignWindows(T datum)</code>：将输入分配给0个或者多个窗口</li>
<li><code>Set&lt;Window&gt; MergeWindows(Set&lt;Window&gt; windows)</code>：聚合时将多个窗口合并为一个</li>
</ul>
</li>
</ol>
<p>为了支持基于事件时间的窗口，需要将数据传输的格式从 <code>(key, value)</code> 改为 <code>(key, value, event_time, window)</code>，<code>event_time</code> 是事件时间，<code>window</code> 默认是一个全局窗口，覆盖所有的事件，同时也适配了有界数据的场景。</p>
<h4 id="窗口分配"><a class="markdownIt-Anchor" href="#窗口分配"></a> 窗口分配</h4>
<p>如果一个输入属于多个窗口，那么窗口分配会给每个窗口创建一个输入的副本。</p>
<p>在下面这个例子中，键值对 <code>(k, v1)</code> 和 <code>(k, v2)</code> 分别复制到了两个窗口中。窗口的分配也不需要等到聚合时，可以在 <code>pipeline</code> 的任意执行点发生：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>12:00</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>12:01</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>AssignWindows(Sliding(2m, 1m))</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>12:00</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>11</mn><mo>:</mo><mn>59</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>01</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>12:00</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>12</mn><mo>:</mo><mn>00</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>02</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>12:01</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>12</mn><mo>:</mo><mn>00</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>02</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>12:01</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>12</mn><mo>:</mo><mn>01</mn><mo separator="true">,</mo><mn>12</mn><mo>:</mo><mn>03</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{k}, \text{v1}, \text{12:00}, [0, \infty)), (\text{k}, \text{v2}, \text{12:01}, [0, \infty)) \\
\bigg\downarrow \quad \text{AssignWindows(Sliding(2m, 1m))} \\
(\text{k}, \text{v1}, \text{12:00}, [11:59, 12:01)), \\
(\text{k}, \text{v1}, \text{12:00}, [12:00, 12:02)), \\
(\text{k}, \text{v2}, \text{12:01}, [12:00, 12:02)), \\
(\text{k}, \text{v2}, \text{12:01}, [12:01, 12:03))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:00</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:01</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">AssignWindows(Sliding(2m, 1m))</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:00</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">1</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:00</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:01</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">12:01</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">3</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<h4 id="窗口合并"><a class="markdownIt-Anchor" href="#窗口合并"></a> 窗口合并</h4>
<p>窗口合并发生于 <code>GroupByKeyAndWindow</code> 操作，我们以超时时间为30分钟的会话窗口为例，假设有 <code>(k1, v1)</code>，<code>(k2, v2)</code>，<code>(k1, v3)</code>，<code>(k1, v4)</code> 四个事件，其初始默认的窗口都为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, \infty]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">]</span></span></span></span>。然后，<code>AssignWindows</code> 根据每个事件到达的起始时间分配一个时长为30分钟的会话窗口，在这期间如果有相同键的事件到达，则也将其归到同一个窗口内。然后，<code>GroupByKeyAndWindow</code> 操作可以拆解为如下步骤：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>13:02</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>13:14</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v3</mtext><mo separator="true">,</mo><mtext>13:57</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v4</mtext><mo separator="true">,</mo><mtext>13:20</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>AssignWindows(Sessions(30m))</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mtext>13:02</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>32</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mtext>13:14</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v3</mtext><mo separator="true">,</mo><mtext>13:57</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v4</mtext><mo separator="true">,</mo><mtext>13:20</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>20</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>DropTimestamps</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>32</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>v2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v3</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>v4</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>20</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>GroupByKey</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>32</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v3</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v4</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>20</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>MergeWindows(Sessions(30m))</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v1</mtext><mo separator="true">,</mo><mrow><mtext mathvariant="bold">[13:02,</mtext><mtext> </mtext><mtext mathvariant="bold">13:50)</mtext></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v3</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>v4</mtext><mo separator="true">,</mo><mrow><mtext mathvariant="bold">[13:02,</mtext><mtext> </mtext><mtext mathvariant="bold">13:50)</mtext></mrow><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext>v2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>GroupAlsoByWindow</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mrow><mtext mathvariant="bold">[v1,</mtext><mtext> </mtext><mtext mathvariant="bold">v4]</mtext></mrow><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext mathvariant="bold">[v3]</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mtext mathvariant="bold">[v2]</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mo fence="false">↓</mo><mspace width="1em"/><mtext>ExpandToElements</mtext><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>[v1, v4]</mtext><mo separator="true">,</mo><mtext mathvariant="bold">13:50</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>02</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>50</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k1</mtext><mo separator="true">,</mo><mtext>[v3]</mtext><mo separator="true">,</mo><mtext mathvariant="bold">14:27</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>57</mn><mo separator="true">,</mo><mn>14</mn><mo>:</mo><mn>27</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mtext>k2</mtext><mo separator="true">,</mo><mtext>[v2]</mtext><mo separator="true">,</mo><mtext mathvariant="bold">13:44</mtext><mo separator="true">,</mo><mo stretchy="false">[</mo><mn>13</mn><mo>:</mo><mn>14</mn><mo separator="true">,</mo><mn>13</mn><mo>:</mo><mn>44</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\text{k1}, \text{v1}, \text{13:02}, [0, \infty)), \\
(\text{k2}, \text{v2}, \text{13:14}, [0, \infty)), \\
(\text{k1}, \text{v3}, \text{13:57}, [0, \infty)), \\
(\text{k1}, \text{v4}, \text{13:20}, [0, \infty)), \\
\bigg\downarrow \quad \text{AssignWindows(Sessions(30m))} \\
(\text{k1}, \text{v1}, \text{13:02}, [13:02, 13:32)), \\
(\text{k2}, \text{v2}, \text{13:14}, [13:14, 13:44)), \\
(\text{k1}, \text{v3}, \text{13:57}, [13:57, 14:27)), \\
(\text{k1}, \text{v4}, \text{13:20}, [13:20, 13:50)) \\
\bigg\downarrow \quad \text{DropTimestamps} \\
(\text{k1}, \text{v1}, [13:02, 13:32)), \\
(\text{k2}, \text{v2}, [13:14, 13:44)), \\
(\text{k1}, \text{v3}, [13:57, 14:27)), \\
(\text{k1}, \text{v4}, [13:20, 13:50)) \\
\bigg\downarrow \quad \text{GroupByKey} \\
(\text{k1}, [(\text{v1}, [13:02, 13:32)), \\
            (\text{v3}, [13:57, 14:27)), \\
            (\text{v4}, [13:20, 13:50))]), \\
(\text{k2}, [(\text{v2}, [13:14, 13:44))]) \\
\bigg\downarrow \quad \text{MergeWindows(Sessions(30m))} \\
(\text{k1}, [(\text{v1}, \textbf{[13:02, 13:50)}), \\
            (\text{v3}, [13:57, 14:27)), \\
            (\text{v4}, \textbf{[13:02, 13:50)})]), \\
(\text{k2}, [(\text{v2}, [13:14, 13:44))]) \\
\bigg\downarrow \quad \text{GroupAlsoByWindow} \\
(\text{k1}, [(\textbf{[v1, v4]}, [13:02, 13:50)), \\
            (\textbf{[v3]}, [13:57, 14:27))]), \\
(\text{k2}, [(\textbf{[v2]}, [13:14, 13:44))]) \\
\bigg\downarrow \quad \text{ExpandToElements} \\
(\text{k1}, \text{[v1, v4]}, \textbf{13:50}, [13:02, 13:50)), \\
(\text{k1}, \text{[v3]}, \textbf{14:27}, [13:57, 14:27))), \\
(\text{k2}, \text{[v2]}, \textbf{13:44}, [13:14, 13:44))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:02</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:14</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:57</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:20</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∞</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">AssignWindows(Sessions(30m))</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:02</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:14</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:57</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">13:20</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">DropTimestamps</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">GroupByKey</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">MergeWindows(Sessions(30m))</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">[13:02, 13:50)</span></span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v3</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">v4</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">[13:02, 13:50)</span></span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord">v2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">GroupAlsoByWindow</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">[v1, v4]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">[v3]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">[v2]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">]</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:2.404em;vertical-align:-0.9500199999999999em;"></span><span class="mord"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45398em;"><span style="top:-1.6509900000000002em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>↓</span></span></span><span style="top:-2.24599em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.84199em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-2.85798em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span><span style="top:-3.45398em;"><span class="pstrut" style="height:2.601em;"></span><span class="delimsizinginner delim-size1"><span>⏐</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500199999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">ExpandToElements</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">[v1, v4]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">13:50</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">0</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k1</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">[v3]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">14:27</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">5</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mclose">)</span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">k2</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">[v2]</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textbf">13:44</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<ul>
<li><code>DropTimestamps</code>：丢弃事件的时间戳，因为这里只涉及窗口计算</li>
<li><code>GroupByKey</code>：按照键聚合 <code>(value, window)</code> 元组</li>
<li><code>MergeWindows</code>：合并每个键下 <code>(value, window)</code> 元组中的窗口，具体的合并逻辑由窗口策略决定。在上述的例子中，如果两个 <code>(value, window)</code> 元组中的窗口存在重叠，则每个元组合并后的窗口为两个窗口的并集</li>
<li><code>GroupAlsoByWindow</code>：对每个键下的 <code>(value, window)</code> 元组按照窗口聚合，在上述例子中，<code>v1</code> 和 <code>v4</code> 因为有相同的窗口，所以被聚合在了一起</li>
<li><code>ExpandToElements</code>：将每个键下的 <code>(value, window)</code> 元组展开为 <code>(key, value, event_time, window)</code> 的形式，新的 <code>event_time</code> 在上述例子中采用的是窗口的结束时间，不过实际上只要是大于窗口内最早的事件的时间戳都行。</li>
</ul>
<h4 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h4>
<p>现在通过 <code>Cloud Dataflow SDK</code> 的代码示例来展示如何使用窗口。下述代码将数据按照键聚合后，求所有值的加和：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; input = IO.read(...);</span><br><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; output = input</span><br><span class="line">  .apply(Sum.integersPerKey());</span><br></pre></td></tr></table></figure>
<p>如果要支持超时时间为30分钟的会话窗口，则在求和前调用 <code>Window.into</code> 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; input = IO.read(...);</span><br><span class="line">PCollection&lt;KV&lt;String, Integer&gt;&gt; output = input</span><br><span class="line">  .apply(Window.into(Sessions.withGapDuration(</span><br><span class="line">    Duration.standardMinutes(<span class="number">30</span>))))</span><br><span class="line">  .apply(Sum.integersPerKey());</span><br></pre></td></tr></table></figure>
<h3 id="触发器和增量处理"><a class="markdownIt-Anchor" href="#触发器和增量处理"></a> 触发器和增量处理</h3>
<p>目前为止，还遗留两个问题：</p>
<ul>
<li>需要支持基于元组和处理时间的窗口，不然会和当前已有的系统不兼容</li>
<li>需要知道窗口中的数据计算结果何时可以下发到下游</li>
</ul>
<p>本文认为借助 <code>watermark</code> 来解决第二个问题是不够的，因为 <code>watermark</code> 不能百分百确保所有数据都已经到达，真实场景中总会有晚到的数据。<code>Lambda</code> 架构则提供了一个思路：流式引擎部分提供低延迟的计算，不过其结果是近似值，而批处理引擎则提供最终一致性正确的结果。不过，如何将两者合并到一个 <code>pipeline</code> 中？</p>
<p>本文提出了触发器（<code>trigger</code>）的概念，和窗口的关系为：</p>
<ul>
<li>窗口：根据事件时间决定如何对事件分组</li>
<li>触发器：决定何时（处理时间）告知窗口计算的数据结果可以下发到下游</li>
</ul>
<p><code>Google</code> 实现的系统内置了几类触发器的实现用于在多种场合触发：</p>
<ul>
<li>当所有的数据已被系统接收时（预估，非精确，如 <code>watermark</code>）</li>
<li>处理时间线上的某个时间点</li>
<li>响应数据到达（如数量，大小，<code>data punctuations</code>，模式匹配等满足了一定的条件）</li>
</ul>
<p>另外，不同的触发器之间还可以进行逻辑组合，例如使用 <code>and</code>，<code>or</code>，循环，序列等等。</p>
<p>引入触发器后，同一个窗口的计算结果就有可能被多次下发，系统也提供了三种处理模式：</p>
<ul>
<li>丢弃（<code>Discarding</code>）：一旦窗口被触发，其内容下发后即被丢弃，后续触发和之前的触发没有任何关系。如果多次窗口触发的结果是幂等的，则可以采用该模式</li>
<li>累加（<code>Accumulating</code>）：窗口被触发后，其计算结果会持久化，后续触发结果会作为历史结果的修正。适合于数据消费方收到新的窗口数据，直接替换旧数据的场景。例如某个窗口计算是求窗口中所有数据的最大值，第一次触发时下发目前的最大值，后续有数据再次到达时根据持久化的历史值，直接和当前值比较就可以得到最新的最大值</li>
<li>累加和撤销（<code>Accumulating and Retracting</code>）：在 <code>Accumulating</code> 的基础上，触发的窗口计算结果同样会先持久化，如果后续有新的触发，则会下发两个值，一个是用于告知下游系统撤销上次的值，另一个是最新的窗口计算结果。不过，这也需要下游系统具有响应数据撤销事件的能力</li>
</ul>
<h2 id="实现和设计"><a class="markdownIt-Anchor" href="#实现和设计"></a> 实现和设计</h2>
<h3 id="设计原则"><a class="markdownIt-Anchor" href="#设计原则"></a> 设计原则</h3>
<p><code>Dataflow</code> 模型的一些设计原则：</p>
<ul>
<li>永远不要依赖任何完整性的概念</li>
<li>要有足够好的灵活性，既可以适应已知的各种使用场景，又能支持未来可能的扩展</li>
<li>在预想的执行引擎中要添加有价值的东西，而不仅仅是因为合理</li>
<li>鼓励清晰的实现</li>
<li>支持在数据产生的上下文中进行强大的数据分析</li>
</ul>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43864.pdf">The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>Xiaodan Mao
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://frederick-s.github.io/2025/02/27/the-dataflow-model/" title="【读】The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in Massive-Scale, Unbounded, Out-of-Order Data Processing">https://frederick-s.github.io/2025/02/27/the-dataflow-model/</a>
  </li>
  <li class="post-copyright-license">
      <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Paper/" rel="tag"># Paper</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/02/17/rocksdb/" rel="prev" title="【读】RocksDB: Evolution of Development Priorities in a Key-value Store Serving Large-scale Applications">
                  <i class="fa fa-angle-left"></i> 【读】RocksDB: Evolution of Development Priorities in a Key-value Store Serving Large-scale Applications
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/02/pinot/" rel="next" title="【读】Pinot: Realtime OLAP for 530 Million Users">
                  【读】Pinot: Realtime OLAP for 530 Million Users <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Xiaodan Mao</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Frederick-S" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
